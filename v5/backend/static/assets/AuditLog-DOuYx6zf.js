import{j as e}from"./vendor-ui-CHMJddlm.js";import{r as d}from"./vendor-react-B7WRoy5K.js";import{u as V,a as m,f as W,Q as X,W as Q,ab as q,S as k,l as G,O as H,X as E,J as K,ah as Y,am as Z,an as ee}from"./index-BLvAk8YV.js";import"./vendor-charts-C5vizwv2.js";const le=()=>{const{t}=V(),[N,I]=d.useState([]),[D,v]=d.useState(!0),[n,F]=d.useState(null),[h,O]=d.useState({actions:[],tables:[],users:[]}),[w,U]=d.useState(!1),[P,u]=d.useState(!1),[s,y]=d.useState(null),[o,x]=d.useState(1),[g,R]=d.useState(1),[$,T]=d.useState(0),A=25,[r,_]=d.useState({user_id:"",action:"",table_name:"",date_from:"",date_to:"",search:""}),L=d.useCallback(async()=>{v(!0);try{const a=new URLSearchParams;a.append("page",o.toString()),a.append("per_page",A.toString()),r.user_id&&a.append("user_id",r.user_id),r.action&&a.append("action",r.action),r.table_name&&a.append("table_name",r.table_name),r.date_from&&a.append("date_from",r.date_from),r.date_to&&a.append("date_to",r.date_to),r.search&&a.append("search",r.search);const l=await m.get(`/settings/audit-log?${a}`);I(l.entries||[]),T(l.total||0),R(l.pages||1)}catch(a){console.error("Error loading audit log:",a)}finally{v(!1)}},[o,r]),z=async()=>{try{const[a,l]=await Promise.all([m.get("/settings/audit-log/actions"),m.get("/settings/audit-log/users")]);O({actions:a.actions||[],tables:a.tables||[],users:l.users||[]})}catch(a){console.error("Error loading filter options:",a)}},J=async()=>{try{const a=await m.get("/settings/audit-log/stats");F(a)}catch(a){console.error("Error loading stats:",a)}};d.useEffect(()=>{L(),z()},[L]);const B=async()=>{try{const a=new URLSearchParams;r.user_id&&a.append("user_id",r.user_id),r.action&&a.append("action",r.action),r.table_name&&a.append("table_name",r.table_name),r.date_from&&a.append("date_from",r.date_from),r.date_to&&a.append("date_to",r.date_to);const l=await fetch(`/api/settings/audit-log/export?${a}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!l.ok)throw new Error("Export failed");const f=await l.blob(),C=window.URL.createObjectURL(f),c=document.createElement("a");c.href=C,c.download=`audit_log_${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(c),c.click(),window.URL.revokeObjectURL(C),document.body.removeChild(c)}catch(a){console.error("Error exporting audit log:",a)}},M=()=>{_({user_id:"",action:"",table_name:"",date_from:"",date_to:"",search:""}),x(1)},i=(a,l)=>{_(f=>({...f,[a]:l})),x(1)},S=a=>{try{const l=new Date(a);return l.toLocaleDateString()+" "+l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return a}},b=a=>{switch(a.toLowerCase()){case"create":case"insert":return"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400";case"update":return"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400";case"delete":return"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400";default:return"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}},p=a=>{switch(a.toLowerCase()){case"create":case"insert":return t("auditLog.actionCreate");case"update":return t("auditLog.actionUpdate");case"delete":return t("auditLog.actionDelete");default:return a}},j=Object.values(r).some(a=>a!=="");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:t("auditLog.description")}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-500 mt-1",children:[$," ",t("auditLog.totalEntries")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>{J(),u(!0)},className:"inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300",children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),t("auditLog.statistics")]}),e.jsxs("button",{onClick:()=>U(!w),className:`inline-flex items-center px-3 py-2 border rounded-lg ${j?"border-blue-500 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400":"border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),t("common.filters"),j&&e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-xs bg-blue-600 text-white rounded-full",children:"!"})]}),e.jsxs("button",{onClick:B,className:"inline-flex items-center px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),t("common.export")]})]})]}),w&&e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4",children:[e.jsxs("div",{className:"col-span-1 sm:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:t("common.search")}),e.jsxs("div",{className:"relative",children:[e.jsx(q,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"text",value:r.search,onChange:a=>i("search",a.target.value),placeholder:t("auditLog.searchPlaceholder"),className:"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:t("common.user")}),e.jsxs("select",{value:r.user_id,onChange:a=>i("user_id",a.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800",children:[e.jsx("option",{value:"",children:t("common.all")}),h.users.map(a=>e.jsx("option",{value:a.id,children:a.nome},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:t("auditLog.action")}),e.jsxs("select",{value:r.action,onChange:a=>i("action",a.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800",children:[e.jsx("option",{value:"",children:t("common.all")}),h.actions.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:t("auditLog.table")}),e.jsxs("select",{value:r.table_name,onChange:a=>i("table_name",a.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800",children:[e.jsx("option",{value:"",children:t("common.all")}),h.tables.map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:t("auditLog.dateFrom")}),e.jsx("input",{type:"date",value:r.date_from,onChange:a=>i("date_from",a.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:t("auditLog.dateTo")}),e.jsx("input",{type:"date",value:r.date_to,onChange:a=>i("date_to",a.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800"})]})]}),j&&e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsxs("button",{onClick:M,className:"inline-flex items-center px-3 py-1.5 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200",children:[e.jsx(k,{className:"h-4 w-4 mr-1"}),t("common.clearFilters")]})})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden",children:[D?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(G,{className:"h-8 w-8 animate-spin text-gray-400"})}):N.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(H,{className:"h-12 w-12 mx-auto text-gray-400 mb-4"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:t("auditLog.noEntries")})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300",children:t("auditLog.datetime")}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300",children:t("common.user")}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300",children:t("auditLog.action")}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300",children:t("auditLog.table")}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700 dark:text-gray-300",children:t("auditLog.recordId")}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700 dark:text-gray-300",children:t("common.actions")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:N.map(a=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap",children:S(a.created_at)}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:a.user_name||t("common.unknown")}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:a.user_email})]})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${b(a.action)}`,children:p(a.action)})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:a.table_name})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500 dark:text-gray-400",children:a.record_id||"-"}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>y(a),className:"p-1.5 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 rounded",title:t("common.viewDetails"),children:e.jsx(Y,{className:"h-4 w-4"})})})]},a.id))})]})}),g>1&&e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:[t("common.page")," ",o," ",t("common.of")," ",g]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>x(a=>Math.max(1,a-1)),disabled:o===1,className:"p-2 border border-gray-300 dark:border-gray-600 rounded disabled:opacity-50 hover:bg-gray-50 dark:hover:bg-gray-700",children:e.jsx(Z,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>x(a=>Math.min(g,a+1)),disabled:o===g,className:"p-2 border border-gray-300 dark:border-gray-600 rounded disabled:opacity-50 hover:bg-gray-50 dark:hover:bg-gray-700",children:e.jsx(ee,{className:"h-4 w-4"})})]})]})]}),s&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:t("auditLog.entryDetails")}),e.jsx("button",{onClick:()=>y(null),className:"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300",children:e.jsx(k,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 dark:text-gray-400",children:t("auditLog.datetime")}),e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:S(s.created_at)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 dark:text-gray-400",children:t("common.user")}),e.jsxs("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:[s.user_name," (",s.user_email,")"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 dark:text-gray-400",children:t("auditLog.action")}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${b(s.action)}`,children:p(s.action)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 dark:text-gray-400",children:t("auditLog.table")}),e.jsxs("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:[s.table_name," (ID: ",s.record_id||"-",")"]})]})]}),s.old_values&&Object.keys(s.old_values).length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 dark:text-gray-400 mb-2 block",children:t("auditLog.oldValues")}),e.jsx("pre",{className:"bg-red-50 dark:bg-red-900/20 p-3 rounded-lg text-xs overflow-x-auto text-red-800 dark:text-red-300",children:JSON.stringify(s.old_values,null,2)})]}),s.new_values&&Object.keys(s.new_values).length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 dark:text-gray-400 mb-2 block",children:t("auditLog.newValues")}),e.jsx("pre",{className:"bg-green-50 dark:bg-green-900/20 p-3 rounded-lg text-xs overflow-x-auto text-green-800 dark:text-green-300",children:JSON.stringify(s.new_values,null,2)})]})]}),e.jsx("div",{className:"flex justify-end p-4 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{onClick:()=>y(null),className:"px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600",children:t("common.close")})})]})}),P&&n&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:t("auditLog.statistics")}),e.jsx("button",{onClick:()=>u(!1),className:"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300",children:e.jsx(k,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"p-4 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg",children:[e.jsx("p",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:n.total}),e.jsx("p",{className:"text-sm text-blue-600/70 dark:text-blue-400/70",children:t("auditLog.totalEntries")})]}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 p-4 rounded-lg",children:[e.jsx("p",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:n.today}),e.jsx("p",{className:"text-sm text-green-600/70 dark:text-green-400/70",children:t("auditLog.today")})]}),e.jsxs("div",{className:"bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg",children:[e.jsx("p",{className:"text-2xl font-bold text-purple-600 dark:text-purple-400",children:n.this_week}),e.jsx("p",{className:"text-sm text-purple-600/70 dark:text-purple-400/70",children:t("auditLog.thisWeek")})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:t("auditLog.byAction")}),e.jsx("div",{className:"space-y-2",children:n.by_action.map(a=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${b(a.action)}`,children:p(a.action)}),e.jsx("span",{className:"text-sm text-gray-500",children:a.count})]},a.action))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:t("auditLog.byTable")}),e.jsx("div",{className:"space-y-2",children:n.by_table.slice(0,10).map(a=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:a.table_name}),e.jsx("span",{className:"text-sm text-gray-500",children:a.count})]},a.table_name))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:t("auditLog.topUsers")}),e.jsx("div",{className:"space-y-2",children:n.top_users.map(a=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:a.nome})]}),e.jsxs("span",{className:"text-sm text-gray-500",children:[a.count," ",t("auditLog.actions")]})]},a.id))})]})]}),e.jsx("div",{className:"flex justify-end p-4 border-t border-gray-200 dark:border-gray-700",children:e.jsx("button",{onClick:()=>u(!1),className:"px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600",children:t("common.close")})})]})})]})};export{le as default};
