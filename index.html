<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartLamppost - Gest√£o RFID de Infraestruturas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS e JS - APENAS O B√ç¬ÅSICO -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Estilos para o mapa */
        .leaflet-container { 
            font-family: inherit; 
            background: #f0f0f0;
        }
        .asset-popup { min-width: 200px; }
        .asset-popup h4 { font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .asset-popup p { margin: 4px 0; font-size: 12px; color: #555; }
        .asset-popup .status-badge { 
            display: inline-block; padding: 2px 8px; border-radius: 12px; 
            font-size: 11px; font-weight: 500; margin-top: 4px;
        }
        .leaflet-routing-container { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext, useRef } = React;
        
        // CONFIGURATION
        const API_BASE = '/api';
        
        // AUTH CONTEXT
        const AuthContext = createContext(null);
        const useAuth = () => useContext(AuthContext);
        
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                if (token) {
                    fetch(`${API_BASE}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` }})
                    .then(res => res.ok ? res.json() : Promise.reject())
                    .then(data => setUser(data))
                    .catch(() => { localStorage.removeItem('token'); setToken(null); })
                    .finally(() => setLoading(false));
                } else { setLoading(false); }
            }, [token]);
            
            const [mustChangePassword, setMustChangePassword] = useState(false);
            
            const login = async (email, password) => {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    setToken(data.token);
                    setUser(data.user);
                    // Verificar se precisa alterar password
                    if (data.user?.must_change_password) {
                        setMustChangePassword(true);
                    }
                    return { success: true };
                }
                return { success: false, error: data.error };
            };
            
            const clearMustChangePassword = () => {
                setMustChangePassword(false);
            };
            
            const logout = () => {
                fetch(`${API_BASE}/auth/logout`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }});
                localStorage.removeItem('token');
                setToken(null);
                setUser(null);
                setMustChangePassword(false);
            };
            
            return <AuthContext.Provider value={{ user, token, login, logout, loading, mustChangePassword, clearMustChangePassword }}>{children}</AuthContext.Provider>;
        };
        
        // API HELPER
        const api = {
            get: async (ep, token) => { 
                const r = await fetch(`${API_BASE}${ep}`, { headers: { 'Authorization': `Bearer ${token}` }}); 
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json(); 
            },
            post: async (ep, data, token) => { const r = await fetch(`${API_BASE}${ep}`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) }); return { ok: r.ok, data: await r.json() }; },
            put: async (ep, data, token) => { const r = await fetch(`${API_BASE}${ep}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) }); return { ok: r.ok, data: await r.json() }; },
            delete: async (ep, token) => { const r = await fetch(`${API_BASE}${ep}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }}); return { ok: r.ok, data: await r.json() }; },
            download: async (ep, token, filename) => {
                const r = await fetch(`${API_BASE}${ep}`, { headers: { 'Authorization': `Bearer ${token}` }});
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const blob = await r.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            },
            postDownload: async (ep, data, token) => {
                const r = await fetch(`${API_BASE}${ep}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                    body: JSON.stringify(data) 
                });
                if (!r.ok) {
                    const err = await r.json();
                    throw new Error(err.error || 'Erro no download');
                }
                const blob = await r.blob();
                const disposition = r.headers.get('Content-Disposition');
                let filename = 'export.xlsx';
                if (disposition) {
                    const match = disposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (match) filename = match[1].replace(/['"]/g, '');
                }
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            },
            uploadFile: async (ep, file, extraData, token) => {
                const formData = new FormData();
                formData.append('file', file);
                if (extraData) {
                    Object.keys(extraData).forEach(key => {
                        formData.append(key, typeof extraData[key] === 'object' ? JSON.stringify(extraData[key]) : extraData[key]);
                    });
                }
                const r = await fetch(`${API_BASE}${ep}`, { 
                    method: 'POST', 
                    headers: { 'Authorization': `Bearer ${token}` }, 
                    body: formData 
                });
                return { ok: r.ok, data: await r.json() };
            }
        };
        
        // LOGIN
        const Login = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const { login } = useAuth();
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                const result = await login(email, password);
                if (!result.success) setError(result.error);
                setLoading(false);
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-blue-700">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md fade-in">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                                </svg>
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">SmartLamppost</h1>
                            <p className="text-gray-500 mt-1">Gest√£o RFID de Infraestruturas</p>
                        </div>
                        {error && <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-medium mb-2">Email</label>
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="email@empresa.pt" required />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-medium mb-2">Password</label>
                                <div className="relative">
                                    <input type={showPassword ? "text" : "password"} value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-12" required />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        {showPassword ? (
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                                        ) : (
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                        )}
                                    </button>
                                </div>
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50">
                                {loading ? 'A autenticar...' : 'Entrar'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };
        
        // Componente de altera√ß√£o for√ßada de password
        const ChangePasswordRequired = () => {
            const { token, user, clearMustChangePassword, logout } = useAuth();
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [showCurrent, setShowCurrent] = useState(false);
            const [showNew, setShowNew] = useState(false);
            const [showConfirm, setShowConfirm] = useState(false);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                
                if (newPassword.length < 8) {
                    setError('A nova password deve ter pelo menos 8 caracteres');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    setError('As passwords n√£o coincidem');
                    return;
                }
                
                if (currentPassword === newPassword) {
                    setError('A nova password deve ser diferente da atual');
                    return;
                }
                
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/auth/change-password`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ 
                            current_password: currentPassword, 
                            new_password: newPassword 
                        })
                    });
                    const data = await res.json();
                    
                    if (res.ok) {
                        clearMustChangePassword();
                    } else {
                        setError(data.error || 'Erro ao alterar password');
                    }
                } catch (e) {
                    setError('Erro de conex√£o');
                }
                setLoading(false);
            };
            
            const PasswordInput = ({ value, onChange, show, setShow, placeholder, label }) => (
                <div className="mb-4">
                    <label className="block text-gray-700 text-sm font-medium mb-2">{label}</label>
                    <div className="relative">
                        <input 
                            type={show ? "text" : "password"} 
                            value={value} 
                            onChange={(e) => onChange(e.target.value)} 
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-12" 
                            placeholder={placeholder}
                            required 
                        />
                        <button type="button" onClick={() => setShow(!show)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            {show ? (
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                            ) : (
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            )}
                        </button>
                    </div>
                </div>
            );
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-orange-600 to-orange-800">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md fade-in">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-orange-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">Altera√ß√£o de Password Obrigat√≥ria</h1>
                            <p className="text-gray-500 mt-2">Por raz√µes de seguran√ßa, deve alterar a sua password no primeiro acesso.</p>
                            <p className="text-sm text-gray-400 mt-1">Utilizador: {user?.email}</p>
                        </div>
                        
                        {error && <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">{error}</div>}
                        
                        <form onSubmit={handleSubmit}>
                            <PasswordInput 
                                value={currentPassword} 
                                onChange={setCurrentPassword} 
                                show={showCurrent} 
                                setShow={setShowCurrent}
                                label="Password Atual"
                                placeholder="Digite a password atual"
                            />
                            <PasswordInput 
                                value={newPassword} 
                                onChange={setNewPassword} 
                                show={showNew} 
                                setShow={setShowNew}
                                label="Nova Password"
                                placeholder="M√≠nimo 8 caracteres"
                            />
                            <PasswordInput 
                                value={confirmPassword} 
                                onChange={setConfirmPassword} 
                                show={showConfirm} 
                                setShow={setShowConfirm}
                                label="Confirmar Nova Password"
                                placeholder="Repita a nova password"
                            />
                            
                            <div className="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg mb-4 text-sm">
                                <strong>Requisitos:</strong>
                                <ul className="list-disc list-inside mt-1">
                                    <li>M√≠nimo 8 caracteres</li>
                                    <li>Diferente da password atual</li>
                                </ul>
                            </div>
                            
                            <button type="submit" disabled={loading} className="w-full bg-orange-600 text-white py-3 rounded-lg font-medium hover:bg-orange-700 disabled:opacity-50 mb-3">
                                {loading ? 'A alterar...' : 'Alterar Password'}
                            </button>
                            
                            <button type="button" onClick={logout} className="w-full text-gray-500 py-2 hover:text-gray-700">
                                Cancelar e Sair
                            </button>
                        </form>
                    </div>
                </div>
            );
        };
        
        // Logo em Base64
        const LOGO_SRC = 'data:image/png;base64,' + 'iVBORw0KGgoAAAANSUhEUgAAASwAAABLCAYAAADW7VbGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF8WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNy4xLWMwMDAgNzkuZWRhMmIzZmFjLCAyMDIxLzExLzE3LTE3OjIzOjE5ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjMuMSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDI0LTAxLTE1VDEwOjAwOjAwKzAwOjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAyNC0wMS0xNVQxMDowMDowMCswMDowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyNC0wMS0xNVQxMDowMDowMCswMDowMCIgZGM6Zm9ybWF0PSJpbWFnZS9wbmciIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTIzNDU2NzgtOTBhYi1jZGVmLTEyMzQtNTY3ODkwYWJjZGVmIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjEyMzQ1Njc4LTkwYWItY2RlZi0xMjM0LTU2Nzg5MGFiY2RlZiIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjEyMzQ1Njc4LTkwYWItY2RlZi0xMjM0LTU2Nzg5MGFiY2RlZiI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MTIzNDU2NzgtOTBhYi1jZGVmLTEyMzQtNTY3ODkwYWJjZGVmIiBzdEV2dDp3aGVuPSIyMDI0LTAxLTE1VDEwOjAwOjAwKzAwOjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjMuMSAoV2luZG93cykiLz4gPC9yZGY6U2VxPiA8L3htcE1NOkhpc3Rvcnk+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+';
        
        // NAVIGATION
        const Navigation = ({ currentView, setCurrentView }) => {
            const { user, logout } = useAuth();
            const [showDefinicoes, setShowDefinicoes] = useState(false);
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            
            // Items normais (sem admin)
            const navItems = [
                { id: 'dashboard', label: 'Dashboard' },
                { id: 'dashboard-resumo', label: 'Resumo' },
                { id: 'map', label: 'Mapa' },
                { id: 'assets', label: 'Ativos' },
                { id: 'interventions', label: 'Interven√ß√µes' },
            ];
            
            // Items de admin que v√£o no dropdown Defini√ß√µes
            const baseAdminItems = [
                { id: 'catalog', label: 'Cat√°logo' },
                { id: 'schema', label: 'Campos' },
                { id: 'users', label: 'Utilizadores' },
                { id: 'settings', label: 'Configura√ß√µes' },
            ];
            
            // Adicionar Tenants apenas para superadmin
            const adminItems = user?.role === 'superadmin' 
                ? [{ id: 'tenants', label: 'üè¢ Tenants' }, ...baseAdminItems]
                : baseAdminItems;
            
            const isAdminView = adminItems.some(item => item.id === currentView);
            
            return (
                <nav className="bg-white shadow-lg">
                    <div className="max-w-7xl mx-auto px-4">
                        <div className="flex justify-between h-16">
                            <div className="flex items-center">
                                {/* Mobile menu button */}
                                <button 
                                    onClick={() => setShowMobileMenu(!showMobileMenu)}
                                    className="md:hidden p-2 rounded-lg text-gray-600 hover:bg-gray-100 mr-2"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        {showMobileMenu ? (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        ) : (
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                                        )}
                                    </svg>
                                </button>
                                
                                <button 
                                    onClick={() => setCurrentView('dashboard')}
                                    className="flex items-center hover:opacity-80 transition-opacity"
                                    title="Ir para Dashboard"
                                >
                                    <img
                                        src={`${API_BASE}/tenants/${user?.tenant_id || 'smartlamppost'}/logo?t=${Date.now()}`}
                                        alt="Logo"
                                        className="h-10 mr-3"
                                        onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'flex'; }}
                                    />
                                    <div className="hidden items-center">
                                        <div className="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center mr-2">
                                            <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                                            </svg>
                                        </div>
                                        <span className="font-bold text-xl text-blue-500">SmartLamppost</span>
                                    </div>
                                </button>
                                <div className="hidden md:flex ml-10 space-x-1 items-center">
                                    {navItems.map(item => (
                                        <button 
                                            key={item.id} 
                                            onClick={() => setCurrentView(item.id)} 
                                            className={`px-4 py-2 rounded-lg text-sm font-medium ${currentView === item.id ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}
                                        >
                                            {item.label}
                                        </button>
                                    ))}
                                    
                                    {/* Dropdown Defini√ß√µes - para admin e superadmin */}
                                    {((user?.role === 'admin' || user?.role === 'superadmin') || user?.role === 'superadmin') && (
                                        <div className="relative">
                                            <button 
                                                onClick={() => setShowDefinicoes(!showDefinicoes)}
                                                onBlur={() => setTimeout(() => setShowDefinicoes(false), 200)}
                                                className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center ${isAdminView ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}
                                            >
                                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                </svg>
                                                Defini√ß√µes
                                                <svg className={`w-4 h-4 ml-1 transition-transform ${showDefinicoes ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                </svg>
                                            </button>
                                            
                                            {showDefinicoes && (
                                                <div className="absolute top-full left-0 mt-1 w-48 bg-white rounded-lg shadow-lg border z-50">
                                                    {adminItems.map(item => (
                                                        <button 
                                                            key={item.id}
                                                            onClick={() => { setCurrentView(item.id); setShowDefinicoes(false); }}
                                                            className={`w-full px-4 py-2 text-left text-sm hover:bg-gray-50 first:rounded-t-lg last:rounded-b-lg ${currentView === item.id ? 'bg-blue-50 text-blue-700' : 'text-gray-700'}`}
                                                        >
                                                            {item.label}
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="hidden md:flex items-center space-x-4">
                                {user?.tenant_id && user.tenant_id !== 'smartlamppost' && (
                                    <div className="flex items-center space-x-1 text-xs text-gray-400 border-r pr-4 mr-2">
                                        <span>powered by</span>
                                        <img
                                            src={`${API_BASE}/tenants/smartlamppost/logo`}
                                            alt="SmartLamppost"
                                            className="h-5 object-contain"
                                            onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'inline'; }}
                                        />
                                        <span style={{display:'none'}} className="font-semibold text-gray-500">SmartLamppost</span>
                                    </div>
                                )}
                                <span className="text-sm text-gray-600">{user?.email || user?.username} <span className="text-xs text-gray-400">({user?.role === 'superadmin' ? 'Super Admin' : (user?.role === 'admin' || user?.role === 'superadmin') ? 'Administrador' : user?.role === 'operator' ? 'Operador' : user?.role === 'user' ? 'Utilizador' : 'Visita'})</span></span>
                                <button onClick={logout} className="px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg">Sair</button>
                            </div>
                            {/* Mobile user info */}
                            <div className="md:hidden flex items-center">
                                <button onClick={logout} className="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {/* Mobile Menu Panel */}
                    {showMobileMenu && (
                        <div className="md:hidden bg-white border-t">
                            <div className="px-4 py-3 space-y-1">
                                {navItems.map(item => (
                                    <button 
                                        key={item.id} 
                                        onClick={() => { setCurrentView(item.id); setShowMobileMenu(false); }} 
                                        className={`w-full text-left px-4 py-3 rounded-lg text-sm font-medium ${currentView === item.id ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}
                                    >
                                        {item.label}
                                    </button>
                                ))}
                                
                                {/* Admin items for mobile */}
                                {(user?.role === 'admin' || user?.role === 'superadmin') && (
                                    <>
                                        <div className="border-t my-2 pt-2">
                                            <p className="px-4 py-1 text-xs text-gray-400 uppercase">Defini√ß√µes</p>
                                        </div>
                                        {adminItems.map(item => (
                                            <button 
                                                key={item.id}
                                                onClick={() => { setCurrentView(item.id); setShowMobileMenu(false); }}
                                                className={`w-full text-left px-4 py-3 rounded-lg text-sm font-medium ${currentView === item.id ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}
                                            >
                                                {item.label}
                                            </button>
                                        ))}
                                    </>
                                )}
                                
                                {/* User info mobile */}
                                <div className="border-t my-2 pt-3">
                                    <p className="px-4 text-xs text-gray-500">{user?.email}</p>
                                    <p className="px-4 text-xs text-gray-400">{user?.role === 'superadmin' ? 'Super Admin' : user?.role === 'admin' ? 'Administrador' : 'Operador'}</p>
                                </div>
                            </div>
                        </div>
                    )}
                </nav>
            );
        };
        
        // DASHBOARD RESUMO
        const DashboardResumo = ({ setCurrentView, setAssetFilter }) => {
            const { token } = useAuth();
            const [stats, setStats] = useState(null);
            const [selectedMunicipality, setSelectedMunicipality] = useState('');
            const [showModal, setShowModal] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            const loadStats = async (municipality = '') => {
                try {
                    setLoading(true);
                    setError(null);
                    const endpoint = municipality ? `/stats/summary?municipality=${encodeURIComponent(municipality)}` : '/stats/summary';
                    const data = await api.get(endpoint, token);
                    setStats(data);
                } catch (err) {
                    console.error('Error loading stats:', err);
                    setError('Erro ao carregar dados');
                } finally {
                    setLoading(false);
                }
            };
            
            useEffect(() => { loadStats(selectedMunicipality); }, [selectedMunicipality, token]);
            
            const handleMunicipalityChange = (e) => {
                setSelectedMunicipality(e.target.value);
            };
            
            const handleCardClick = (type, filter = null) => {
                setShowModal({ type, filter });
            };
            
            const navigateToAssets = (search = '') => {
                if (setAssetFilter) setAssetFilter(search);
                setCurrentView('assets');
            };
            
            if (loading) return <div className="p-8 text-center"><div className="text-gray-500">A carregar...</div></div>;
            if (error) return <div className="p-8 text-center"><div className="text-red-500">{error}</div><button onClick={() => loadStats(selectedMunicipality)} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded">Tentar novamente</button></div>;
            
            return (
                <div className="p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Dashboard Resumo</h2>
                        {selectedMunicipality && (
                            <span className="text-sm text-blue-600 bg-blue-50 px-3 py-1 rounded-full">
                                Filtrado: {selectedMunicipality}
                            </span>
                        )}
                    </div>
                    
                    {/* 4 Cards Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        
                        {/* Card 1: Munic√≠pio (Dropdown) */}
                        <div className="bg-white rounded-xl shadow-md p-6 border-2 border-blue-100">
                            <div className="flex items-center mb-4">
                                <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <p className="text-sm text-gray-500">Munic√≠pio</p>
                                    <p className="text-xs text-gray-400">Filtrar dashboard</p>
                                </div>
                            </div>
                            <select 
                                value={selectedMunicipality} 
                                onChange={handleMunicipalityChange}
                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-lg font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition"
                            >
                                <option value="">Todos os Munic√≠pios</option>
                                {stats?.municipalities?.map((m, i) => (
                                    <option key={i} value={m}>{m}</option>
                                ))}
                            </select>
                        </div>
                        
                        {/* Card 2: Ativos */}
                        <div 
                            onClick={() => handleCardClick('assets')}
                            className="bg-white rounded-xl shadow-md p-6 border-2 border-green-100 cursor-pointer hover:shadow-lg hover:border-green-300 transition"
                        >
                            <div className="flex items-center mb-4">
                                <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                    <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                                    </svg>
                                </div>
                                <div>
                                    <p className="text-sm text-gray-500">Ativos</p>
                                    <p className="text-xs text-gray-400">Total registado</p>
                                </div>
                            </div>
                            <p className="text-4xl font-bold text-green-600">{stats?.total_assets || 0}</p>
                            <p className="text-xs text-gray-400 mt-2">Clique para ver lista ‚Üí</p>
                        </div>
                        
                        {/* Card 3: Estado dos Ativos */}
                        <div 
                            onClick={() => handleCardClick('conditions')}
                            className="bg-white rounded-xl shadow-md p-6 border-2 border-yellow-100 cursor-pointer hover:shadow-lg hover:border-yellow-300 transition"
                        >
                            <div className="flex items-center mb-4">
                                <div className="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center mr-3">
                                    <svg className="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <p className="text-sm text-gray-500">Estado dos Ativos</p>
                                    <p className="text-xs text-gray-400">Por condi√ß√£o</p>
                                </div>
                            </div>
                            <div className="space-y-2">
                                {stats?.by_condition?.length > 0 ? stats.by_condition.map((c, i) => (
                                    <div key={i} className="flex justify-between items-center">
                                        <span className={`text-sm px-2 py-1 rounded ${
                                            c.field_value === 'Operacional' ? 'bg-green-100 text-green-700' :
                                            c.field_value === 'Manuten√ß√£o Necess√°ria' ? 'bg-yellow-100 text-yellow-700' :
                                            c.field_value === 'Em Repara√ß√£o' ? 'bg-orange-100 text-orange-700' :
                                            c.field_value === 'Desativado' ? 'bg-red-100 text-red-700' :
                                            'bg-gray-100 text-gray-700'
                                        }`}>{c.field_value || 'N/D'}</span>
                                        <span className="font-bold text-gray-800">{c.count}</span>
                                    </div>
                                )) : (
                                    <p className="text-gray-400 text-sm">Sem dados</p>
                                )}
                            </div>
                            <p className="text-xs text-gray-400 mt-3">Clique para detalhes ‚Üí</p>
                        </div>
                        
                        {/* Card 4: Garantia V√°lida */}
                        <div 
                            onClick={() => handleCardClick('warranty')}
                            className="bg-white rounded-xl shadow-md p-6 border-2 border-purple-100 cursor-pointer hover:shadow-lg hover:border-purple-300 transition"
                        >
                            <div className="flex items-center mb-4">
                                <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                    <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                    </svg>
                                </div>
                                <div>
                                    <p className="text-sm text-gray-500">Garantia V√°lida</p>
                                    <p className="text-xs text-gray-400">Cobertura ativa</p>
                                </div>
                            </div>
                            <div className="flex items-end justify-between">
                                <div>
                                    <p className="text-4xl font-bold text-purple-600">{stats?.warranty_valid || 0}</p>
                                    <p className="text-xs text-gray-500">com garantia</p>
                                </div>
                                {stats?.warranty_expiring_30d > 0 && (
                                    <div className="text-right">
                                        <p className="text-xl font-bold text-orange-500">{stats.warranty_expiring_30d}</p>
                                        <p className="text-xs text-orange-500">a expirar 30d</p>
                                    </div>
                                )}
                            </div>
                            <p className="text-xs text-gray-400 mt-3">Clique para detalhes ‚Üí</p>
                        </div>
                    </div>
                    
                    {/* Modal for details */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden fade-in">
                                <div className="p-6 border-b flex justify-between items-center bg-gray-50">
                                    <h3 className="text-xl font-bold text-gray-800">
                                        {showModal.type === 'assets' && 'Lista de Ativos'}
                                        {showModal.type === 'conditions' && 'Estado dos Ativos'}
                                        {showModal.type === 'warranty' && 'Garantias'}
                                    </h3>
                                    <button onClick={() => setShowModal(null)} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                                </div>
                                <div className="p-6 overflow-y-auto max-h-[60vh]">
                                    {showModal.type === 'assets' && (
                                        <div>
                                            <p className="text-gray-600 mb-4">Total de <strong>{stats?.total_assets}</strong> ativos {selectedMunicipality ? `em ${selectedMunicipality}` : 'registados'}.</p>
                                            <button 
                                                onClick={() => { setShowModal(null); navigateToAssets(selectedMunicipality); }}
                                                className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition"
                                            >
                                                Ver Todos os Ativos ‚Üí
                                            </button>
                                        </div>
                                    )}
                                    
                                    {showModal.type === 'conditions' && (
                                        <div className="space-y-4">
                                            {stats?.assets_by_condition?.map((cond, i) => (
                                                <div key={i} className="border rounded-lg p-4">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                                            cond.condition === 'Operacional' ? 'bg-green-100 text-green-700' :
                                                            cond.condition === 'Manuten√ß√£o Necess√°ria' ? 'bg-yellow-100 text-yellow-700' :
                                                            cond.condition === 'Em Repara√ß√£o' ? 'bg-orange-100 text-orange-700' :
                                                            cond.condition === 'Desativado' ? 'bg-red-100 text-red-700' :
                                                            'bg-gray-100 text-gray-700'
                                                        }`}>{cond.condition || 'N√£o definido'}</span>
                                                        <span className="text-2xl font-bold text-gray-800">{cond.count}</span>
                                                    </div>
                                                    {cond.sample_assets?.length > 0 && (
                                                        <div className="text-sm text-gray-500">
                                                            <p className="mb-1">Exemplos:</p>
                                                            {cond.sample_assets.slice(0, 5).map((a, j) => (
                                                                <span key={j} className="inline-block bg-gray-100 px-2 py-1 rounded mr-2 mb-1 font-mono text-xs">{a.serial_number}</span>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {showModal.type === 'warranty' && (
                                        <div>
                                            <div className="grid grid-cols-2 gap-4 mb-6">
                                                <div className="bg-green-50 rounded-lg p-4 text-center">
                                                    <p className="text-3xl font-bold text-green-600">{stats?.warranty_valid || 0}</p>
                                                    <p className="text-sm text-green-700">Garantia V√°lida</p>
                                                </div>
                                                <div className="bg-orange-50 rounded-lg p-4 text-center">
                                                    <p className="text-3xl font-bold text-orange-600">{stats?.warranty_expiring_30d || 0}</p>
                                                    <p className="text-sm text-orange-700">A Expirar (30 dias)</p>
                                                </div>
                                            </div>
                                            
                                            {stats?.warranty_expiring_assets?.length > 0 && (
                                                <div>
                                                    <h4 className="font-semibold text-gray-700 mb-3">Garantias a Expirar:</h4>
                                                    <div className="space-y-2">
                                                        {stats.warranty_expiring_assets.map((a, i) => (
                                                            <div key={i} className="flex justify-between items-center bg-orange-50 rounded-lg px-4 py-2">
                                                                <span className="font-mono text-sm">{a.serial_number}</span>
                                                                <span className="text-orange-600 text-sm font-medium">{a.warranty_end}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 border-t bg-gray-50">
                                    <button 
                                        onClick={() => setShowModal(null)}
                                        className="w-full py-2 text-gray-600 hover:bg-gray-200 rounded-lg transition"
                                    >
                                        Fechar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // CONFIGURADOR DE REFER√ç≈†NCIA SmartLamppost
        // CONFIGURADOR DE REFER√ç≈†NCIA SmartLamppost - REESTRUTURADO
        const ReferenceConfigurator = ({ value, onChange, token }) => {
            const [expanded, setExpanded] = useState(false);
            const [catalogStats, setCatalogStats] = useState(null);
            const [packs, setPacks] = useState([]);
            const [columns, setColumns] = useState([]);
            const [luminaires, setLuminaires] = useState([]);
            const [electricalPanels, setElectricalPanels] = useState([]);
            const [fuseBoxes, setFuseBoxes] = useState([]);
            const [telemetryPanels, setTelemetryPanels] = useState([]);
            const [modulesEV, setModulesEV] = useState([]);
            const [modulesMUPI, setModulesMUPI] = useState([]);
            const [modulesLateral, setModulesLateral] = useState([]);
            const [modulesAntenna, setModulesAntenna] = useState([]);
            
            // Sele√ß√µes do utilizador
            const [selectedPack, setSelectedPack] = useState('');
            const [selectedColumn, setSelectedColumn] = useState(null);
            const [selectedLuminaire, setSelectedLuminaire] = useState(null);
            const [selectedElectrical, setSelectedElectrical] = useState(null);
            const [selectedFuseBox, setSelectedFuseBox] = useState(null);
            const [selectedTelemetry, setSelectedTelemetry] = useState(null);
            const [selectedEV, setSelectedEV] = useState(null);
            const [selectedMUPI, setSelectedMUPI] = useState(null);
            const [selectedLateral, setSelectedLateral] = useState(null);
            const [selectedAntenna, setSelectedAntenna] = useState(null);
            
            // Emojis para cada m√≥dulo
            const moduleEmojis = {
                luminaire: 'üí°', electrical: '‚ö°', fuseBox: 'üîí', telemetry: 'üì°',
                ev: 'üîõ', mupi: 'üì∫', lateral: 'üóëÔ∏è¬è', antenna: 'üì∂'
            };
            
            // Carregar dados iniciais
            useEffect(() => {
                api.get('/catalog/stats', token).then(setCatalogStats);
                api.get('/catalog/packs', token).then(setPacks);
                api.get('/catalog/electrical-panels', token).then(setElectricalPanels);
                api.get('/catalog/fuse-boxes', token).then(setFuseBoxes);
                api.get('/catalog/telemetry-panels', token).then(setTelemetryPanels);
                api.get('/catalog/modules/ev', token).then(setModulesEV);
                api.get('/catalog/modules/mupi', token).then(setModulesMUPI);
                api.get('/catalog/modules/lateral', token).then(setModulesLateral);
                api.get('/catalog/modules/antenna', token).then(setModulesAntenna);
            }, [token]);
            
            // Carregar colunas quando pack muda
            useEffect(() => {
                if (selectedPack) {
                    api.get(`/catalog/columns?pack=${encodeURIComponent(selectedPack)}`, token).then(setColumns);
                } else {
                    setColumns([]);
                }
                setSelectedColumn(null);
                resetModuleSelections();
            }, [selectedPack, token]);
            
            // Carregar lumin√°rias filtradas quando coluna muda
            useEffect(() => {
                if (selectedColumn && selectedColumn.mod1_luminaire !== 'N√£o') {
                    const lumType = selectedColumn.mod1_luminaire;
                    const height = selectedColumn.height_m;
                    api.get(`/catalog/luminaires?height=${height}&type=${encodeURIComponent(lumType)}`, token)
                        .then(setLuminaires);
                } else {
                    setLuminaires([]);
                }
                resetModuleSelections();
            }, [selectedColumn, token]);
            
            const resetModuleSelections = () => {
                setSelectedLuminaire(null);
                setSelectedElectrical(null);
                setSelectedFuseBox(null);
                setSelectedTelemetry(null);
                setSelectedEV(null);
                setSelectedMUPI(null);
                setSelectedLateral(null);
                setSelectedAntenna(null);
            };
            
            // Gerar refer√™ncia final e dados extras
            useEffect(() => {
                if (!selectedColumn) {
                    onChange('', null);
                    return;
                }
                
                let parts = [selectedColumn.reference];
                let equipmentList = [];
                let luminaireType = '';
                
                if (selectedLuminaire) {
                    const lumRef = selectedLuminaire.reference.replace(/^SLP[S]?-/, '');
                    parts.push(lumRef);
                    const lumCount = selectedColumn.arm_count || 1;
                    luminaireType = `${selectedLuminaire.reference} (${lumCount}x)`;
                    equipmentList.push(`${moduleEmojis.luminaire} Lumin√°ria: ${selectedLuminaire.description} x${lumCount}`);
                }
                
                if (selectedElectrical) {
                    parts.push(selectedElectrical.short_reference);
                    equipmentList.push(`${moduleEmojis.electrical} Q. El√©trico: ${selectedElectrical.panel_type} - ${selectedElectrical.short_reference}`);
                }
                
                if (selectedFuseBox) {
                    parts.push(selectedFuseBox.short_reference);
                    equipmentList.push(`${moduleEmojis.fuseBox} Cofrete: ${selectedFuseBox.fuse_type} - ${selectedFuseBox.short_reference}`);
                }
                
                if (selectedTelemetry) {
                    parts.push(selectedTelemetry.short_reference);
                    equipmentList.push(`${moduleEmojis.telemetry} Telemetria: ${selectedTelemetry.panel_type} - ${selectedTelemetry.short_reference}`);
                }
                
                if (selectedEV) {
                    parts.push(selectedEV.short_reference);
                    equipmentList.push(`${moduleEmojis.ev} Carregador EV: ${selectedEV.description}`);
                }
                
                if (selectedMUPI) {
                    parts.push(selectedMUPI.short_reference);
                    equipmentList.push(`${moduleEmojis.mupi} MUPI: ${selectedMUPI.description}`);
                }
                
                if (selectedLateral) {
                    parts.push(selectedLateral.short_reference);
                    equipmentList.push(`${moduleEmojis.lateral} Lateral: ${selectedLateral.description}`);
                }
                
                if (selectedAntenna) {
                    parts.push(selectedAntenna.short_reference);
                    equipmentList.push(`${moduleEmojis.antenna} Antena: ${selectedAntenna.description}`);
                }
                
                const finalReference = parts.join('.');
                const extraData = {
                    associated_equipment: equipmentList.join('\n'),
                    luminaire_type: luminaireType,
                    height_meters: selectedColumn.height_m
                };
                
                onChange(finalReference, extraData);
            }, [selectedColumn, selectedLuminaire, selectedElectrical, selectedFuseBox, 
                selectedTelemetry, selectedEV, selectedMUPI, selectedLateral, selectedAntenna]);
            
            const filteredAntennas = selectedColumn?.height_m 
                ? modulesAntenna.filter(a => a.column_height_m === selectedColumn.height_m)
                : [];
            
            const getFilteredFuseBoxes = () => {
                if (!selectedColumn || selectedColumn.mod3_fuse_box === 'N√£o') return [];
                if (selectedColumn.mod3_fuse_box === 'Tipo S') return fuseBoxes.filter(f => f.type_s === 1);
                if (selectedColumn.mod3_fuse_box === 'Tipo D') return fuseBoxes.filter(f => f.type_d === 1);
                return [];
            };
            
            const hasCatalog = catalogStats && catalogStats.columns > 0;
            
            if (!hasCatalog) {
                return (
                    <div className="space-y-2">
                        <input type="text" value={value || ''} onChange={(e) => onChange(e.target.value, null)}
                            className="w-full px-3 py-2 border rounded-lg" placeholder="Refer√™ncia manual..."/>
                        <div className="text-xs text-amber-600 bg-amber-50 p-2 rounded">
                            ‚ö†Ô∏è¬è Cat√°logo n√£o importado. V√° a Defini√ß√µes ‚Üí Cat√°logo para importar.
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="space-y-3">
                    <div className="flex items-center gap-2">
                        <input type="text" value={value || ''} readOnly
                            className="flex-1 px-3 py-2 border rounded-lg bg-gray-50 font-mono text-sm"
                            placeholder="Selecione os componentes abaixo..."/>
                        <button type="button" onClick={() => setExpanded(!expanded)}
                            className={`px-3 py-2 rounded-lg text-sm transition ${expanded ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
                            {expanded ? '‚úî Configurador' : '‚ö°√Ø¬∏¬è Configurar'}
                        </button>
                    </div>
                    
                    {expanded && (
                        <div className="bg-gray-50 border rounded-lg p-4 space-y-4">
                            <h4 className="font-medium text-gray-700 flex items-center gap-2">
                                üèî√Ø¬∏¬è Configurador SmartLamppost
                            </h4>
                            
                            {/* 1. Pack */}
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">1. Pack</label>
                                <select value={selectedPack} onChange={(e) => setSelectedPack(e.target.value)}
                                    className="w-full px-3 py-2 border rounded-lg text-sm">
                                    <option value="">Selecionar Pack...</option>
                                    {packs.map(p => <option key={p} value={p}>{p}</option>)}
                                </select>
                            </div>
                            
                            {/* 2. Coluna Base */}
                            {selectedPack && (
                                <div>
                                    <label className="block text-xs font-medium text-gray-500 mb-1">2. Coluna Base</label>
                                    <select value={selectedColumn?.id || ''} onChange={(e) => {
                                        const col = columns.find(c => c.id === parseInt(e.target.value));
                                        setSelectedColumn(col || null);
                                    }} className="w-full px-3 py-2 border rounded-lg text-sm">
                                        <option value="">Selecionar Coluna...</option>
                                        {columns.map(c => (
                                            <option key={c.id} value={c.id}>
                                                {c.reference} | {c.height_m}m | {c.fixing} | {c.arm_count} bra√ßo(s)
                                            </option>
                                        ))}
                                    </select>
                                    {selectedColumn && (
                                        <p className="text-xs text-gray-400 mt-1">{selectedColumn.description}</p>
                                    )}
                                </div>
                            )}
                            
                            {/* M√≥dulos condicionais */}
                            {selectedColumn && (
                                <div className="grid grid-cols-2 gap-3">
                                    {/* Mod. 1 - Lumin√°ria */}
                                    {selectedColumn.mod1_luminaire !== 'N√£o' && luminaires.length > 0 && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-500 mb-1">
                                                {moduleEmojis.luminaire} Lumin√°ria ({selectedColumn.mod1_luminaire})
                                            </label>
                                            <select value={selectedLuminaire?.id || ''} onChange={(e) => {
                                                const lum = luminaires.find(l => l.id === parseInt(e.target.value));
                                                setSelectedLuminaire(lum || null);
                                            }} className="w-full px-2 py-1.5 border rounded text-xs">
                                                <option value="">Nenhuma</option>
                                                {luminaires.map(l => (
                                                    <option key={l.id} value={l.id}>{l.reference} - {l.luminaire_type}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* Mod. 2 - Quadro El√©trico */}
                                    {selectedColumn.mod2_electrical === 'Sim' && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-500 mb-1">
                                                {moduleEmojis.electrical} Quadro El√©trico
                                            </label>
                                            <select value={selectedElectrical?.id || ''} onChange={(e) => {
                                                const panel = electricalPanels.find(p => p.id === parseInt(e.target.value));
                                                setSelectedElectrical(panel || null);
                                            }} className="w-full px-2 py-1.5 border rounded text-xs">
                                                <option value="">Nenhum</option>
                                                {electricalPanels.map(p => (
                                                    <option key={p.id} value={p.id}>{p.short_reference} - {p.panel_type}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* Mod. 3 - Cofrete Fus√≠vel (s√≥ ESSENCIAL e acima, com bra√ßos) */}
                                    {selectedColumn.mod3_fuse_box !== 'N√£o' && getFilteredFuseBoxes().length > 0 && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-500 mb-1">
                                                {moduleEmojis.fuseBox} Cofrete Fus√≠vel ({selectedColumn.mod3_fuse_box})
                                            </label>
                                            <select value={selectedFuseBox?.id || ''} onChange={(e) => {
                                                const fuse = getFilteredFuseBoxes().find(f => f.id === parseInt(e.target.value));
                                                setSelectedFuseBox(fuse || null);
                                            }} className="w-full px-2 py-1.5 border rounded text-xs">
                                                <option value="">Nenhum</option>
                                                {getFilteredFuseBoxes().map(f => (
                                                    <option key={f.id} value={f.id}>{f.short_reference} - {f.fuse_type}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* Mod. 4 - Telemetria */}
                                    {selectedColumn.mod4_telemetry === 'Sim' && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-500 mb-1">
                                                {moduleEmojis.telemetry} Quadro Telemetria
                                            </label>
                                            <select value={selectedTelemetry?.id || ''} onChange={(e) => {
                                                const panel = telemetryPanels.find(p => p.id === parseInt(e.target.value));
                                                setSelectedTelemetry(panel || null);
                                            }} className="w-full px-2 py-1.5 border rounded text-xs">
                                                <option value="">Nenhum</option>
                                                {telemetryPanels.map(p => (
                                                    <option key={p.id} value={p.id}>{p.short_reference} - {p.panel_type}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* Mod. 5 - Carregador EV */}
                                    {selectedColumn.mod5_ev === 'Sim' && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-500 mb-1">
                                                {moduleEmojis.ev} Carregador EV
                                            </label>
                                            <select value={selectedEV?.id || ''} onChange={(e) => {
                                                const mod = modulesEV.find(m => m.id === parseInt(e.target.value));
                                                setSelectedEV(mod || null);
                                            }} className="w-full px-2 py-1.5 border rounded text-xs">
                                                <option value="">Nenhum</option>
                                                {modulesEV.map(m => (
                                                    <option key={m.id} value={m.id}>{m.short_reference}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* Mod. 6 - MUPI */}
                                    {selectedColumn.mod6_mupi === 'Sim' && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-500 mb-1">
                                                {moduleEmojis.mupi} Ecr√£ MUPI
                                            </label>
                                            <select value={selectedMUPI?.id || ''} onChange={(e) => {
                                                const mod = modulesMUPI.find(m => m.id === parseInt(e.target.value));
                                                setSelectedMUPI(mod || null);
                                            }} className="w-full px-2 py-1.5 border rounded text-xs">
                                                <option value="">Nenhum</option>
                                                {modulesMUPI.map(m => (
                                                    <option key={m.id} value={m.id}>{m.short_reference}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* Mod. 7 - Lateral */}
                                    {selectedColumn.mod7_lateral === 'Sim' && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-500 mb-1">
                                                {moduleEmojis.lateral} M√≥dulo Lateral
                                            </label>
                                            <select value={selectedLateral?.id || ''} onChange={(e) => {
                                                const mod = modulesLateral.find(m => m.id === parseInt(e.target.value));
                                                setSelectedLateral(mod || null);
                                            }} className="w-full px-2 py-1.5 border rounded text-xs">
                                                <option value="">Nenhum</option>
                                                {modulesLateral.map(m => (
                                                    <option key={m.id} value={m.id}>{m.short_reference} - {m.module_type}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* Mod. 8 - Antena */}
                                    {selectedColumn.mod8_antenna === 'Sim' && filteredAntennas.length > 0 && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-500 mb-1">
                                                {moduleEmojis.antenna} C√°psula Antena
                                            </label>
                                            <select value={selectedAntenna?.id || ''} onChange={(e) => {
                                                const mod = filteredAntennas.find(m => m.id === parseInt(e.target.value));
                                                setSelectedAntenna(mod || null);
                                            }} className="w-full px-2 py-1.5 border rounded text-xs">
                                                <option value="">Nenhuma</option>
                                                {filteredAntennas.map(m => (
                                                    <option key={m.id} value={m.id}>{m.short_reference}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Resumo visual */}
                            {selectedColumn && (
                                <div className="bg-white border rounded p-3 text-xs">
                                    <div className="font-medium text-gray-700 mb-2">üìõ Configura√ß√£o Selecionada:</div>
                                    <div className="space-y-1 text-gray-600">
                                        <div>‚Ä¢ Coluna: <span className="font-mono">{selectedColumn.reference}</span> ({selectedColumn.height_m}m, {selectedColumn.fixing})</div>
                                        {selectedLuminaire && <div>‚Ä¢ {moduleEmojis.luminaire} Lumin√°ria: <span className="font-mono">{selectedLuminaire.reference}</span> x{selectedColumn.arm_count || 1}</div>}
                                        {selectedElectrical && <div>‚Ä¢ {moduleEmojis.electrical} Q. El√©trico: <span className="font-mono">{selectedElectrical.short_reference}</span></div>}
                                        {selectedFuseBox && <div>‚Ä¢ {moduleEmojis.fuseBox} Cofrete: <span className="font-mono">{selectedFuseBox.short_reference}</span></div>}
                                        {selectedTelemetry && <div>‚Ä¢ {moduleEmojis.telemetry} Telemetria: <span className="font-mono">{selectedTelemetry.short_reference}</span></div>}
                                        {selectedEV && <div>‚Ä¢ {moduleEmojis.ev} Carregador EV: <span className="font-mono">{selectedEV.short_reference}</span></div>}
                                        {selectedMUPI && <div>‚Ä¢ {moduleEmojis.mupi} MUPI: <span className="font-mono">{selectedMUPI.short_reference}</span></div>}
                                        {selectedLateral && <div>‚Ä¢ {moduleEmojis.lateral} Lateral: <span className="font-mono">{selectedLateral.short_reference}</span></div>}
                                        {selectedAntenna && <div>‚Ä¢ {moduleEmojis.antenna} Antena: <span className="font-mono">{selectedAntenna.short_reference}</span></div>}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };


        // DASHBOARD com mapa
        const Dashboard = ({ setCurrentView }) => {
            const { token } = useAuth();
            const [stats, setStats] = useState(null);
            const [assets, setAssets] = useState([]);
            const [mapReady, setMapReady] = useState(false);
            const mapRef = useRef(null);
            const mapContainerRef = useRef(null);
            
            const PORTUGAL_CENTER = [39.5, -8.0];
            const PORTUGAL_ZOOM = 7;
            
            useEffect(() => { 
                api.get('/stats', token).then(setStats); 
                api.get('/assets/map', token).then(data => setAssets(data.assets || [])).catch(err => {
                    console.log('Sem ativos para mapa');
                    setAssets([]);
                });
            }, [token]);
            
            // Inicializar mapa ap√≥s stats carregarem
            useEffect(() => {
                if (!stats || !mapContainerRef.current || mapRef.current) return;
                
                // Pequeno delay para garantir que o container est√° renderizado
                const timer = setTimeout(() => {
                    try {
                        if (mapRef.current) return; // J√° foi inicializado
                        
                        const map = L.map(mapContainerRef.current, {
                            zoomControl: true,
                            scrollWheelZoom: true,
                            dragging: true
                        }).setView(PORTUGAL_CENTER, PORTUGAL_ZOOM);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '√Ç¬© OpenStreetMap'
                        }).addTo(map);
                        
                        mapRef.current = map;
                        setMapReady(true);
                        
                        // Force resize
                        setTimeout(() => {
                            if (mapRef.current) {
                                mapRef.current.invalidateSize();
                            }
                        }, 200);
                    } catch (err) {
                        console.error('Erro ao inicializar mapa Dashboard:', err);
                    }
                }, 100);
                
                return () => {
                    clearTimeout(timer);
                    if (mapRef.current) {
                        mapRef.current.remove();
                        mapRef.current = null;
                        setMapReady(false);
                    }
                };
            }, [stats]);
            
            // Adicionar marcadores quando mapa e assets estiverem prontos
            useEffect(() => {
                if (!mapReady || !mapRef.current || !assets.length) return;
                
                // Limpar marcadores anteriores
                mapRef.current.eachLayer(layer => {
                    if (layer instanceof L.Marker) mapRef.current.removeLayer(layer);
                });
                
                const validBounds = [];
                
                assets.forEach(asset => {
                    const lat = parseFloat(asset.latitude);
                    const lng = parseFloat(asset.longitude);
                    
                    if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) return;
                    
                    validBounds.push([lat, lng]);
                    
                    // Determinar cor baseada no estado
                    let color = '#6b7280'; // cinza por defeito
                    const status = asset.status;
                    if (status === 'Operacional') color = '#22c55e';
                    else if (status === 'Manuten√ß√£o') color = '#eab308';
                    else if (status === 'Avariado') color = '#f97316';
                    else if (status === 'Desativado') color = '#ef4444';
                    
                    const icon = L.divIcon({
                        className: 'custom-marker-dashboard',
                        html: `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"></div>`,
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    });
                    
                    const marker = L.marker([lat, lng], { icon }).addTo(mapRef.current);
                    
                    // Popup com info do ativo
                    marker.bindPopup(`
                        <div class="asset-popup">
                            <h4>${asset.serial_number}</h4>
                            <p><strong>Estado:</strong> ${status || 'N/D'}</p>
                            ${asset.municipality ? `<p><strong>Munic√≠pio:</strong> ${asset.municipality}</p>` : ''}
                        </div>
                    `);
                });
                
                if (validBounds.length > 0) {
                    mapRef.current.fitBounds(validBounds, { padding: [20, 20], maxZoom: 10 });
                }
            }, [mapReady, assets]);
            
            if (!stats) return <div className="p-8 text-center">A carregar...</div>;
            
            return (
                <div className="p-6 fade-in">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Dashboard</h2>
                    
                    {/* Cards de estat√≠sticas */}
                    <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                        <div className="bg-white rounded-xl shadow-md p-5">
                            <p className="text-sm text-gray-500">Total de Ativos</p>
                            <p className="text-2xl font-bold text-gray-800">{stats?.total_assets || 0}</p>
                        </div>
                        <div className="bg-white rounded-xl shadow-md p-5">
                            <p className="text-sm text-gray-500">Operacionais</p>
                            <p className="text-2xl font-bold text-green-600">{stats?.by_condition?.find(c => c.field_value === 'Operacional')?.count || 0}</p>
                        </div>
                        <div className="bg-white rounded-xl shadow-md p-5">
                            <p className="text-sm text-gray-500">Manuten√ß√£o Necess√°ria</p>
                            <p className="text-2xl font-bold text-yellow-600">{stats?.by_condition?.find(c => c.field_value === 'Manuten√ß√£o Necess√°ria')?.count || 0}</p>
                        </div>
                        <div className="bg-white rounded-xl shadow-md p-5">
                            <p className="text-sm text-gray-500">Manuten√ß√µes Realizadas (30d)</p>
                            <p className="text-2xl font-bold text-purple-600">{stats?.recent_maintenance_30d || 0}</p>
                        </div>
                        <div className="bg-white rounded-xl shadow-md p-5 border-l-4 border-blue-500">
                            <p className="text-sm text-gray-500">Manuten√ß√µes Programadas (30d)</p>
                            <p className="text-2xl font-bold text-blue-600">{stats?.scheduled_maintenance_30d || 0}</p>
                        </div>
                    </div>
                    
                    {/* Grid para gr√°fico de barras e lista de manuten√ß√µes */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        {/* Gr√°fico por Munic√≠pio */}
                        {stats?.by_municipality?.length > 0 && (() => {
                            const maxCount = Math.max(...stats.by_municipality.map(m => m.count));
                            return (
                                <div className="bg-white rounded-xl shadow-md p-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-semibold">Por Munic√≠pio</h3>
                                        <span className="text-xs text-gray-500">M√°x: {maxCount}</span>
                                    </div>
                                    <div className="space-y-2">
                                        {stats.by_municipality.map((m, i) => (
                                            <div key={i} className="flex items-center">
                                                <span className="w-28 text-sm truncate" title={m.field_value}>{m.field_value || 'N/D'}</span>
                                                <div className="flex-1 h-4 bg-gray-200 rounded-full mx-3">
                                                    <div className="h-full bg-blue-600 rounded-full transition-all" style={{width: `${(m.count/maxCount)*100}%`}}/>
                                                </div>
                                                <span className="font-medium w-8 text-right text-sm">{m.count}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })()}
                        
                        {/* Lista de Manuten√ß√µes Programadas */}
                        <div className="bg-white rounded-xl shadow-md p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-semibold">Pr√≥ximas Manuten√ß√µes</h3>
                                <span className="text-xs text-gray-500">Pr√≥ximos 30 dias</span>
                            </div>
                            {stats?.upcoming_maintenance?.length > 0 ? (
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {stats.upcoming_maintenance.map((m, i) => (
                                        <div key={i} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                                            <div>
                                                <span className="font-medium text-sm">{m.serial_number}</span>
                                                {m.municipality && <span className="text-xs text-gray-500 ml-2">({m.municipality})</span>}
                                            </div>
                                            <div className="text-right">
                                                <span className="text-xs font-medium text-blue-600">
                                                    {new Date(m.maintenance_date).toLocaleDateString('pt-PT')}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-8 text-gray-400">
                                    <p>Nenhuma manuten√ß√£o programada</p>
                                    <p className="text-xs mt-1">Adicione datas no campo "Pr√≥xima Manuten√ß√£o" dos ativos</p>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Mapa */}
                    <div className="bg-white rounded-xl shadow-md p-4">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-semibold">Mapa de Ativos</h3>
                            <button 
                                onClick={() => setCurrentView('map')}
                                className="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                Abrir Mapa Completo ‚Üí
                            </button>
                        </div>
                        <div 
                            ref={mapContainerRef}
                            className="w-full h-64 rounded-lg overflow-hidden"
                            style={{ minHeight: '300px' }}
                        />
                        <div className="flex justify-center gap-4 mt-3 text-xs">
                            <span className="flex items-center"><span className="w-3 h-3 rounded-full bg-green-500 mr-1"></span>Operacional</span>
                            <span className="flex items-center"><span className="w-3 h-3 rounded-full bg-yellow-500 mr-1"></span>Manuten√ß√£o</span>
                            <span className="flex items-center"><span className="w-3 h-3 rounded-full bg-orange-500 mr-1"></span>Em Repara√ß√£o</span>
                            <span className="flex items-center"><span className="w-3 h-3 rounded-full bg-red-500 mr-1"></span>Desativado</span>
                        </div>
                    </div>
                </div>
            );
        };
        
        // EXPORT MODAL
        const ExportModal = ({ onClose, token }) => {
            const [exportFields, setExportFields] = useState([]);
            const [selectedFields, setSelectedFields] = useState([]);
            const [loading, setLoading] = useState(true);
            const [exporting, setExporting] = useState(false);
            const [error, setError] = useState('');
            
            useEffect(() => {
                api.get('/export/excel/fields', token)
                    .then(data => {
                        setExportFields(data);
                        // Selecionar todos por defeito
                        const allFields = data.flatMap(cat => cat.fields.map(f => f.field_name));
                        setSelectedFields(allFields);
                        setLoading(false);
                    })
                    .catch(err => {
                        setError('Erro ao carregar campos');
                        setLoading(false);
                    });
            }, [token]);
            
            const toggleField = (fieldName) => {
                setSelectedFields(prev => 
                    prev.includes(fieldName) 
                        ? prev.filter(f => f !== fieldName)
                        : [...prev, fieldName]
                );
            };
            
            const toggleCategory = (fields) => {
                const fieldNames = fields.map(f => f.field_name);
                const allSelected = fieldNames.every(f => selectedFields.includes(f));
                if (allSelected) {
                    setSelectedFields(prev => prev.filter(f => !fieldNames.includes(f)));
                } else {
                    setSelectedFields(prev => [...new Set([...prev, ...fieldNames])]);
                }
            };
            
            const selectAll = () => {
                const allFields = exportFields.flatMap(cat => cat.fields.map(f => f.field_name));
                setSelectedFields(allFields);
            };
            
            const selectNone = () => setSelectedFields([]);
            
            const handleExport = async () => {
                setExporting(true);
                setError('');
                try {
                    await api.postDownload('/export/excel', { fields: selectedFields.length > 0 ? selectedFields : null }, token);
                    onClose();
                } catch (err) {
                    setError(err.message || 'Erro ao exportar');
                } finally {
                    setExporting(false);
                }
            };
            
            const handleExportJSON = async () => {
                setExporting(true);
                try {
                    const data = await api.get('/export', token);
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `export_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    onClose();
                } catch (err) {
                    setError('Erro ao exportar JSON');
                } finally {
                    setExporting(false);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden fade-in">
                        <div className="p-6 border-b flex justify-between items-center bg-gradient-to-r from-green-600 to-green-700">
                            <div className="flex items-center">
                                <svg className="w-6 h-6 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <div>
                                    <h3 className="text-xl font-bold text-white">Exportar Ativos</h3>
                                    <p className="text-green-100 text-sm">Selecione os campos a incluir</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-white hover:text-green-200 text-2xl">&times;</button>
                        </div>
                        
                        {error && <div className="mx-6 mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">{error}</div>}
                        
                        <div className="p-6 overflow-y-auto max-h-[50vh]">
                            {loading ? (
                                <div className="text-center py-8 text-gray-500">A carregar campos...</div>
                            ) : (
                                <>
                                    <div className="flex gap-2 mb-4">
                                        <button onClick={selectAll} className="text-sm text-blue-600 hover:underline">Selecionar Todos</button>
                                        <span className="text-gray-300">|</span>
                                        <button onClick={selectNone} className="text-sm text-blue-600 hover:underline">Limpar Sele√ß√£o</button>
                                        <span className="ml-auto text-sm text-gray-500">{selectedFields.length} campos selecionados</span>
                                    </div>
                                    
                                    {exportFields.map(category => (
                                        <div key={category.category} className="mb-4">
                                            <div 
                                                onClick={() => toggleCategory(category.fields)}
                                                className="flex items-center justify-between p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200"
                                            >
                                                <span className="font-medium text-gray-700">{category.category_label}</span>
                                                <span className="text-sm text-gray-500">
                                                    {category.fields.filter(f => selectedFields.includes(f.field_name)).length}/{category.fields.length}
                                                </span>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 mt-2 pl-2">
                                                {category.fields.map(field => (
                                                    <label key={field.field_name} className="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={selectedFields.includes(field.field_name)}
                                                            onChange={() => toggleField(field.field_name)}
                                                            className="rounded border-gray-300 text-green-600 focus:ring-green-500"
                                                        />
                                                        <span className="text-sm text-gray-600">{field.field_label}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </>
                            )}
                        </div>
                        
                        <div className="p-6 border-t bg-gray-50 flex justify-between items-center">
                            <button 
                                onClick={handleExportJSON}
                                disabled={exporting}
                                className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg flex items-center"
                            >
                                <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export JSON
                            </button>
                            <div className="flex gap-3">
                                <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">Cancelar</button>
                                <button 
                                    onClick={handleExport}
                                    disabled={exporting || selectedFields.length === 0}
                                    className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center"
                                >
                                    {exporting ? (
                                        <>
                                            <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            A exportar...
                                        </>
                                    ) : (
                                        <>
                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                            Exportar Excel
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // BACKUP MODAL
        const BackupModal = ({ onClose, token, isAdmin }) => {
            const [backups, setBackups] = useState([]);
            const [loading, setLoading] = useState(true);
            const [creating, setCreating] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            
            const loadBackups = async () => {
                try {
                    const data = await api.get('/backup/list', token);
                    setBackups(data.backups || []);
                } catch (err) {
                    setError('Erro ao carregar backups');
                } finally {
                    setLoading(false);
                }
            };
            
            useEffect(() => { loadBackups(); }, [token]);
            
            const handleCreate = async () => {
                setCreating(true);
                setError('');
                setSuccess('');
                try {
                    const result = await api.post('/backup/create', {}, token);
                    if (result.ok) {
                        setSuccess(`Backup criado: ${result.data.filename}`);
                        loadBackups();
                    } else {
                        setError(result.data.error || 'Erro ao criar backup');
                    }
                } catch (err) {
                    setError('Erro ao criar backup');
                } finally {
                    setCreating(false);
                }
            };
            
            const handleDownload = async (filename) => {
                try {
                    await api.download(`/backup/download/${filename}`, token, filename);
                } catch (err) {
                    setError('Erro ao fazer download');
                }
            };
            
            const handleDelete = async (filename) => {
                if (!confirm(`Eliminar backup ${filename}?`)) return;
                try {
                    const result = await api.delete(`/backup/delete/${filename}`, token);
                    if (result.ok) {
                        setSuccess('Backup eliminado');
                        loadBackups();
                    } else {
                        setError(result.data.error || 'Erro ao eliminar');
                    }
                } catch (err) {
                    setError('Erro ao eliminar backup');
                }
            };
            
            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden fade-in">
                        <div className="p-6 border-b flex justify-between items-center bg-gradient-to-r from-purple-600 to-purple-700">
                            <div className="flex items-center">
                                <svg className="w-6 h-6 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                                </svg>
                                <div>
                                    <h3 className="text-xl font-bold text-white">Gest√£o de Backups</h3>
                                    <p className="text-purple-100 text-sm">Crie e restaure c√≥pias de seguran√ßa</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-white hover:text-purple-200 text-2xl">&times;</button>
                        </div>
                        
                        {error && <div className="mx-6 mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">{error}</div>}
                        {success && <div className="mx-6 mt-4 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg">{success}</div>}
                        
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h4 className="font-semibold text-gray-700">Backups Dispon√≠veis</h4>
                                <button 
                                    onClick={handleCreate}
                                    disabled={creating}
                                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 flex items-center"
                                >
                                    {creating ? (
                                        <>
                                            <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            A criar...
                                        </>
                                    ) : (
                                        <>
                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                            </svg>
                                            Criar Backup
                                        </>
                                    )}
                                </button>
                            </div>
                            
                            <div className="overflow-y-auto max-h-[45vh]">
                                {loading ? (
                                    <div className="text-center py-8 text-gray-500">A carregar...</div>
                                ) : backups.length === 0 ? (
                                    <div className="text-center py-8">
                                        <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                                        </svg>
                                        <p className="text-gray-500">Nenhum backup dispon√≠vel</p>
                                        <p className="text-sm text-gray-400 mt-1">Crie o primeiro backup clicando no bot√£o acima</p>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {backups.map((backup, i) => (
                                            <div key={i} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                <div className="flex items-center">
                                                    <svg className="w-8 h-8 text-purple-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                                    </svg>
                                                    <div>
                                                        <p className="font-mono text-sm font-medium text-gray-800">{backup.filename}</p>
                                                        <p className="text-xs text-gray-500">
                                                            {backup.created_at_formatted} ‚Ä¢ {formatSize(backup.size)}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button 
                                                        onClick={() => handleDownload(backup.filename)}
                                                        className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"
                                                        title="Download"
                                                    >
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                                        </svg>
                                                    </button>
                                                    {isAdmin && (
                                                        <button 
                                                            onClick={() => handleDelete(backup.filename)}
                                                            className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                                                            title="Eliminar"
                                                        >
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <div className="p-4 border-t bg-gray-50 flex justify-between items-center">
                            <p className="text-sm text-gray-500">
                                <svg className="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Os backups incluem toda a base de dados
                            </p>
                            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">Fechar</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // IMPORT MODAL
        const ImportModal = ({ onClose, token, onSuccess }) => {
            const [file, setFile] = useState(null);
            const [importFields, setImportFields] = useState([]);
            const [selectedFields, setSelectedFields] = useState([]);
            const [mode, setMode] = useState('upsert');
            const [loading, setLoading] = useState(true);
            const [importing, setImporting] = useState(false);
            const [error, setError] = useState('');
            const [result, setResult] = useState(null);
            const [dragActive, setDragActive] = useState(false);
            
            // Carregar campos dispon√≠veis
            useEffect(() => {
                api.get('/export/excel/fields', token)
                    .then(data => {
                        setImportFields(data);
                        const allFields = data.flatMap(cat => cat.fields.map(f => f.field_name));
                        setSelectedFields(allFields);
                        setLoading(false);
                    })
                    .catch(() => { setError('Erro ao carregar campos'); setLoading(false); });
            }, [token]);
            
            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") setDragActive(true);
                else if (e.type === "dragleave") setDragActive(false);
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            };
            
            const handleFileSelect = (selectedFile) => {
                if (selectedFile && (selectedFile.name.endsWith('.xlsx') || selectedFile.name.endsWith('.xls'))) {
                    setFile(selectedFile);
                    setError('');
                    setResult(null);
                } else {
                    setError('Por favor selecione um ficheiro Excel (.xlsx ou .xls)');
                }
            };
            
            const toggleField = (fieldName) => {
                setSelectedFields(prev => prev.includes(fieldName) ? prev.filter(f => f !== fieldName) : [...prev, fieldName]);
            };
            
            const toggleCategory = (fields) => {
                const fieldNames = fields.map(f => f.field_name);
                const allSelected = fieldNames.every(f => selectedFields.includes(f));
                if (allSelected) {
                    setSelectedFields(prev => prev.filter(f => !fieldNames.includes(f)));
                } else {
                    setSelectedFields(prev => [...new Set([...prev, ...fieldNames])]);
                }
            };
            
            const handleDownloadTemplate = async () => {
                try {
                    await api.download('/import/excel/template', token, 'template_importacao_ativos.xlsx');
                } catch (err) {
                    setError('Erro ao descarregar template');
                }
            };
            
            const handleImport = async () => {
                if (!file) {
                    setError('Selecione um ficheiro primeiro');
                    return;
                }
                
                setImporting(true);
                setError('');
                setResult(null);
                
                try {
                    const response = await api.uploadFile('/import/excel', file, {
                        mode: mode,
                        selected_fields: selectedFields
                    }, token);
                    
                    if (response.ok) {
                        setResult(response.data);
                        if (onSuccess) onSuccess();
                    } else {
                        setError(response.data.error || 'Erro na importa√ß√£o');
                    }
                } catch (err) {
                    setError(err.message || 'Erro na importa√ß√£o');
                } finally {
                    setImporting(false);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden fade-in">
                        <div className="p-6 border-b flex justify-between items-center bg-gradient-to-r from-blue-600 to-blue-700">
                            <div className="flex items-center">
                                <svg className="w-6 h-6 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                <div>
                                    <h3 className="text-xl font-bold text-white">Importar Ativos</h3>
                                    <p className="text-blue-100 text-sm">Carregar dados a partir de Excel</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="text-white hover:text-blue-200 text-2xl">&times;</button>
                        </div>
                        
                        {error && <div className="mx-6 mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">{error}</div>}
                        
                        {result ? (
                            <div className="p-6">
                                <div className="text-center mb-6">
                                    <div className="w-16 h-16 bg-green-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                                        <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <h4 className="text-xl font-bold text-gray-800">Importa√ß√£o Conclu√≠da!</h4>
                                </div>
                                
                                <div className="grid grid-cols-3 gap-4 mb-6">
                                    <div className="bg-green-50 rounded-lg p-4 text-center">
                                        <p className="text-3xl font-bold text-green-600">{result.created}</p>
                                        <p className="text-sm text-green-700">Criados</p>
                                    </div>
                                    <div className="bg-blue-50 rounded-lg p-4 text-center">
                                        <p className="text-3xl font-bold text-blue-600">{result.updated}</p>
                                        <p className="text-sm text-blue-700">Atualizados</p>
                                    </div>
                                    <div className="bg-gray-50 rounded-lg p-4 text-center">
                                        <p className="text-3xl font-bold text-gray-600">{result.ignored}</p>
                                        <p className="text-sm text-gray-700">Ignorados</p>
                                    </div>
                                </div>
                                
                                {result.errors && result.errors.length > 0 && (
                                    <div className="bg-red-50 rounded-lg p-4 mb-4">
                                        <h5 className="font-semibold text-red-700 mb-2">Erros ({result.errors.length}):</h5>
                                        <ul className="text-sm text-red-600 max-h-32 overflow-y-auto">
                                            {result.errors.map((err, i) => <li key={i}>‚Ä¢ {err}</li>)}
                                        </ul>
                                    </div>
                                )}
                                
                                <button onClick={onClose} className="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Fechar
                                </button>
                            </div>
                        ) : (
                            <>
                                <div className="p-6 overflow-y-auto max-h-[60vh]">
                                    {/* √ç¬Årea de upload */}
                                    <div 
                                        className={`border-2 border-dashed rounded-xl p-8 text-center mb-6 transition-colors ${
                                            dragActive ? 'border-blue-500 bg-blue-50' : file ? 'border-green-500 bg-green-50' : 'border-gray-300 hover:border-blue-400'
                                        }`}
                                        onDragEnter={handleDrag}
                                        onDragLeave={handleDrag}
                                        onDragOver={handleDrag}
                                        onDrop={handleDrop}
                                    >
                                        {file ? (
                                            <div>
                                                <svg className="w-12 h-12 text-green-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <p className="font-medium text-green-700">{file.name}</p>
                                                <p className="text-sm text-green-600">{(file.size / 1024).toFixed(1)} KB</p>
                                                <button onClick={() => setFile(null)} className="mt-2 text-sm text-red-600 hover:underline">Remover</button>
                                            </div>
                                        ) : (
                                            <div>
                                                <svg className="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                                </svg>
                                                <p className="text-gray-600 mb-2">Arraste o ficheiro Excel aqui ou</p>
                                                <label className="cursor-pointer">
                                                    <span className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Selecionar ficheiro</span>
                                                    <input type="file" accept=".xlsx,.xls" className="hidden" onChange={(e) => handleFileSelect(e.target.files[0])} />
                                                </label>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Modo de importa√ß√£o */}
                                    <div className="mb-6">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Modo de Importa√ß√£o</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            <button 
                                                onClick={() => setMode('create')}
                                                className={`p-3 rounded-lg border-2 text-sm ${mode === 'create' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:border-gray-300'}`}
                                            >
                                                <strong>Apenas Criar</strong>
                                                <p className="text-xs text-gray-500 mt-1">Ignora N¬∫ S√©rie existentes</p>
                                            </button>
                                            <button 
                                                onClick={() => setMode('update')}
                                                className={`p-3 rounded-lg border-2 text-sm ${mode === 'update' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:border-gray-300'}`}
                                            >
                                                <strong>Apenas Atualizar</strong>
                                                <p className="text-xs text-gray-500 mt-1">Ignora N¬∫ S√©rie novos</p>
                                            </button>
                                            <button 
                                                onClick={() => setMode('upsert')}
                                                className={`p-3 rounded-lg border-2 text-sm ${mode === 'upsert' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:border-gray-300'}`}
                                            >
                                                <strong>Criar/Atualizar</strong>
                                                <p className="text-xs text-gray-500 mt-1">Processa todos</p>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Sele√ß√£o de campos */}
                                    <div className="mb-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="block text-sm font-medium text-gray-700">Campos a Importar</label>
                                            <div className="flex gap-2">
                                                <button onClick={() => setSelectedFields(importFields.flatMap(cat => cat.fields.map(f => f.field_name)))} className="text-xs text-blue-600 hover:underline">Todos</button>
                                                <button onClick={() => setSelectedFields([])} className="text-xs text-blue-600 hover:underline">Nenhum</button>
                                            </div>
                                        </div>
                                        
                                        {loading ? (
                                            <div className="text-center py-4 text-gray-500">A carregar campos...</div>
                                        ) : (
                                            <div className="max-h-48 overflow-y-auto border rounded-lg p-2">
                                                {importFields.map(category => (
                                                    <div key={category.category} className="mb-2">
                                                        <div 
                                                            onClick={() => toggleCategory(category.fields)}
                                                            className="flex items-center justify-between p-2 bg-gray-50 rounded cursor-pointer hover:bg-gray-100"
                                                        >
                                                            <span className="text-sm font-medium">{category.category_label}</span>
                                                            <span className="text-xs text-gray-500">
                                                                {category.fields.filter(f => selectedFields.includes(f.field_name)).length}/{category.fields.length}
                                                            </span>
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-1 mt-1 pl-2">
                                                            {category.fields.map(field => (
                                                                <label key={field.field_name} className="flex items-center space-x-2 p-1 hover:bg-gray-50 rounded cursor-pointer">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        checked={selectedFields.includes(field.field_name)}
                                                                        onChange={() => toggleField(field.field_name)}
                                                                        className="rounded border-gray-300 text-blue-600"
                                                                    />
                                                                    <span className="text-xs text-gray-600">{field.field_label}</span>
                                                                </label>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="p-6 border-t bg-gray-50 flex justify-between items-center">
                                    <button onClick={handleDownloadTemplate} className="text-sm text-blue-600 hover:underline flex items-center">
                                        <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Descarregar Template
                                    </button>
                                    <div className="flex gap-3">
                                        <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">Cancelar</button>
                                        <button 
                                            onClick={handleImport}
                                            disabled={importing || !file}
                                            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center"
                                        >
                                            {importing ? (
                                                <>
                                                    <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    A importar...
                                                </>
                                            ) : 'Importar'}
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };
        
        // ASSETS LIST com ordena√ß√£o e altera√ß√£o de estado
        const AssetsList = ({ initialSearch = '', onNewIntervention }) => {
            const { token, user } = useAuth();
            const [assets, setAssets] = useState([]);
            const [schema, setSchema] = useState([]);
            const [loading, setLoading] = useState(true);
            const [search, setSearch] = useState(initialSearch);
            const [page, setPage] = useState(1);
            const [totalPages, setTotalPages] = useState(1);
            const [selectedAsset, setSelectedAsset] = useState(null);
            const [showForm, setShowForm] = useState(false);
            const [editMode, setEditMode] = useState(false);
            const [showExport, setShowExport] = useState(false);
            const [showBackup, setShowBackup] = useState(false);
            const [showImport, setShowImport] = useState(false);
            const [sortColumn, setSortColumn] = useState('serial_number');
            const [sortDirection, setSortDirection] = useState('asc');
            // Novos estados para sele√ß√£o e altera√ß√£o de estado
            const [selectedSerials, setSelectedSerials] = useState([]);
            const [showStatusModal, setShowStatusModal] = useState(false);
            const [statusChange, setStatusChange] = useState({ newStatus: '', description: '' });
            const [showStatusConfirm, setShowStatusConfirm] = useState(false);
            const [statusChangeLoading, setStatusChangeLoading] = useState(false);
            const [statusChangeResult, setStatusChangeResult] = useState(null);
            
            const loadAssets = async () => {
                setLoading(true);
                const data = await api.get(`/assets?page=${page}&search=${search}`, token);
                setAssets(data.assets || []);
                setTotalPages(data.pages || 1);
                setLoading(false);
            };
            
            useEffect(() => { api.get('/schema', token).then(setSchema); }, []);
            useEffect(() => { loadAssets(); }, [page, search, token]);
            useEffect(() => { if (initialSearch !== search) setSearch(initialSearch); }, [initialSearch]);
            
            // Fun√ß√µes de sele√ß√£o
            const toggleSelectAll = () => {
                if (selectedSerials.length === sortedAssets.length) {
                    setSelectedSerials([]);
                } else {
                    setSelectedSerials(sortedAssets.map(a => a.serial_number));
                }
            };
            
            const toggleSelectOne = (serialNumber) => {
                if (selectedSerials.includes(serialNumber)) {
                    setSelectedSerials(selectedSerials.filter(s => s !== serialNumber));
                } else {
                    setSelectedSerials([...selectedSerials, serialNumber]);
                }
            };
            
            // Fun√ß√µes de altera√ß√£o de estado
            const openStatusModal = (singleSerial = null) => {
                if (singleSerial) {
                    setSelectedSerials([singleSerial]);
                }
                setStatusChange({ newStatus: '', description: '' });
                setShowStatusModal(true);
                setShowStatusConfirm(false);
                setStatusChangeResult(null);
            };
            
            const closeStatusModal = () => {
                setShowStatusModal(false);
                setShowStatusConfirm(false);
                setStatusChangeResult(null);
                setStatusChange({ newStatus: '', description: '' });
            };
            
            const proceedToConfirm = () => {
                if (!statusChange.newStatus || !statusChange.description.trim()) {
                    alert('Por favor preencha o novo estado e a descri√ß√£o.');
                    return;
                }
                setShowStatusConfirm(true);
            };
            
            const executeStatusChange = async () => {
                setStatusChangeLoading(true);
                try {
                    const result = await api.post('/assets/change-status', {
                        serial_numbers: selectedSerials,
                        new_status: statusChange.newStatus,
                        description: statusChange.description.trim()
                    }, token);
                    
                    setStatusChangeResult(result.data || result);
                    loadAssets();
                    setSelectedSerials([]);
                } catch (err) {
                    setStatusChangeResult({ error: 'Erro ao alterar estado' });
                }
                setStatusChangeLoading(false);
            };
            
            // Fun√ß√£o de ordena√ß√£o
            const sortedAssets = [...assets].sort((a, b) => {
                let valA, valB;
                
                switch(sortColumn) {
                    case 'serial_number':
                        valA = a.serial_number || '';
                        valB = b.serial_number || '';
                        break;
                    case 'rfid_tag':
                        valA = a.data?.rfid_tag || '';
                        valB = b.data?.rfid_tag || '';
                        break;
                    case 'product_reference':
                        valA = a.data?.product_reference || '';
                        valB = b.data?.product_reference || '';
                        break;
                    case 'power_watts':
                        valA = parseFloat(a.data?.power_watts) || 0;
                        valB = parseFloat(b.data?.power_watts) || 0;
                        break;
                    case 'connection_type':
                        valA = a.data?.connection_type || '';
                        valB = b.data?.connection_type || '';
                        break;
                    case 'installation_location':
                        valA = a.data?.installation_location || '';
                        valB = b.data?.installation_location || '';
                        break;
                    case 'condition_status':
                        valA = a.data?.condition_status || '';
                        valB = b.data?.condition_status || '';
                        break;
                    default:
                        valA = a.serial_number || '';
                        valB = b.serial_number || '';
                }
                
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return sortDirection === 'asc' ? valA - valB : valB - valA;
                }
                
                const comparison = String(valA).localeCompare(String(valB), 'pt', { sensitivity: 'base' });
                return sortDirection === 'asc' ? comparison : -comparison;
            });
            
            const handleSort = (column) => {
                if (sortColumn === column) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortColumn(column);
                    setSortDirection('asc');
                }
            };
            
            const SortIcon = ({ column }) => {
                if (sortColumn !== column) {
                    return (
                        <svg className="w-4 h-4 text-gray-300 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                        </svg>
                    );
                }
                return sortDirection === 'asc' ? (
                    <svg className="w-4 h-4 text-blue-600 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                    </svg>
                ) : (
                    <svg className="w-4 h-4 text-blue-600 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                    </svg>
                );
            };
            
            const openAsset = async (serialNumber) => {
                const data = await api.get(`/assets/${serialNumber}`, token);
                setSelectedAsset(data);
                setEditMode(false);
            };
            
            const closeModal = () => { setSelectedAsset(null); setShowForm(false); setEditMode(false); };
            
            const handleDelete = async (serialNumber) => {
                if (confirm('Eliminar este ativo?')) {
                    await api.delete(`/assets/${serialNumber}`, token);
                    loadAssets();
                    closeModal();
                }
            };
            
            const categories = { identification: 'Identifica√ß√£o', specifications: 'Especifica√ß√µes', installation: 'Instala√ß√£o', warranty: 'Garantia', maintenance: 'Manuten√ß√£o', equipment: 'Equipamento', other: 'Outros', custom: 'Personalizados' };
            
            return (
                <div className="p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Ativos</h2>
                        <div className="flex gap-2">
                            {selectedSerials.length > 0 && (user?.role === 'admin' || user?.role === 'superadmin') && (
                                <button 
                                    onClick={() => openStatusModal()}
                                    className="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 flex items-center"
                                    title="Alterar estado dos ativos selecionados (Admin)"
                                >
                                    <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    Alterar Estado ({selectedSerials.length})
                                </button>
                            )}
                            <button 
                                onClick={() => setShowImport(true)} 
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center"
                                title="Importar de Excel"
                            >
                                <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                Importar
                            </button>
                            <button 
                                onClick={() => setShowExport(true)} 
                                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center"
                                title="Exportar para Excel"
                            >
                                <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Exportar
                            </button>
                            <button 
                                onClick={() => setShowBackup(true)} 
                                className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center"
                                title="Gest√£o de Backups"
                            >
                                <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                                </svg>
                                Backup
                            </button>
                            {user?.role !== 'visitor' && (
                                <button onClick={() => { setShowForm(true); setSelectedAsset(null); }} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                                    <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                    </svg>
                                    Novo Ativo
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {/* Barra de sele√ß√£o */}
                    {selectedSerials.length > 0 && (
                        <div className="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg flex justify-between items-center">
                            <span className="text-orange-700">
                                <strong>{selectedSerials.length}</strong> ativo(s) selecionado(s)
                            </span>
                            <button 
                                onClick={() => setSelectedSerials([])}
                                className="text-orange-600 hover:text-orange-800 text-sm"
                            >
                                Limpar sele√ß√£o
                            </button>
                        </div>
                    )}
                    
                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        <div className="p-4 border-b">
                            <div className="flex gap-4">
                                <input type="text" value={search} onChange={(e) => { setSearch(e.target.value); setPage(1); }} placeholder="Pesquisar..." className="flex-1 px-4 py-2 border rounded-lg" />
                            </div>
                        </div>
                        {loading ? <div className="p-8 text-center">A carregar...</div> : assets.length === 0 ? <div className="p-8 text-center text-gray-500">Nenhum ativo encontrado</div> : (
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-3 py-3 text-center">
                                                <input 
                                                    type="checkbox" 
                                                    checked={selectedSerials.length === sortedAssets.length && sortedAssets.length > 0}
                                                    onChange={toggleSelectAll}
                                                    className="w-4 h-4 rounded border-gray-300"
                                                    title="Selecionar todos"
                                                />
                                            </th>
                                            <th onClick={() => handleSort('serial_number')} className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                                <div className="flex items-center">N¬∫ S√©rie<SortIcon column="serial_number" /></div>
                                            </th>
                                            <th onClick={() => handleSort('rfid_tag')} className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                                <div className="flex items-center">RFID<SortIcon column="rfid_tag" /></div>
                                            </th>
                                            <th onClick={() => handleSort('product_reference')} className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                                <div className="flex items-center">Refer√™ncia<SortIcon column="product_reference" /></div>
                                            </th>
                                            <th onClick={() => handleSort('power_watts')} className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                                <div className="flex items-center">Pot√™ncia<SortIcon column="power_watts" /></div>
                                            </th>
                                            <th onClick={() => handleSort('connection_type')} className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                                <div className="flex items-center">Liga√ß√£o<SortIcon column="connection_type" /></div>
                                            </th>
                                            <th onClick={() => handleSort('installation_location')} className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                                <div className="flex items-center">Localiza√ß√£o<SortIcon column="installation_location" /></div>
                                            </th>
                                            <th onClick={() => handleSort('condition_status')} className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                                <div className="flex items-center">Estado<SortIcon column="condition_status" /></div>
                                            </th>
                                            <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {sortedAssets.map(a => (
                                            <tr key={a.serial_number} className={`hover:bg-gray-50 ${selectedSerials.includes(a.serial_number) ? 'bg-orange-50' : ''}`}>
                                                <td className="px-3 py-4 text-center">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={selectedSerials.includes(a.serial_number)}
                                                        onChange={() => toggleSelectOne(a.serial_number)}
                                                        className="w-4 h-4 rounded border-gray-300"
                                                    />
                                                </td>
                                                <td className="px-4 py-4 font-mono text-sm font-medium">{a.serial_number}</td>
                                                <td className="px-4 py-4 font-mono text-xs text-gray-500">{a.data?.rfid_tag || '-'}</td>
                                                <td className="px-4 py-4 text-sm">{a.data?.product_reference || '-'}</td>
                                                <td className="px-4 py-4 text-sm">{a.data?.power_watts ? `${a.data.power_watts}W` : '-'}</td>
                                                <td className="px-4 py-4 text-sm">{a.data?.connection_type || '-'}</td>
                                                <td className="px-4 py-4 text-sm">{a.data?.installation_location || '-'}</td>
                                                <td className="px-4 py-4"><span className={`px-2 py-1 rounded-full text-xs ${a.data?.condition_status === 'Operacional' ? 'bg-green-100 text-green-800' : a.data?.condition_status === 'Manuten√ß√£o Necess√°ria' ? 'bg-yellow-100 text-yellow-800' : a.data?.condition_status === 'Em Repara√ß√£o' ? 'bg-orange-100 text-orange-800' : a.data?.condition_status === 'Desativado' ? 'bg-red-100 text-red-800' : 'bg-gray-100'}`}>{a.data?.condition_status || 'N/D'}</span></td>
                                                <td className="px-4 py-4 text-right">
                                                    <div className="flex justify-end gap-2">
                                                        {onNewIntervention && (
                                                            <button 
                                                                onClick={() => onNewIntervention(a)} 
                                                                className="text-blue-600 hover:text-blue-800 text-sm"
                                                                title="Nova interven√ß√£o"
                                                            >
                                                                Interven√ß√£o
                                                            </button>
                                                        )}
                                                        {(user?.role === 'admin' || user?.role === 'superadmin') && (
                                                            <button 
                                                                onClick={() => openStatusModal(a.serial_number)} 
                                                                className="text-orange-600 hover:text-orange-800 text-sm"
                                                                title="Alterar estado (Admin)"
                                                            >
                                                                Estado
                                                            </button>
                                                        )}
                                                        <button onClick={() => openAsset(a.serial_number)} className="text-blue-600 hover:underline text-sm">Ver</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        {totalPages > 1 && (
                            <div className="p-4 border-t flex justify-center gap-2">
                                <button onClick={() => setPage(p => Math.max(1, p-1))} disabled={page===1} className="px-3 py-1 border rounded disabled:opacity-50">Anterior</button>
                                <span className="px-3 py-1">P√°gina {page} de {totalPages}</span>
                                <button onClick={() => setPage(p => Math.min(totalPages, p+1))} disabled={page===totalPages} className="px-3 py-1 border rounded disabled:opacity-50">Seguinte</button>
                            </div>
                        )}
                    </div>
                    
                    {/* Detail Modal */}
                    {selectedAsset && !editMode && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                                <div className="p-6 border-b flex justify-between items-center">
                                    <div><h3 className="text-xl font-bold">Detalhes do Ativo</h3><p className="text-sm text-gray-500">N¬∫ S√©rie: <span className="font-mono font-medium">{selectedAsset.serial_number}</span></p></div>
                                    <button onClick={closeModal} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                                </div>
                                <div className="p-6">
                                    {Object.keys(categories).map(cat => {
                                        const fields = schema.filter(f => f.field_category === cat);
                                        if (!fields.length) return null;
                                        return (
                                            <div key={cat} className="mb-6">
                                                <h4 className="text-sm font-semibold text-gray-500 uppercase mb-3">{categories[cat]}</h4>
                                                <div className="grid grid-cols-2 gap-4">
                                                    {fields.map(f => (
                                                        <div key={f.field_name}><label className="text-xs text-gray-400">{f.field_label}</label><p>{selectedAsset.data?.[f.field_name] || '-'}</p></div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                    
                                    {/* Hist√≥rico de Altera√ß√µes de Estado */}
                                    {selectedAsset.status_history?.length > 0 && (
                                        <div className="mt-6 pt-6 border-t">
                                            <h4 className="text-sm font-semibold text-gray-500 uppercase mb-3">Hist√≥rico de Altera√ß√µes de Estado</h4>
                                            <div className="space-y-2 max-h-48 overflow-y-auto">
                                                {selectedAsset.status_history.map((h,i) => (
                                                    <div key={i} className="bg-orange-50 border border-orange-100 rounded-lg p-3">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex items-center gap-2">
                                                                <span className={`px-2 py-0.5 rounded-full text-xs ${h.previous_status === 'Operacional' ? 'bg-green-100 text-green-800' : h.previous_status === 'Manuten√ß√£o Necess√°ria' ? 'bg-yellow-100 text-yellow-800' : h.previous_status === 'Em Repara√ß√£o' ? 'bg-orange-100 text-orange-800' : h.previous_status === 'Desativado' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}`}>{h.previous_status || 'N/D'}</span>
                                                                <span className="text-gray-400">‚Üí</span>
                                                                <span className={`px-2 py-0.5 rounded-full text-xs ${h.new_status === 'Operacional' ? 'bg-green-100 text-green-800' : h.new_status === 'Manuten√ß√£o Necess√°ria' ? 'bg-yellow-100 text-yellow-800' : h.new_status === 'Em Repara√ß√£o' ? 'bg-orange-100 text-orange-800' : 'bg-red-100 text-red-800'}`}>{h.new_status}</span>
                                                            </div>
                                                            <span className="text-xs text-gray-500">{new Date(h.changed_at).toLocaleString('pt-PT')}</span>
                                                        </div>
                                                        <p className="text-sm text-gray-700">{h.description}</p>
                                                        <p className="text-xs text-gray-500 mt-1">Por: {h.changed_by_name}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Hist√≥rico de Manuten√ß√£o */}
                                    {selectedAsset.maintenance_history?.length > 0 && (
                                        <div className="mt-6 pt-6 border-t">
                                            <h4 className="text-sm font-semibold text-gray-500 uppercase mb-3">Hist√≥rico de Manuten√ß√£o</h4>
                                            {selectedAsset.maintenance_history.map((m,i) => (
                                                <div key={i} className="bg-gray-50 rounded-lg p-3 mb-2">
                                                    <div className="flex justify-between"><span className="font-medium">{m.action_type}</span><span className="text-sm text-gray-500">{new Date(m.performed_at).toLocaleDateString('pt-PT')}</span></div>
                                                    {m.description && <p className="text-sm text-gray-600 mt-1">{m.description}</p>}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="p-6 border-t flex justify-between">
                                    {user?.role !== 'visitor' ? (
                                        <button onClick={() => handleDelete(selectedAsset.serial_number)} className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg">Eliminar</button>
                                    ) : <div />}
                                    <div className="flex gap-2">
                                        {onNewIntervention && user?.role !== 'visitor' && (
                                            <button 
                                                onClick={() => { closeModal(); onNewIntervention(selectedAsset); }} 
                                                className="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg border border-blue-200"
                                            >
                                                Nova Interven√ß√£o
                                            </button>
                                        )}
                                        {(user?.role === 'admin' || user?.role === 'superadmin') && (
                                            <button onClick={() => openStatusModal(selectedAsset.serial_number)} className="px-4 py-2 text-orange-600 hover:bg-orange-50 rounded-lg border border-orange-200">Alterar Estado</button>
                                        )}
                                        {user?.role !== 'visitor' && (
                                            <button onClick={() => setEditMode(true)} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Editar</button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Form Modal */}
                    {(showForm || editMode) && <AssetForm asset={editMode ? selectedAsset : null} schema={schema} categories={categories} onClose={() => { closeModal(); loadAssets(); }} token={token} />}
                    
                    {/* Export Modal */}
                    {showExport && <ExportModal onClose={() => setShowExport(false)} token={token} />}
                    
                    {/* Backup Modal */}
                    {showBackup && <BackupModal onClose={() => setShowBackup(false)} token={token} isAdmin={(user?.role === 'admin' || user?.role === 'superadmin')} />}
                    
                    {/* Import Modal */}
                    {showImport && <ImportModal onClose={() => setShowImport(false)} token={token} onSuccess={loadAssets} />}
                    
                    {/* Status Change Modal */}
                    {showStatusModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
                                <div className="p-6 border-b flex justify-between items-center bg-gradient-to-r from-orange-500 to-orange-600">
                                    <div>
                                        <h3 className="text-xl font-bold text-white">Alterar Estado</h3>
                                        <p className="text-orange-100 text-sm">{selectedSerials.length} ativo(s) selecionado(s)</p>
                                    </div>
                                    <button onClick={closeStatusModal} className="text-white hover:text-orange-200 text-2xl">&times;</button>
                                </div>
                                
                                {!showStatusConfirm && !statusChangeResult && (
                                    <div className="p-6">
                                        {/* Lista de ativos selecionados */}
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Ativos selecionados:</label>
                                            <div className="max-h-24 overflow-y-auto bg-gray-50 rounded-lg p-2">
                                                {selectedSerials.map((sn, i) => (
                                                    <span key={i} className="inline-block bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs font-mono mr-1 mb-1">{sn}</span>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        {/* Sele√ß√£o de novo estado */}
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Novo Estado *</label>
                                            <select 
                                                value={statusChange.newStatus}
                                                onChange={(e) => setStatusChange({...statusChange, newStatus: e.target.value})}
                                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200"
                                                required
                                            >
                                                <option value="">Selecionar estado...</option>
                                                <option value="Operacional">Operacional</option>
                                                <option value="Manuten√ß√£o Necess√°ria">Manuten√ß√£o Necess√°ria</option>
                                                <option value="Em Repara√ß√£o">Em Repara√ß√£o</option>
                                                <option value="Desativado">Desativado</option>
                                            </select>
                                        </div>
                                        
                                        {/* Descri√ß√£o obrigat√≥ria */}
                                        <div className="mb-6">
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o da Altera√ß√£o *</label>
                                            <textarea 
                                                value={statusChange.description}
                                                onChange={(e) => setStatusChange({...statusChange, description: e.target.value})}
                                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200"
                                                rows={3}
                                                placeholder="Descreva o motivo da altera√ß√£o de estado..."
                                                required
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Este campo √© obrigat√≥rio e ser√° guardado no hist√≥rico do ativo.</p>
                                        </div>
                                        
                                        <div className="flex justify-end gap-3">
                                            <button 
                                                onClick={closeStatusModal}
                                                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                                            >
                                                Cancelar
                                            </button>
                                            <button 
                                                onClick={proceedToConfirm}
                                                disabled={!statusChange.newStatus || !statusChange.description.trim()}
                                                className="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                Continuar
                                            </button>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Confirma√ß√£o */}
                                {showStatusConfirm && !statusChangeResult && (
                                    <div className="p-6">
                                        <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                                            <h4 className="font-bold text-orange-800 mb-3">Confirmar Altera√ß√£o</h4>
                                            <div className="space-y-2 text-sm">
                                                <p><strong>Ativos:</strong> {selectedSerials.length} selecionado(s)</p>
                                                <p><strong>Novo Estado:</strong> <span className={`px-2 py-1 rounded-full text-xs ${statusChange.newStatus === 'Operacional' ? 'bg-green-100 text-green-800' : statusChange.newStatus === 'Manuten√ß√£o Necess√°ria' ? 'bg-yellow-100 text-yellow-800' : statusChange.newStatus === 'Em Repara√ß√£o' ? 'bg-orange-100 text-orange-800' : 'bg-red-100 text-red-800'}`}>{statusChange.newStatus}</span></p>
                                                <p><strong>Descri√ß√£o:</strong></p>
                                                <p className="bg-white p-2 rounded border text-gray-700">{statusChange.description}</p>
                                            </div>
                                        </div>
                                        
                                        <div className="flex justify-end gap-3">
                                            <button 
                                                onClick={() => setShowStatusConfirm(false)}
                                                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                                            >
                                                Voltar
                                            </button>
                                            <button 
                                                onClick={executeStatusChange}
                                                disabled={statusChangeLoading}
                                                className="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:opacity-50 flex items-center"
                                            >
                                                {statusChangeLoading ? (
                                                    <>
                                                        <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                        </svg>
                                                        A processar...
                                                    </>
                                                ) : 'Confirmar Altera√ß√£o'}
                                            </button>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Resultado */}
                                {statusChangeResult && (
                                    <div className="p-6">
                                        {statusChangeResult.error ? (
                                            <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                                                <p className="text-red-700">{statusChangeResult.error}</p>
                                            </div>
                                        ) : (
                                            <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                                <h4 className="font-bold text-green-800 mb-2">Altera√ß√£o Conclu√≠da</h4>
                                                <p className="text-green-700">{statusChangeResult.message}</p>
                                                
                                                {statusChangeResult.resultados?.sucesso?.length > 0 && (
                                                    <div className="mt-3">
                                                        <p className="text-sm font-medium text-green-700">Atualizados com sucesso:</p>
                                                        <div className="mt-1 max-h-20 overflow-y-auto">
                                                            {statusChangeResult.resultados.sucesso.map((r, i) => (
                                                                <span key={i} className="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-mono mr-1 mb-1">{r.serial_number}</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {statusChangeResult.resultados?.erros?.length > 0 && (
                                                    <div className="mt-3">
                                                        <p className="text-sm font-medium text-red-700">Erros:</p>
                                                        <div className="mt-1">
                                                            {statusChangeResult.resultados.erros.map((r, i) => (
                                                                <p key={i} className="text-xs text-red-600">{r.serial_number}: {r.erro}</p>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        
                                        <div className="flex justify-end">
                                            <button 
                                                onClick={closeStatusModal}
                                                className="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                                            >
                                                Fechar
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // ASSET FORM
        const AssetForm = ({ asset, schema, categories, onClose, token }) => {
            const [formData, setFormData] = useState(asset?.data || {});
            const [serialNumber, setSerialNumber] = useState(asset?.serial_number || '');
            const [loading, setLoading] = useState(false);
            const [loadingSerial, setLoadingSerial] = useState(false);
            const [serialError, setSerialError] = useState('');
            const [error, setError] = useState('');
            
            // Gerar n√∫mero de s√©rie automaticamente ao abrir (novo ativo)
            useEffect(() => {
                if (!asset && !serialNumber) {
                    generateSerialNumber();
                }
            }, []);
            
            const generateSerialNumber = async () => {
                setLoadingSerial(true);
                setSerialError('');
                try {
                    const data = await api.get('/config/next-number/assets', token);
                    console.log('Resposta next-number:', data);
                    if (data && data.number) {
                        setSerialNumber(data.number);
                    } else {
                        setSerialError('N√£o foi poss√≠vel gerar n√∫mero autom√°tico');
                    }
                } catch (e) {
                    console.error('Erro ao gerar n√∫mero de s√©rie:', e);
                    setSerialError('Erro ao gerar - introduza manualmente');
                }
                setLoadingSerial(false);
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!serialNumber.trim()) {
                    setError('N√∫mero de s√©rie √© obrigat√≥rio');
                    return;
                }
                setLoading(true);
                setError('');
                const payload = { data: formData };
                let result;
                if (asset) {
                    result = await api.put(`/assets/${asset.serial_number}`, payload, token);
                } else {
                    payload.serial_number = serialNumber.trim();
                    result = await api.post('/assets', payload, token);
                }
                if (result.ok) onClose();
                else setError(result.data?.error || 'Erro ao guardar ativo');
                setLoading(false);
            };
            
            const renderField = (f) => {
                const v = formData[f.field_name] || '';
                const onChange = (e) => setFormData({...formData, [f.field_name]: e.target.value});
                
                // Campo especial para refer√™ncia do produto - usar configurador
                if (f.field_name === 'product_reference') {
                    return (
                        <ReferenceConfigurator 
                            value={v}
                            onChange={(newValue, extraData) => {
                                const updates = { product_reference: newValue };
                                if (extraData) {
                                    if (extraData.associated_equipment) updates.associated_equipment = extraData.associated_equipment;
                                    if (extraData.luminaire_type) updates.luminaire_type = extraData.luminaire_type;
                                    if (extraData.height_meters) updates.height_meters = String(extraData.height_meters);
                                }
                                setFormData({...formData, ...updates});
                            }}
                            token={token}
                        />
                    );
                }
                
                if (f.field_type === 'select') return <select value={v} onChange={onChange} className="w-full px-3 py-2 border rounded-lg"><option value="">Selecionar...</option>{f.field_options?.map(o => <option key={o} value={o}>{o}</option>)}</select>;
                if (f.field_type === 'textarea') return <textarea value={v} onChange={onChange} className="w-full px-3 py-2 border rounded-lg" rows={2}/>;
                if (f.field_type === 'date') return <input type="date" value={v} onChange={onChange} className="w-full px-3 py-2 border rounded-lg"/>;
                if (f.field_type === 'number') return <input type="number" step="any" value={v} onChange={onChange} className="w-full px-3 py-2 border rounded-lg"/>;
                return <input type="text" value={v} onChange={onChange} className="w-full px-3 py-2 border rounded-lg"/>;
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                        <div className="p-6 border-b flex justify-between items-center">
                            <h3 className="text-xl font-bold">{asset ? 'Editar' : 'Novo'} Ativo</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>
                        {error && <div className="mx-6 mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">{error}</div>}
                        <form onSubmit={handleSubmit} className="p-6">
                            {!asset && (
                                <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <label className="block text-sm font-semibold text-blue-800 mb-2">
                                        üìã N√∫mero de S√©rie *
                                    </label>
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            value={serialNumber} 
                                            onChange={(e) => setSerialNumber(e.target.value)} 
                                            className={`flex-1 px-3 py-2 border rounded-lg font-mono text-lg ${serialNumber ? 'bg-white border-green-400' : 'bg-gray-50 border-gray-300'}`}
                                            required 
                                            placeholder={loadingSerial ? "A gerar automaticamente..." : "Ex: SLP000000001"}
                                            disabled={loadingSerial}
                                        />
                                        <button 
                                            type="button" 
                                            onClick={generateSerialNumber} 
                                            disabled={loadingSerial}
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
                                            title="Gerar n√∫mero autom√°tico"
                                        >
                                            {loadingSerial ? '‚è≥' : 'üîÑ'} Gerar
                                        </button>
                                    </div>
                                    {serialError && (
                                        <p className="text-red-600 text-sm mt-2">‚ö†Ô∏è {serialError}</p>
                                    )}
                                    {serialNumber && !serialError && (
                                        <p className="text-green-700 text-sm mt-2">‚úÖ N√∫mero gerado: <strong className="font-mono">{serialNumber}</strong></p>
                                    )}
                                    {!serialNumber && !loadingSerial && !serialError && (
                                        <p className="text-gray-600 text-sm mt-2">üí° Clique em "Gerar" para obter um n√∫mero autom√°tico ou introduza manualmente</p>
                                    )}
                                </div>
                            )}
                            {Object.keys(categories).map(cat => {
                                const fields = schema.filter(f => f.field_category === cat);
                                if (!fields.length) return null;
                                return (
                                    <div key={cat} className="mb-6">
                                        <h4 className="text-sm font-semibold text-gray-500 uppercase mb-3">{categories[cat]}</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            {fields.map(f => (
                                                <div key={f.field_name} className={f.field_type === 'textarea' || f.field_name === 'product_reference' ? 'col-span-2' : ''}>
                                                    <label className="block text-sm font-medium mb-1">{f.field_label}{f.required ? ' *' : ''}</label>
                                                    {renderField(f)}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                            <div className="flex justify-end gap-4 pt-4 border-t">
                                <button type="button" onClick={onClose} className="px-6 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancelar</button>
                                <button type="submit" disabled={loading || !serialNumber} className="px-6 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50 hover:bg-blue-700">
                                    {loading ? 'A guardar...' : 'Guardar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        // SCHEMA MANAGER
        const SchemaManager = () => {
            const { token, user } = useAuth();
            const [schema, setSchema] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editField, setEditField] = useState(null);
            const [newField, setNewField] = useState({ field_name: '', field_type: 'text', field_label: '', field_category: 'custom', required: false, field_options: '' });
            const [sortColumn, setSortColumn] = useState('field_name');
            const [sortDirection, setSortDirection] = useState('asc');
            
            useEffect(() => { api.get('/schema', token).then(setSchema); }, []);
            
            const handleAdd = async (e) => {
                e.preventDefault();
                const payload = {...newField};
                if (payload.field_type === 'select' && payload.field_options) payload.field_options = payload.field_options.split(',').map(o => o.trim());
                else delete payload.field_options;
                const r = await api.post('/schema', payload, token);
                if (r.ok) { setShowForm(false); setNewField({ field_name: '', field_type: 'text', field_label: '', field_category: 'custom', required: false, field_options: '' }); api.get('/schema', token).then(setSchema); }
                else alert(r.data.error);
            };
            
            const handleEdit = async (e) => {
                e.preventDefault();
                const payload = {...editField};
                if (payload.field_type === 'select' && typeof payload.field_options === 'string') {
                    payload.field_options = payload.field_options.split(',').map(o => o.trim());
                }
                const r = await api.put(`/schema/${editField.id}`, payload, token);
                if (r.ok) { 
                    setEditField(null); 
                    api.get('/schema', token).then(setSchema); 
                }
                else alert(r.error || 'Erro ao actualizar');
            };
            
            const handleDelete = async (id) => { if (confirm('Eliminar campo?')) { await api.delete(`/schema/${id}`, token); api.get('/schema', token).then(setSchema); }};
            
            const handleSort = (column) => {
                if (sortColumn === column) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortColumn(column);
                    setSortDirection('asc');
                }
            };
            
            const sortedSchema = [...schema].sort((a, b) => {
                let valA = a[sortColumn] || '';
                let valB = b[sortColumn] || '';
                const comparison = String(valA).localeCompare(String(valB), 'pt', { sensitivity: 'base' });
                return sortDirection === 'asc' ? comparison : -comparison;
            });
            
            const SortIcon = ({ column }) => {
                if (sortColumn !== column) {
                    return <svg className="w-4 h-4 text-gray-300 ml-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>;
                }
                return sortDirection === 'asc' 
                    ? <svg className="w-4 h-4 text-blue-600 ml-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>
                    : <svg className="w-4 h-4 text-blue-600 ml-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>;
            };
            
            const cats = { identification: 'Identifica√ß√£o', specifications: 'Especifica√ß√µes', installation: 'Instala√ß√£o', warranty: 'Garantia', maintenance: 'Manuten√ß√£o', equipment: 'Equipamento', other: 'Outros', custom: 'Personalizados' };
            
            return (
                <div className="p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <div><h2 className="text-2xl font-bold">Gest√£o de Campos</h2><p className="text-gray-500">Adicione e edite campos personalizados</p></div>
                        <button onClick={() => setShowForm(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                            Novo Campo
                        </button>
                    </div>
                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        <table className="w-full">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th onClick={() => handleSort('field_name')} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">Nome <SortIcon column="field_name" /></th>
                                    <th onClick={() => handleSort('field_label')} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">Label <SortIcon column="field_label" /></th>
                                    <th onClick={() => handleSort('field_type')} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">Tipo <SortIcon column="field_type" /></th>
                                    <th onClick={() => handleSort('field_category')} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">Categoria <SortIcon column="field_category" /></th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {sortedSchema.map(f => (
                                    <tr key={f.id} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 font-mono text-sm">{f.field_name}</td>
                                        <td className="px-6 py-4">{f.field_label} {f.required ? <span className="text-red-500">*</span> : ''}</td>
                                        <td className="px-6 py-4"><span className="px-2 py-1 bg-gray-100 rounded text-sm">{f.field_type}</span></td>
                                        <td className="px-6 py-4">{cats[f.field_category]}</td>
                                        <td className="px-6 py-4 text-right">
                                            <div className="flex justify-end gap-2">
                                                <button 
                                                    onClick={() => setEditField({...f, field_options: Array.isArray(f.field_options) ? f.field_options.join(', ') : f.field_options || ''})}
                                                    className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"
                                                    title="Editar"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                </button>
                                                <button 
                                                    onClick={() => handleDelete(f.id)}
                                                    className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                                                    title="Eliminar"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    {/* Modal Novo Campo */}
                    {showForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                                <div className="p-6 border-b flex justify-between items-center">
                                    <h3 className="text-xl font-bold">Novo Campo</h3>
                                    <button onClick={() => setShowForm(false)} className="text-2xl text-gray-400">&times;</button>
                                </div>
                                <form onSubmit={handleAdd} className="p-6 space-y-4">
                                    <div><label className="block text-sm font-medium mb-1">Nome t√©cnico</label><input type="text" value={newField.field_name} onChange={(e) => setNewField({...newField, field_name: e.target.value.toLowerCase().replace(/\s/g,'_')})} className="w-full px-3 py-2 border rounded-lg" required/></div>
                                    <div><label className="block text-sm font-medium mb-1">Label</label><input type="text" value={newField.field_label} onChange={(e) => setNewField({...newField, field_label: e.target.value})} className="w-full px-3 py-2 border rounded-lg" required/></div>
                                    <div><label className="block text-sm font-medium mb-1">Tipo</label><select value={newField.field_type} onChange={(e) => setNewField({...newField, field_type: e.target.value})} className="w-full px-3 py-2 border rounded-lg"><option value="text">Texto</option><option value="textarea">Texto Longo</option><option value="number">N√∫mero</option><option value="date">Data</option><option value="select">Lista</option></select></div>
                                    {newField.field_type === 'select' && <div><label className="block text-sm font-medium mb-1">Op√ß√µes (v√≠rgula)</label><input type="text" value={newField.field_options} onChange={(e) => setNewField({...newField, field_options: e.target.value})} className="w-full px-3 py-2 border rounded-lg"/></div>}
                                    <div><label className="block text-sm font-medium mb-1">Categoria</label><select value={newField.field_category} onChange={(e) => setNewField({...newField, field_category: e.target.value})} className="w-full px-3 py-2 border rounded-lg">{Object.entries(cats).map(([k,v]) => <option key={k} value={k}>{v}</option>)}</select></div>
                                    <div className="flex items-center"><input type="checkbox" checked={newField.required} onChange={(e) => setNewField({...newField, required: e.target.checked})} className="mr-2"/><label>Obrigat√≥rio</label></div>
                                    <div className="flex justify-end gap-4 pt-4"><button type="button" onClick={() => setShowForm(false)} className="px-4 py-2">Cancelar</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg">Criar</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Editar Campo */}
                    {editField && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                                <div className="p-6 border-b flex justify-between items-center bg-blue-50">
                                    <h3 className="text-xl font-bold">Editar Campo</h3>
                                    <button onClick={() => setEditField(null)} className="text-2xl text-gray-400">&times;</button>
                                </div>
                                <form onSubmit={handleEdit} className="p-6 space-y-4">
                                    <div><label className="block text-sm font-medium mb-1">Nome t√©cnico</label><input type="text" value={editField.field_name} className="w-full px-3 py-2 border rounded-lg bg-gray-100" disabled/></div>
                                    <div><label className="block text-sm font-medium mb-1">Label</label><input type="text" value={editField.field_label} onChange={(e) => setEditField({...editField, field_label: e.target.value})} className="w-full px-3 py-2 border rounded-lg" required/></div>
                                    <div><label className="block text-sm font-medium mb-1">Tipo</label><input type="text" value={editField.field_type} className="w-full px-3 py-2 border rounded-lg bg-gray-100" disabled/></div>
                                    {editField.field_type === 'select' && <div><label className="block text-sm font-medium mb-1">Op√ß√µes (v√≠rgula)</label><input type="text" value={editField.field_options} onChange={(e) => setEditField({...editField, field_options: e.target.value})} className="w-full px-3 py-2 border rounded-lg"/></div>}
                                    <div><label className="block text-sm font-medium mb-1">Categoria</label><select value={editField.field_category} onChange={(e) => setEditField({...editField, field_category: e.target.value})} className="w-full px-3 py-2 border rounded-lg">{Object.entries(cats).map(([k,v]) => <option key={k} value={k}>{v}</option>)}</select></div>
                                    <div className="flex items-center"><input type="checkbox" checked={editField.required} onChange={(e) => setEditField({...editField, required: e.target.checked ? 1 : 0})} className="mr-2"/><label>Obrigat√≥rio</label></div>
                                    <div className="flex justify-end gap-4 pt-4"><button type="button" onClick={() => setEditField(null)} className="px-4 py-2">Cancelar</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg">Guardar</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // CATALOG MANAGER
        
        // CATALOG MANAGER
        const CatalogManager = () => {
            const { token } = useAuth();
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);
            const [importing, setImporting] = useState(false);
            const [message, setMessage] = useState(null);
            const [activeTab, setActiveTab] = useState('columns');
            const [data, setData] = useState([]);
            const [dragOver, setDragOver] = useState(false);
            const [showAddForm, setShowAddForm] = useState(false);
            const [newItem, setNewItem] = useState({});
            const fileInputRef = React.useRef(null);
            
            const loadStats = async () => {
                const s = await api.get('/catalog/stats', token);
                setStats(s);
                setLoading(false);
            };
            
            useEffect(() => { loadStats(); }, [token]);
            
            const loadTabData = async (tab) => {
                setActiveTab(tab);
                setShowAddForm(false);
                setNewItem({});
                let endpoint = '';
                switch(tab) {
                    case 'columns': endpoint = '/catalog/columns'; break;
                    case 'luminaires': endpoint = '/catalog/luminaires'; break;
                    case 'electrical': endpoint = '/catalog/electrical-panels'; break;
                    case 'fuse_boxes': endpoint = '/catalog/fuse-boxes'; break;
                    case 'telemetry': endpoint = '/catalog/telemetry-panels'; break;
                    case 'ev': endpoint = '/catalog/modules/ev'; break;
                    case 'mupi': endpoint = '/catalog/modules/mupi'; break;
                    case 'lateral': endpoint = '/catalog/modules/lateral'; break;
                    case 'antenna': endpoint = '/catalog/modules/antenna'; break;
                }
                const d = await api.get(endpoint, token);
                setData(d || []);
            };
            
            useEffect(() => { if (stats) loadTabData('columns'); }, [stats]);
            
            const processFile = async (file) => {
                if (!file) return;
                if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                    setMessage({ type: 'error', text: 'Formato inv√°lido. Use ficheiros .xlsx ou .xls' });
                    return;
                }
                setImporting(true);
                setMessage(null);
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const response = await fetch('/api/catalog/import', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        setMessage({ type: 'success', text: `Cat√°logo importado! ${result.stats.columns} colunas, ${result.stats.luminaires || 0} lumin√°rias, ${result.stats.electrical} Q.E., ${result.stats.fuse_boxes || 0} cofretes, ${result.stats.telemetry} telemetria, ${result.stats.ev} EV, ${result.stats.mupi} MUPI, ${result.stats.lateral} laterais, ${result.stats.antenna} antenas.` });
                        loadStats();
                        loadTabData(activeTab);
                    } else {
                        setMessage({ type: 'error', text: result.error || 'Erro ao importar' });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Erro ao importar: ' + err.message });
                }
                setImporting(false);
                if (fileInputRef.current) fileInputRef.current.value = '';
            };
            
            const handleImport = (e) => processFile(e.target.files[0]);
            const handleDrop = (e) => { e.preventDefault(); setDragOver(false); processFile(e.dataTransfer.files[0]); };
            const handleDragOver = (e) => { e.preventDefault(); setDragOver(true); };
            const handleDragLeave = (e) => { e.preventDefault(); setDragOver(false); };
            const handleExport = () => window.open('/api/catalog/export?token=' + token, '_blank');
            
            const handleLoadDefault = async () => {
                if (!confirm('Isto ir√° carregar o cat√°logo padr√£o SmartLamppost. Continuar?')) return;
                setImporting(true);
                setMessage(null);
                try {
                    const response = await fetch('/api/catalog/load-default', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        setMessage({ type: 'success', text: `Cat√°logo padr√£o carregado! ${result.stats.columns} colunas, ${result.stats.luminaires || 0} lumin√°rias, ${result.stats.electrical} Q.E., ${result.stats.fuse_boxes || 0} cofretes, ${result.stats.telemetry} telemetria, ${result.stats.ev} EV, ${result.stats.mupi} MUPI, ${result.stats.lateral} laterais, ${result.stats.antenna} antenas.` });
                        loadStats();
                        loadTabData(activeTab);
                    } else {
                        setMessage({ type: 'error', text: result.error || 'Erro ao carregar' });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Erro ao carregar: ' + err.message });
                }
                setImporting(false);
            };
            
            const handleClearCatalog = async () => {
                if (!confirm('‚ö†Ô∏è¬è ATEN√ç‚Ä°√ç∆íO: Isto ir√° APAGAR TODO o cat√°logo! Esta a√ß√£o n√£o pode ser revertida. Continuar?')) return;
                if (!confirm('Tem a certeza ABSOLUTA? Todos os dados do cat√°logo ser√£o perdidos.')) return;
                try {
                    const response = await fetch('/api/catalog/clear', {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result.success) {
                        setMessage({ type: 'success', text: 'Cat√°logo limpo com sucesso' });
                        loadStats();
                        setData([]);
                    } else {
                        setMessage({ type: 'error', text: result.error });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Erro ao limpar: ' + err.message });
                }
            };
            
            const handleAddItem = async () => {
                if (!newItem.reference) {
                    setMessage({ type: 'error', text: 'Refer√™ncia √© obrigat√≥ria' });
                    return;
                }
                try {
                    const response = await fetch(`/api/catalog/item/${activeTab}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(newItem)
                    });
                    const result = await response.json();
                    if (result.success) {
                        setMessage({ type: 'success', text: 'Item adicionado com sucesso' });
                        setShowAddForm(false);
                        setNewItem({});
                        loadStats();
                        loadTabData(activeTab);
                    } else {
                        setMessage({ type: 'error', text: result.error });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Erro ao adicionar: ' + err.message });
                }
            };
            
            const handleDeleteItem = async (id) => {
                if (!confirm('Remover este item do cat√°logo?')) return;
                try {
                    const response = await fetch(`/api/catalog/item/${activeTab}/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    if (result.success) {
                        setMessage({ type: 'success', text: 'Item removido' });
                        loadStats();
                        loadTabData(activeTab);
                    } else {
                        setMessage({ type: 'error', text: result.error });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Erro ao remover: ' + err.message });
                }
            };
            
            if (loading) return <div className="p-8 text-center">A carregar...</div>;
            
            const hasCatalog = stats && stats.columns > 0;
            const tabs = [
                { id: 'columns', label: 'üèî√Ø¬∏¬è Colunas', count: stats?.columns },
                { id: 'luminaires', label: 'üí° Lumin√°rias', count: stats?.luminaires },
                { id: 'electrical', label: '‚ö° Q. El√©tricos', count: stats?.electrical },
                { id: 'fuse_boxes', label: 'üîí Cofretes', count: stats?.fuse_boxes },
                { id: 'telemetry', label: 'üì° Telemetria', count: stats?.telemetry },
                { id: 'ev', label: 'üîõ EV Charger', count: stats?.ev },
                { id: 'mupi', label: 'üì∫ MUPI', count: stats?.mupi },
                { id: 'lateral', label: 'üóëÔ∏è¬è Laterais', count: stats?.lateral },
                { id: 'antenna', label: 'üì∂ Antenas', count: stats?.antenna },
            ];
            
            // Formul√°rio de adicionar item baseado na tab activa
            const renderAddForm = () => {
                if (activeTab === 'columns') {
                    return (<div className="grid grid-cols-4 gap-3">
                        <input placeholder="Pack *" value={newItem.pack||''} onChange={e=>setNewItem({...newItem,pack:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Refer√™ncia *" value={newItem.reference||''} onChange={e=>setNewItem({...newItem,reference:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input type="number" placeholder="Altura (m)" value={newItem.height_m||''} onChange={e=>setNewItem({...newItem,height_m:parseInt(e.target.value)||0})} className="px-3 py-2 border rounded"/>
                        <input type="number" placeholder="Bra√ßos" value={newItem.arm_count||''} onChange={e=>setNewItem({...newItem,arm_count:parseInt(e.target.value)||0})} className="px-3 py-2 border rounded"/>
                        <select value={newItem.luminaire_included||'N√£o'} onChange={e=>setNewItem({...newItem,luminaire_included:e.target.value})} className="px-3 py-2 border rounded">
                            <option value="N√£o">Lum. Inclu√≠da: N√£o</option><option value="Sim">Lum. Inclu√≠da: Sim</option>
                        </select>
                        <select value={newItem.mod2_electrical||'N√£o'} onChange={e=>setNewItem({...newItem,mod2_electrical:e.target.value})} className="px-3 py-2 border rounded">
                            <option value="N√£o">‚ö° Q.E.: N√£o</option><option value="Sim">‚ö° Q.E.: Sim</option>
                        </select>
                        <select value={newItem.mod4_telemetry||'N√£o'} onChange={e=>setNewItem({...newItem,mod4_telemetry:e.target.value})} className="px-3 py-2 border rounded">
                            <option value="N√£o">üì° Tel.: N√£o</option><option value="Sim">üì° Tel.: Sim</option>
                        </select>
                        <select value={newItem.mod5_ev||'N√£o'} onChange={e=>setNewItem({...newItem,mod5_ev:e.target.value})} className="px-3 py-2 border rounded">
                            <option value="N√£o">üîõ EV: N√£o</option><option value="Sim">üîõ EV: Sim</option>
                        </select>
                    </div>);
                }
                if (activeTab === 'luminaires') {
                    return (<div className="grid grid-cols-4 gap-3">
                        <input placeholder="Tipo (Bra√ßo/Topo)" value={newItem.luminaire_type||''} onChange={e=>setNewItem({...newItem,luminaire_type:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Refer√™ncia *" value={newItem.reference||''} onChange={e=>setNewItem({...newItem,reference:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Ref. Fabricante" value={newItem.manufacturer_ref||''} onChange={e=>setNewItem({...newItem,manufacturer_ref:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input type="number" placeholder="Altura Coluna (m)" value={newItem.column_height_m||''} onChange={e=>setNewItem({...newItem,column_height_m:parseInt(e.target.value)||0})} className="px-3 py-2 border rounded"/>
                        <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={newItem.type_1||false} onChange={e=>setNewItem({...newItem,type_1:e.target.checked})}/> Tipo 1 (Bra√ßo)</label>
                        <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={newItem.type_2||false} onChange={e=>setNewItem({...newItem,type_2:e.target.checked})}/> Tipo 2 (Topo)</label>
                    </div>);
                }
                if (activeTab === 'fuse_boxes') {
                    return (<div className="grid grid-cols-4 gap-3">
                        <input placeholder="Tipo" value={newItem.fuse_type||''} onChange={e=>setNewItem({...newItem,fuse_type:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Refer√™ncia *" value={newItem.reference||''} onChange={e=>setNewItem({...newItem,reference:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Ref. Curta (auto)" value={newItem.short_reference||''} onChange={e=>setNewItem({...newItem,short_reference:e.target.value})} className="px-3 py-2 border rounded"/>
                        <div className="flex gap-4">
                            <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={newItem.type_s||false} onChange={e=>setNewItem({...newItem,type_s:e.target.checked})}/> Tipo S</label>
                            <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={newItem.type_d||false} onChange={e=>setNewItem({...newItem,type_d:e.target.checked})}/> Tipo D</label>
                        </div>
                    </div>);
                }
                if (activeTab === 'electrical' || activeTab === 'telemetry') {
                    return (<div className="grid grid-cols-3 gap-3">
                        <input placeholder="Tipo" value={newItem.panel_type||''} onChange={e=>setNewItem({...newItem,panel_type:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Refer√™ncia *" value={newItem.reference||''} onChange={e=>setNewItem({...newItem,reference:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Ref. Curta (auto)" value={newItem.short_reference||''} onChange={e=>setNewItem({...newItem,short_reference:e.target.value})} className="px-3 py-2 border rounded"/>
                    </div>);
                }
                if (activeTab === 'ev' || activeTab === 'mupi' || activeTab === 'lateral') {
                    return (<div className="grid grid-cols-3 gap-3">
                        <input placeholder="Tipo" value={newItem.module_type||''} onChange={e=>setNewItem({...newItem,module_type:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Refer√™ncia *" value={newItem.reference||''} onChange={e=>setNewItem({...newItem,reference:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Ref. Curta (auto)" value={newItem.short_reference||''} onChange={e=>setNewItem({...newItem,short_reference:e.target.value})} className="px-3 py-2 border rounded"/>
                    </div>);
                }
                if (activeTab === 'antenna') {
                    return (<div className="grid grid-cols-4 gap-3">
                        <input placeholder="Tipo" value={newItem.module_type||''} onChange={e=>setNewItem({...newItem,module_type:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Refer√™ncia *" value={newItem.reference||''} onChange={e=>setNewItem({...newItem,reference:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input placeholder="Ref. Curta (auto)" value={newItem.short_reference||''} onChange={e=>setNewItem({...newItem,short_reference:e.target.value})} className="px-3 py-2 border rounded"/>
                        <input type="number" placeholder="Altura Coluna (m)" value={newItem.column_height_m||''} onChange={e=>setNewItem({...newItem,column_height_m:parseInt(e.target.value)||0})} className="px-3 py-2 border rounded"/>
                    </div>);
                }
            };
            
            return (
                <div className="p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">üì¶ Cat√°logo de Refer√™ncias</h2>
                        <div className="flex gap-2 flex-wrap">
                            <input type="file" ref={fileInputRef} accept=".xlsx,.xls" onChange={handleImport} className="hidden"/>
                            {hasCatalog && <>
                                <button onClick={handleExport} className="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">üì• Exportar</button>
                                <button onClick={handleClearCatalog} className="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">üóëÔ∏è¬è Limpar</button>
                            </>}
                            <button onClick={handleLoadDefault} disabled={importing} className="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 text-sm">
                                {importing ? '...' : '‚ö° Padr√£o'}
                            </button>
                            <button onClick={() => fileInputRef.current?.click()} disabled={importing} className="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm">
                                üì§ Importar
                            </button>
                        </div>
                    </div>
                    
                    <div onDrop={handleDrop} onDragOver={handleDragOver} onDragLeave={handleDragLeave} onClick={() => fileInputRef.current?.click()}
                        className={`mb-6 border-2 border-dashed rounded-xl p-6 text-center cursor-pointer transition-all ${dragOver ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400 hover:bg-gray-50'} ${importing ? 'opacity-50 pointer-events-none' : ''}`}>
                        {importing ? (
                            <div className="flex items-center justify-center gap-3">
                                <svg className="animate-spin h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <span className="text-blue-600">A processar...</span>
                            </div>
                        ) : (<><span className="text-3xl">üìÅ</span><p className="text-gray-600 text-sm mt-1">Arraste o Excel aqui ou clique para selecionar</p></>)}
                    </div>
                    
                    {message && <div className={`mb-4 p-3 rounded-lg text-sm ${message.type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' : 'bg-red-50 border border-red-200 text-red-700'}`}>{message.text}</div>}
                    
                    {!hasCatalog ? (
                        <div className="bg-amber-50 border border-amber-200 rounded-xl p-8 text-center">
                            <div className="text-5xl mb-4">üìõ</div>
                            <h3 className="text-lg font-bold text-amber-800 mb-2">Cat√°logo Vazio</h3>
                            <p className="text-amber-700 mb-4 text-sm">Importe o ficheiro Excel ou carregue o cat√°logo padr√£o.</p>
                            <button onClick={handleLoadDefault} disabled={importing} className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 font-medium">
                                ‚ö° Carregar Cat√°logo Padr√£o SmartLamppost
                            </button>
                        </div>
                    ) : (
                        <div className="bg-white rounded-xl shadow-md">
                            <div className="border-b flex overflow-x-auto">
                                {tabs.map(tab => (<button key={tab.id} onClick={() => loadTabData(tab.id)} className={`px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition ${activeTab === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>{tab.label} <span className="ml-1 text-xs bg-gray-100 px-2 py-0.5 rounded-full">{tab.count}</span></button>))}
                            </div>
                            
                            {/* Bot√£o Adicionar e Formul√°rio */}
                            <div className="p-3 border-b bg-gray-50">
                                {!showAddForm ? (
                                    <button onClick={() => setShowAddForm(true)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">√¢≈æ‚Ä¢ Adicionar Item</button>
                                ) : (
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center">
                                            <span className="font-medium text-sm">Novo Item:</span>
                                            <button onClick={() => {setShowAddForm(false); setNewItem({});}} className="text-gray-500 hover:text-gray-700">√¢≈ì‚Ä¢</button>
                                        </div>
                                        {renderAddForm()}
                                        <div className="flex gap-2">
                                            <button onClick={handleAddItem} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">‚úî Guardar</button>
                                            <button onClick={() => {setShowAddForm(false); setNewItem({});}} className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 text-sm">Cancelar</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            <div className="p-4">
                                <div className="overflow-x-auto max-h-96 overflow-y-auto">
                                    <table className="w-full text-sm">
                                        <thead className="sticky top-0 bg-white">
                                            <tr className="text-left text-gray-500 border-b">
                                                {activeTab === 'columns' && <><th className="pb-2">Pack</th><th className="pb-2">Refer√™ncia</th><th className="pb-2">Altura</th><th className="pb-2">Bra√ßos</th><th className="pb-2">üí° Lum. Inc.</th><th className="pb-2">‚ö° Q.E.</th><th className="pb-2">üì° Tel.</th><th className="pb-2">M√≥dulos</th><th className="pb-2"></th></>}
                                                {activeTab === 'luminaires' && <><th className="pb-2">Tipo</th><th className="pb-2">Refer√™ncia</th><th className="pb-2">Ref. Fabricante</th><th className="pb-2">Altura</th><th className="pb-2">Tipo 1</th><th className="pb-2">Tipo 2</th><th className="pb-2"></th></>}
                                                {activeTab === 'fuse_boxes' && <><th className="pb-2">Tipo</th><th className="pb-2">Refer√™ncia</th><th className="pb-2">Ref. Curta</th><th className="pb-2">Tipo S</th><th className="pb-2">Tipo D</th><th className="pb-2"></th></>}
                                                {(activeTab === 'electrical' || activeTab === 'telemetry') && <><th className="pb-2">Tipo</th><th className="pb-2">Ref. Original</th><th className="pb-2">Ref. Curta</th><th className="pb-2"></th></>}
                                                {(activeTab === 'ev' || activeTab === 'mupi' || activeTab === 'lateral') && <><th className="pb-2">Tipo</th><th className="pb-2">Ref. Original</th><th className="pb-2">Ref. Curta</th><th className="pb-2"></th></>}
                                                {activeTab === 'antenna' && <><th className="pb-2">Tipo</th><th className="pb-2">Ref. Original</th><th className="pb-2">Ref. Curta</th><th className="pb-2">Altura</th><th className="pb-2"></th></>}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.map((item, i) => (
                                                <tr key={item.id || i} className="border-b hover:bg-gray-50">
                                                    {activeTab === 'columns' && <><td className="py-2"><span className="px-2 py-1 bg-gray-100 rounded text-xs">{item.pack}</span></td><td className="py-2 font-mono text-xs">{item.reference}</td><td className="py-2">{item.height_m}m</td><td className="py-2">{item.arm_count}</td><td className="py-2">{item.luminaire_included === 'Sim' ? '√¢≈ì‚Ä¶' : '√¢‚Ç¨‚Äù'}</td><td className="py-2">{item.mod2_electrical === 'Sim' ? '√¢≈ì‚Ä¶' : '√¢‚Ç¨‚Äù'}</td><td className="py-2">{item.mod4_telemetry === 'Sim' ? '√¢≈ì‚Ä¶' : '√¢‚Ç¨‚Äù'}</td><td className="py-2 text-xs">{item.mod5_ev === 'Sim' ? 'üîõ' : ''}{item.mod6_mupi === 'Sim' ? 'üì∫' : ''}{item.mod7_lateral === 'Sim' ? 'üóëÔ∏è¬è' : ''}{item.mod8_antenna === 'Sim' ? 'üì∂' : ''}</td><td className="py-2"><button onClick={() => handleDeleteItem(item.id)} className="text-red-500 hover:text-red-700 text-xs">üóëÔ∏è¬è</button></td></>}
                                                    {activeTab === 'luminaires' && <><td className="py-2">{item.luminaire_type}</td><td className="py-2 font-mono text-xs">{item.reference}</td><td className="py-2 font-mono text-xs text-gray-500">{item.manufacturer_ref}</td><td className="py-2">{item.column_height_m}m</td><td className="py-2">{item.type_1 ? '√¢≈ì‚Ä¶' : '√¢‚Ç¨‚Äù'}</td><td className="py-2">{item.type_2 ? '√¢≈ì‚Ä¶' : '√¢‚Ç¨‚Äù'}</td><td className="py-2"><button onClick={() => handleDeleteItem(item.id)} className="text-red-500 hover:text-red-700 text-xs">üóëÔ∏è¬è</button></td></>}
                                                    {activeTab === 'fuse_boxes' && <><td className="py-2">{item.fuse_type}</td><td className="py-2 font-mono text-xs">{item.reference}</td><td className="py-2 font-mono text-xs font-bold text-blue-600">{item.short_reference}</td><td className="py-2">{item.type_s ? '√¢≈ì‚Ä¶' : '√¢‚Ç¨‚Äù'}</td><td className="py-2">{item.type_d ? '√¢≈ì‚Ä¶' : '√¢‚Ç¨‚Äù'}</td><td className="py-2"><button onClick={() => handleDeleteItem(item.id)} className="text-red-500 hover:text-red-700 text-xs">üóëÔ∏è¬è</button></td></>}
                                                    {(activeTab === 'electrical' || activeTab === 'telemetry') && <><td className="py-2">{item.panel_type}</td><td className="py-2 font-mono text-xs">{item.reference}</td><td className="py-2 font-mono text-xs font-bold text-blue-600">{item.short_reference}</td><td className="py-2"><button onClick={() => handleDeleteItem(item.id)} className="text-red-500 hover:text-red-700 text-xs">üóëÔ∏è¬è</button></td></>}
                                                    {(activeTab === 'ev' || activeTab === 'mupi' || activeTab === 'lateral') && <><td className="py-2">{item.module_type}</td><td className="py-2 font-mono text-xs">{item.reference}</td><td className="py-2 font-mono text-xs font-bold text-blue-600">{item.short_reference}</td><td className="py-2"><button onClick={() => handleDeleteItem(item.id)} className="text-red-500 hover:text-red-700 text-xs">üóëÔ∏è¬è</button></td></>}
                                                    {activeTab === 'antenna' && <><td className="py-2">{item.module_type}</td><td className="py-2 font-mono text-xs">{item.reference}</td><td className="py-2 font-mono text-xs font-bold text-blue-600">{item.short_reference}</td><td className="py-2">{item.column_height_m}m</td><td className="py-2"><button onClick={() => handleDeleteItem(item.id)} className="text-red-500 hover:text-red-700 text-xs">üóëÔ∏è¬è</button></td></>}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                {data.length === 0 && <div className="text-center py-8 text-gray-400">Sem dados nesta categoria</div>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // USERS MANAGER
        const UsersManager = () => {
            const { token, user: currentUser } = useAuth();
            const [users, setUsers] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editUser, setEditUser] = useState(null);
            const [newUser, setNewUser] = useState({ password: '', role: 'user', first_name: '', last_name: '', email: '' });
            const [formErrors, setFormErrors] = useState({});
            
            useEffect(() => { api.get('/users', token).then(setUsers); }, []);
            
            const validateForm = (data, isEdit = false) => {
                const errors = {};
                if (!isEdit && !data.password) errors.password = 'Obrigat√≥rio';
                if (!data.first_name) errors.first_name = 'Obrigat√≥rio';
                if (!data.last_name) errors.last_name = 'Obrigat√≥rio';
                if (!data.email) errors.email = 'Obrigat√≥rio';
                setFormErrors(errors);
                return Object.keys(errors).length === 0;
            };
            
            const handleAdd = async (e) => {
                e.preventDefault();
                if (!validateForm(newUser)) return;
                const r = await api.post('/users', newUser, token);
                if (r.ok) { 
                    setShowForm(false); 
                    setNewUser({ password: '', role: 'user', first_name: '', last_name: '', email: '' }); 
                    setFormErrors({});
                    api.get('/users', token).then(setUsers); 
                }
                else alert(r.error || r.data?.error || 'Erro ao criar utilizador');
            };
            
            const handleEdit = async (e) => {
                e.preventDefault();
                if (!validateForm(editUser, true)) return;
                const r = await api.put(`/users/${editUser.id}`, editUser, token);
                if (r.ok) { 
                    setEditUser(null); 
                    setFormErrors({});
                    api.get('/users', token).then(setUsers); 
                }
                else alert(r.error || 'Erro ao actualizar');
            };
            
            const handleDelete = async (id) => { 
                if (confirm('Eliminar utilizador?')) { 
                    await api.delete(`/users/${id}`, token); 
                    api.get('/users', token).then(setUsers); 
                }
            };
            
            const getRoleBadge = (role) => {
                switch(role) {
                    case 'superadmin': return 'bg-red-100 text-red-800';
                    case 'admin': return 'bg-purple-100 text-purple-800';
                    case 'user': return 'bg-blue-100 text-blue-800';
                    case 'operator': return 'bg-blue-100 text-blue-800';
                    case 'visitor': return 'bg-gray-100 text-gray-800';
                    default: return 'bg-gray-100';
                }
            };
            
            const getRoleLabel = (role) => {
                switch(role) {
                    case 'superadmin': return 'Super Admin';
                    case 'admin': return 'Administrador';
                    case 'user': return 'Utilizador';
                    case 'operator': return 'Operador';
                    case 'visitor': return 'Visita';
                    default: return role;
                }
            };
            
            return (
                <div className="p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-2xl font-bold">Utilizadores</h2>
                            <p className="text-gray-500 text-sm">Gest√£o de utilizadores do sistema</p>
                        </div>
                        <button onClick={() => { setShowForm(true); setFormErrors({}); }} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                            Novo Utilizador
                        </button>
                    </div>
                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        <table className="w-full">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Criado</th>
                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {users.map(u => (
                                    <tr key={u.id} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 font-medium">{u.email}</td>
                                        <td className="px-6 py-4">{u.first_name} {u.last_name}</td>
                                        <td className="px-6 py-4"><span className={`px-2 py-1 rounded text-sm ${getRoleBadge(u.role)}`}>{getRoleLabel(u.role)}</span></td>
                                        <td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs ${u.active !== 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{u.active !== 0 ? 'Ativo' : 'Inativo'}</span></td>
                                        <td className="px-6 py-4 text-sm text-gray-500">{new Date(u.created_at).toLocaleDateString('pt-PT')}</td>
                                        <td className="px-6 py-4 text-right">
                                            <div className="flex justify-end gap-2">
                                                <button 
                                                    onClick={() => { setEditUser({...u, password: ''}); setFormErrors({}); }}
                                                    className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"
                                                    title="Editar"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                                </button>
                                                {u.id !== currentUser.id && (
                                                    <button 
                                                        onClick={() => handleDelete(u.id)}
                                                        className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                                                        title="Eliminar"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    {/* Modal Novo Utilizador */}
                    {showForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                                <div className="p-6 border-b flex justify-between items-center"><h3 className="text-xl font-bold">Novo Utilizador</h3><button onClick={() => setShowForm(false)} className="text-2xl text-gray-400">&times;</button></div>
                                <form onSubmit={handleAdd} className="p-6 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Nome *</label>
                                            <input type="text" value={newUser.first_name} onChange={(e) => setNewUser({...newUser, first_name: e.target.value})} className={`w-full px-3 py-2 border rounded-lg ${formErrors.first_name ? 'border-red-300' : ''}`}/>
                                            {formErrors.first_name && <span className="text-red-500 text-xs">{formErrors.first_name}</span>}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Apelido *</label>
                                            <input type="text" value={newUser.last_name} onChange={(e) => setNewUser({...newUser, last_name: e.target.value})} className={`w-full px-3 py-2 border rounded-lg ${formErrors.last_name ? 'border-red-300' : ''}`}/>
                                            {formErrors.last_name && <span className="text-red-500 text-xs">{formErrors.last_name}</span>}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Email da Empresa *</label>
                                        <input type="email" value={newUser.email} onChange={(e) => setNewUser({...newUser, email: e.target.value})} className={`w-full px-3 py-2 border rounded-lg ${formErrors.email ? 'border-red-300' : ''}`} placeholder="utilizador@empresa.pt"/>
                                        {formErrors.email && <span className="text-red-500 text-xs">{formErrors.email}</span>}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Password *</label>
                                        <input type="password" value={newUser.password} onChange={(e) => setNewUser({...newUser, password: e.target.value})} className={`w-full px-3 py-2 border rounded-lg ${formErrors.password ? 'border-red-300' : ''}`}/>
                                        {formErrors.password && <span className="text-red-500 text-xs">{formErrors.password}</span>}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Tipo de Utilizador</label>
                                        <select value={newUser.role} onChange={(e) => setNewUser({...newUser, role: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                            <option value="user">Utilizador</option>
                                            <option value="admin">Administrador</option>
                                            {currentUser?.role === 'superadmin' && <option value="superadmin">Super Admin</option>}
                                        </select>
                                    </div>
                                    <div className="flex justify-end gap-4 pt-4"><button type="button" onClick={() => setShowForm(false)} className="px-4 py-2">Cancelar</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg">Criar</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Editar Utilizador */}
                    {editUser && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                                <div className="p-6 border-b flex justify-between items-center bg-blue-50"><h3 className="text-xl font-bold">Editar Utilizador</h3><button onClick={() => setEditUser(null)} className="text-2xl text-gray-400">&times;</button></div>
                                <form onSubmit={handleEdit} className="p-6 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Nome *</label>
                                            <input type="text" value={editUser.first_name || ''} onChange={(e) => setEditUser({...editUser, first_name: e.target.value})} className={`w-full px-3 py-2 border rounded-lg ${formErrors.first_name ? 'border-red-300' : ''}`}/>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Apelido *</label>
                                            <input type="text" value={editUser.last_name || ''} onChange={(e) => setEditUser({...editUser, last_name: e.target.value})} className={`w-full px-3 py-2 border rounded-lg ${formErrors.last_name ? 'border-red-300' : ''}`}/>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Email da Empresa *</label>
                                        <input type="email" value={editUser.email || ''} onChange={(e) => setEditUser({...editUser, email: e.target.value})} className={`w-full px-3 py-2 border rounded-lg ${formErrors.email ? 'border-red-300' : ''}`}/>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Username</label>
                                        <input type="text" value={editUser.username} className="w-full px-3 py-2 border rounded-lg bg-gray-100" disabled/>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Nova Password (deixar vazio para manter)</label>
                                        <input type="password" value={editUser.password || ''} onChange={(e) => setEditUser({...editUser, password: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Tipo de Utilizador</label>
                                        <select value={editUser.role} onChange={(e) => setEditUser({...editUser, role: e.target.value})} className="w-full px-3 py-2 border rounded-lg" disabled={editUser.id === currentUser.id}>
                                            <option value="user">Utilizador</option>
                                            <option value="admin">Administrador</option>
                                            {currentUser?.role === 'superadmin' && <option value="superadmin">Super Admin</option>}
                                        </select>
                                        {editUser.id === currentUser.id && <p className="text-xs text-gray-500 mt-1">N√£o pode alterar o seu pr√≥prio tipo</p>}
                                    </div>
                                    <div className="flex justify-end gap-4 pt-4"><button type="button" onClick={() => setEditUser(null)} className="px-4 py-2">Cancelar</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg">Guardar</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // =============================================================================
        // INTERVENTIONS LIST - Sistema de Interven√ß√µes
        // =============================================================================
        
        const InterventionsList = ({ preSelectedAsset, clearPreSelected }) => {
            const { token, user } = useAuth();
            const [interventions, setInterventions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [page, setPage] = useState(1);
            const [totalPages, setTotalPages] = useState(1);
            const [filters, setFilters] = useState({ status: '', type: '' });
            const [showNewModal, setShowNewModal] = useState(false);
            const [showDetailModal, setShowDetailModal] = useState(null);
            const [assets, setAssets] = useState([]);
            const [technicians, setTechnicians] = useState([]);
            const [externalTechs, setExternalTechs] = useState([]);
            
            // Estados do formul√°rio de nova interven√ß√£o
            const [newIntervention, setNewIntervention] = useState({
                serial_number: '',
                intervention_type: '',
                problem_description: '',
                solution_description: '',
                parts_used: '',
                duration_hours: '',
                notes: '',
                internal_technicians: [],
                external_technicians: [],
                set_status_em_reparacao: true
            });
            const [formErrors, setFormErrors] = useState({});
            const [saving, setSaving] = useState(false);
            
            // Estados para upload de ficheiros
            const [uploadingFile, setUploadingFile] = useState(false);
            const [fileCategory, setFileCategory] = useState('outros');
            const [fileDescription, setFileDescription] = useState('');
            const [fileCost, setFileCost] = useState('');
            
            // Estados para conclus√£o de interven√ß√£o
            const [showCompleteModal, setShowCompleteModal] = useState(null);
            const [completeData, setCompleteData] = useState({ final_status: '', status_description: '', solution_description: '' });
            
            // Estados para actualiza√ß√£o de interven√ß√£o
            const [showUpdateModal, setShowUpdateModal] = useState(null);
            const [updateData, setUpdateData] = useState({ solution_description: '', notes: '', time_hours: '', time_minutes: '' });
            const [updateSaving, setUpdateSaving] = useState(false);
            
            // Estados para t√©cnico externo
            const [showNewTechModal, setShowNewTechModal] = useState(false);
            const [newTech, setNewTech] = useState({ name: '', company: '', phone: '', email: '' });
            const [extTechCompanyFilter, setExtTechCompanyFilter] = useState('');
            
            // Obter lista √∫nica de empresas
            const uniqueCompanies = [...new Set(externalTechs.map(t => t.company))].sort();
            
            const interventionTypes = ['Manuten√ß√£o Preventiva', 'Manuten√ß√£o Corretiva', 'Inspe√ß√£o', 'Substitui√ß√£o de Componente'];
            const fileCategories = [
                { value: 'antes', label: 'Foto Antes' },
                { value: 'durante', label: 'Foto Durante' },
                { value: 'depois', label: 'Foto Depois' },
                { value: 'fatura', label: 'Fatura/Recibo' },
                { value: 'outros', label: 'Outros' }
            ];
            
            const loadInterventions = async () => {
                setLoading(true);
                try {
                    let url = `/interventions?page=${page}`;
                    if (filters.status) url += `&status=${filters.status}`;
                    if (filters.type) url += `&type=${encodeURIComponent(filters.type)}`;
                    const data = await api.get(url, token);
                    setInterventions(data.interventions || []);
                    setTotalPages(data.pages || 1);
                } catch (err) {
                    console.error('Erro ao carregar interven√ß√µes:', err);
                }
                setLoading(false);
            };
            
            const loadAssets = async () => {
                try {
                    const data = await api.get('/assets?per_page=1000', token);
                    setAssets(data.assets || []);
                } catch (err) {}
            };
            
            const loadTechnicians = async () => {
                try {
                    const [users, external] = await Promise.all([
                        api.get('/users/technicians', token),
                        api.get('/external-technicians', token)
                    ]);
                    setTechnicians(users || []);
                    setExternalTechs(external || []);
                } catch (err) {}
            };
            
            useEffect(() => { loadInterventions(); }, [page, filters, token]);
            useEffect(() => { loadAssets(); loadTechnicians(); }, [token]);
            
            // Se h√° ativo pr√©-selecionado, abrir modal
            useEffect(() => {
                if (preSelectedAsset) {
                    setNewIntervention(prev => ({ ...prev, serial_number: preSelectedAsset.serial_number }));
                    setShowNewModal(true);
                    clearPreSelected();
                }
            }, [preSelectedAsset]);
            
            const resetForm = () => {
                setNewIntervention({
                    serial_number: '',
                    intervention_type: '',
                    problem_description: '',
                    solution_description: '',
                    parts_used: '',
                    duration_hours: '',
                    notes: '',
                    internal_technicians: [],
                    external_technicians: [],
                    set_status_em_reparacao: true
                });
                setFormErrors({});
            };
            
            const validateForm = () => {
                const errors = {};
                if (!newIntervention.serial_number) errors.serial_number = 'Selecione um ativo';
                if (!newIntervention.intervention_type) errors.intervention_type = 'Selecione o tipo';
                if (!newIntervention.parts_used) errors.parts_used = 'Campo obrigat√≥rio';
                if (!newIntervention.duration_hours) errors.duration_hours = 'Campo obrigat√≥rio';
                
                // Valida√ß√µes condicionais
                const tipo = newIntervention.intervention_type;
                if (tipo && tipo !== 'Manuten√ß√£o Preventiva' && !newIntervention.problem_description) {
                    errors.problem_description = 'Obrigat√≥rio para este tipo';
                }
                if (tipo === 'Manuten√ß√£o Corretiva' && !newIntervention.solution_description) {
                    errors.solution_description = 'Obrigat√≥rio para Manuten√ß√£o Corretiva';
                }
                
                setFormErrors(errors);
                return Object.keys(errors).length === 0;
            };
            
            const handleSubmit = async () => {
                if (!validateForm()) return;
                
                setSaving(true);
                try {
                    const result = await api.post('/interventions', newIntervention, token);
                    if (result.ok) {
                        setShowNewModal(false);
                        resetForm();
                        loadInterventions();
                        // Se criou, perguntar se quer adicionar ficheiros
                        if (result.data && result.data.id) {
                            const addFiles = confirm('Interven√ß√£o criada! Deseja adicionar ficheiros (fotos/faturas)?');
                            if (addFiles) {
                                const detail = await api.get(`/interventions/${result.data.id}`, token);
                                setShowDetailModal(detail);
                            }
                        }
                    } else {
                        alert(result.data?.error || 'Erro ao criar interven√ß√£o');
                    }
                } catch (err) {
                    alert('Erro ao criar interven√ß√£o: ' + err.message);
                }
                setSaving(false);
            };
            
            const handleFileUpload = async (e, interventionId) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.size > 3 * 1024 * 1024) {
                    alert('Ficheiro muito grande. M√°ximo: 3MB');
                    return;
                }
                
                setUploadingFile(true);
                const formData = new FormData();
                formData.append('file', file);
                formData.append('category', fileCategory);
                formData.append('description', fileDescription);
                if (fileCost && fileCategory === 'fatura') formData.append('cost_value', fileCost);
                
                try {
                    const response = await fetch(`${API_BASE}/interventions/${interventionId}/files`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    const result = await response.json();
                    if (response.ok) {
                        // Recarregar detalhes
                        const detail = await api.get(`/interventions/${interventionId}`, token);
                        setShowDetailModal(detail);
                        setFileDescription('');
                        setFileCost('');
                    } else {
                        alert(result.error || 'Erro ao enviar ficheiro');
                    }
                } catch (err) {
                    console.error('Erro upload:', err);
                    alert('Erro ao enviar ficheiro: ' + err.message);
                }
                setUploadingFile(false);
                e.target.value = '';
            };
            
            const handleComplete = async () => {
                if (!showCompleteModal) return;
                
                try {
                    const result = await api.post(`/interventions/${showCompleteModal.id}/complete`, completeData, token);
                    if (result.ok) {
                        setShowCompleteModal(null);
                        setCompleteData({ final_status: '', status_description: '', solution_description: '' });
                        loadInterventions();
                        if (showDetailModal) {
                            const detail = await api.get(`/interventions/${showCompleteModal.id}`, token);
                            setShowDetailModal(detail);
                        }
                    } else {
                        alert(result.data?.error || 'Erro ao concluir');
                    }
                } catch (err) {
                    alert('Erro ao concluir interven√ß√£o');
                }
            };
            
            const handleUpdate = async () => {
                if (!showUpdateModal) return;
                
                setUpdateSaving(true);
                try {
                    // Converter tempo HH:MM para decimal
                    const hours = parseInt(updateData.time_hours) || 0;
                    const minutes = parseInt(updateData.time_minutes) || 0;
                    const timeDecimal = hours + (minutes / 60);
                    const timeFormatted = `${hours}:${minutes.toString().padStart(2, '0')}`;
                    
                    const payload = {
                        ...updateData,
                        time_spent: timeDecimal > 0 ? timeDecimal : null,
                        time_formatted: timeDecimal > 0 ? timeFormatted : null
                    };
                    
                    const result = await api.put(`/interventions/${showUpdateModal.id}`, payload, token);
                    if (result.ok || result.data?.message) {
                        setShowUpdateModal(null);
                        setUpdateData({ solution_description: '', notes: '', time_hours: '', time_minutes: '' });
                        // Recarregar detalhes
                        const detail = await api.get(`/interventions/${showUpdateModal.id}`, token);
                        setShowDetailModal(detail);
                        loadInterventions();
                    } else {
                        alert(result.data?.error || result.error || 'Erro ao actualizar');
                    }
                } catch (err) {
                    alert('Erro ao actualizar interven√ß√£o');
                }
                setUpdateSaving(false);
            };
            
            const handleNewTech = async () => {
                if (!newTech.name || !newTech.company) {
                    alert('Nome e empresa s√£o obrigat√≥rios');
                    return;
                }
                try {
                    const result = await api.post('/external-technicians', newTech, token);
                    if (result.ok) {
                        setShowNewTechModal(false);
                        setNewTech({ name: '', company: '', phone: '', email: '' });
                        loadTechnicians();
                    } else {
                        alert(result.data?.error || 'Erro ao criar t√©cnico');
                    }
                } catch (err) {
                    alert('Erro ao criar t√©cnico: ' + err.message);
                }
            };
            
            const openDetail = async (id) => {
                try {
                    const detail = await api.get(`/interventions/${id}`, token);
                    setShowDetailModal(detail);
                } catch (err) {
                    alert('Erro ao carregar detalhes');
                }
            };
            
            const getStatusBadge = (status) => {
                if (status === 'concluida') return 'bg-green-100 text-green-800';
                return 'bg-yellow-100 text-yellow-800';
            };
            
            const getTypeBadge = (type) => {
                switch(type) {
                    case 'Manuten√ß√£o Preventiva': return 'bg-blue-100 text-blue-800';
                    case 'Manuten√ß√£o Corretiva': return 'bg-orange-100 text-orange-800';
                    case 'Inspe√ß√£o': return 'bg-purple-100 text-purple-800';
                    case 'Substitui√ß√£o de Componente': return 'bg-pink-100 text-pink-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            return (
                <div className="p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Interven√ß√µes</h2>
                            <p className="text-gray-500 text-sm">Registo e acompanhamento de interven√ß√µes t√©cnicas</p>
                        </div>
                        {user?.role !== 'visitor' && (
                            <button 
                                onClick={() => { resetForm(); setShowNewModal(true); }}
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center"
                            >
                                <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                </svg>
                                Nova Interven√ß√£o
                            </button>
                        )}
                    </div>
                    
                    {/* Filtros */}
                    <div className="bg-white rounded-xl shadow-md p-4 mb-6">
                        <div className="flex flex-wrap gap-4">
                            <select 
                                value={filters.status}
                                onChange={(e) => setFilters({...filters, status: e.target.value})}
                                className="px-4 py-2 border rounded-lg"
                                aria-label="Filtrar por estado"
                            >
                                <option value="">Todos os estados</option>
                                <option value="em_curso">Em Curso</option>
                                <option value="concluida">Conclu√≠da</option>
                            </select>
                            <select 
                                value={filters.type}
                                onChange={(e) => setFilters({...filters, type: e.target.value})}
                                className="px-4 py-2 border rounded-lg"
                                aria-label="Filtrar por tipo"
                            >
                                <option value="">Todos os tipos</option>
                                {interventionTypes.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                        </div>
                    </div>
                    
                    {/* Lista de Interven√ß√µes */}
                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        {loading ? (
                            <div className="p-8 text-center">A carregar...</div>
                        ) : interventions.length === 0 ? (
                            <div className="p-8 text-center text-gray-500">Nenhuma interven√ß√£o encontrada</div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ativo</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dura√ß√£o</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Custo</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ficheiros</th>
                                            <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {interventions.map(inter => (
                                            <tr key={inter.id} className="hover:bg-gray-50">
                                                <td className="px-4 py-4 font-mono text-sm">#{inter.id}</td>
                                                <td className="px-4 py-4 font-mono text-sm font-medium">{inter.serial_number}</td>
                                                <td className="px-4 py-4">
                                                    <span className={`px-2 py-1 rounded-full text-xs ${getTypeBadge(inter.intervention_type)}`}>
                                                        {inter.intervention_type}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-4">
                                                    <span className={`px-2 py-1 rounded-full text-xs ${getStatusBadge(inter.status)}`}>
                                                        {inter.status === 'concluida' ? 'Conclu√≠da' : 'Em Curso'}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-4 text-sm">{inter.duration_hours}h</td>
                                                <td className="px-4 py-4 text-sm">{inter.total_cost ? `${inter.total_cost.toFixed(2)}‚Äî` : '-'}</td>
                                                <td className="px-4 py-4 text-sm text-gray-500">
                                                    {new Date(inter.created_at).toLocaleDateString('pt-PT')}
                                                </td>
                                                <td className="px-4 py-4 text-sm">
                                                    {inter.file_count > 0 && (
                                                        <span className="bg-gray-100 px-2 py-1 rounded text-xs">{inter.file_count}</span>
                                                    )}
                                                </td>
                                                <td className="px-4 py-4 text-right">
                                                    <div className="flex justify-end gap-2">
                                                        <button 
                                                            onClick={() => openDetail(inter.id)}
                                                            className="text-blue-600 hover:underline text-sm"
                                                        >
                                                            Ver
                                                        </button>
                                                        {inter.status !== 'concluida' && user?.role !== 'visitor' && (
                                                            <button 
                                                                onClick={() => { setShowCompleteModal(inter); setCompleteData({ final_status: '', status_description: '', solution_description: '' }); }}
                                                                className="text-green-600 hover:underline text-sm"
                                                            >
                                                                Concluir
                                                            </button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        {/* Pagina√ß√£o */}
                        {totalPages > 1 && (
                            <div className="p-4 border-t flex justify-center gap-2">
                                <button onClick={() => setPage(p => Math.max(1, p-1))} disabled={page===1} className="px-3 py-1 border rounded disabled:opacity-50">Anterior</button>
                                <span className="px-3 py-1">P√°gina {page} de {totalPages}</span>
                                <button onClick={() => setPage(p => Math.min(totalPages, p+1))} disabled={page===totalPages} className="px-3 py-1 border rounded disabled:opacity-50">Seguinte</button>
                            </div>
                        )}
                    </div>
                    
                    {/* Modal Nova Interven√ß√£o */}
                    {showNewModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                                <div className="p-6 border-b bg-gradient-to-r from-blue-600 to-blue-700">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h3 className="text-xl font-bold text-white">Nova Interven√ß√£o</h3>
                                            <p className="text-blue-100 text-sm">Registe uma nova interven√ß√£o t√©cnica</p>
                                        </div>
                                        <button onClick={() => setShowNewModal(false)} className="text-white hover:text-blue-200 text-2xl">&times;</button>
                                    </div>
                                </div>
                                
                                <div className="p-6 space-y-6">
                                    {/* Sele√ß√£o de Ativo */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Ativo *</label>
                                        <select 
                                            value={newIntervention.serial_number}
                                            onChange={(e) => setNewIntervention({...newIntervention, serial_number: e.target.value})}
                                            className={`w-full px-4 py-3 border-2 rounded-lg ${formErrors.serial_number ? 'border-red-300' : 'border-gray-200'}`}
                                        >
                                            <option value="">Selecionar ativo...</option>
                                            {assets.map(a => (
                                                <option key={a.serial_number} value={a.serial_number}>
                                                    {a.serial_number} - {a.data?.installation_location || a.data?.municipality || 'Sem localiza√ß√£o'}
                                                </option>
                                            ))}
                                        </select>
                                        {formErrors.serial_number && <p className="text-red-500 text-xs mt-1">{formErrors.serial_number}</p>}
                                    </div>
                                    
                                    {/* Tipo de Interven√ß√£o */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Tipo de Interven√ß√£o *</label>
                                        <select 
                                            value={newIntervention.intervention_type}
                                            onChange={(e) => setNewIntervention({...newIntervention, intervention_type: e.target.value})}
                                            className={`w-full px-4 py-3 border-2 rounded-lg ${formErrors.intervention_type ? 'border-red-300' : 'border-gray-200'}`}
                                        >
                                            <option value="">Selecionar tipo...</option>
                                            {interventionTypes.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                        {formErrors.intervention_type && <p className="text-red-500 text-xs mt-1">{formErrors.intervention_type}</p>}
                                    </div>
                                    
                                    {/* Descri√ß√£o do Problema */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Descri√ß√£o do Problema {newIntervention.intervention_type !== 'Manuten√ß√£o Preventiva' && '*'}
                                        </label>
                                        <textarea 
                                            value={newIntervention.problem_description}
                                            onChange={(e) => setNewIntervention({...newIntervention, problem_description: e.target.value})}
                                            className={`w-full px-4 py-3 border-2 rounded-lg ${formErrors.problem_description ? 'border-red-300' : 'border-gray-200'}`}
                                            rows={3}
                                            placeholder="Descreva o problema identificado..."
                                        />
                                        {formErrors.problem_description && <p className="text-red-500 text-xs mt-1">{formErrors.problem_description}</p>}
                                    </div>
                                    
                                    {/* Descri√ß√£o da Solu√ß√£o */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Descri√ß√£o da Solu√ß√£o {newIntervention.intervention_type === 'Manuten√ß√£o Corretiva' && '*'}
                                        </label>
                                        <textarea 
                                            value={newIntervention.solution_description}
                                            onChange={(e) => setNewIntervention({...newIntervention, solution_description: e.target.value})}
                                            className={`w-full px-4 py-3 border-2 rounded-lg ${formErrors.solution_description ? 'border-red-300' : 'border-gray-200'}`}
                                            rows={3}
                                            placeholder="Descreva a solu√ß√£o aplicada..."
                                        />
                                        {formErrors.solution_description && <p className="text-red-500 text-xs mt-1">{formErrors.solution_description}</p>}
                                    </div>
                                    
                                    {/* Pe√ßas/Materiais */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Pe√ßas/Materiais Utilizados *</label>
                                        <textarea 
                                            value={newIntervention.parts_used}
                                            onChange={(e) => setNewIntervention({...newIntervention, parts_used: e.target.value})}
                                            className={`w-full px-4 py-3 border-2 rounded-lg ${formErrors.parts_used ? 'border-red-300' : 'border-gray-200'}`}
                                            rows={2}
                                            placeholder="Liste as pe√ßas e materiais utilizados (ou 'Nenhum' se n√£o aplic√°vel)..."
                                        />
                                        {formErrors.parts_used && <p className="text-red-500 text-xs mt-1">{formErrors.parts_used}</p>}
                                    </div>
                                    
                                    {/* Dura√ß√£o */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Dura√ß√£o (horas) *</label>
                                            <input 
                                                type="number"
                                                step="0.5"
                                                min="0"
                                                value={newIntervention.duration_hours}
                                                onChange={(e) => setNewIntervention({...newIntervention, duration_hours: e.target.value})}
                                                className={`w-full px-4 py-3 border-2 rounded-lg ${formErrors.duration_hours ? 'border-red-300' : 'border-gray-200'}`}
                                                placeholder="Ex: 2.5"
                                            />
                                            {formErrors.duration_hours && <p className="text-red-500 text-xs mt-1">{formErrors.duration_hours}</p>}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Estado do Ativo</label>
                                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                                {newIntervention.intervention_type === 'Inspe√ß√£o' ? (
                                                    <p className="text-sm text-blue-700">
                                                        <span className="font-medium">√¢‚Äû¬π√Ø¬∏¬è Inspe√ß√µes</span> n√£o alteram o estado do ativo.
                                                    </p>
                                                ) : (
                                                    <p className="text-sm text-blue-700">
                                                        <span className="font-medium">‚ö°√Ø¬∏¬è Estado ser√° alterado</span> automaticamente para "Em Repara√ß√£o" ao criar a interven√ß√£o.
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* T√©cnicos Internos */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">T√©cnicos Internos Acompanhantes</label>
                                        <div className="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                                            {technicians.filter(t => t.id !== user.id).map(t => (
                                                <label key={t.id} className="flex items-center text-sm p-2 hover:bg-gray-100 rounded cursor-pointer">
                                                    <input 
                                                        type="checkbox"
                                                        checked={newIntervention.internal_technicians.includes(t.id)}
                                                        onChange={(e) => {
                                                            if (e.target.checked) {
                                                                setNewIntervention({...newIntervention, internal_technicians: [...newIntervention.internal_technicians, t.id]});
                                                            } else {
                                                                setNewIntervention({...newIntervention, internal_technicians: newIntervention.internal_technicians.filter(id => id !== t.id)});
                                                            }
                                                        }}
                                                        className="mr-2"
                                                    />
                                                    <span>{t.display_name || t.username}</span>
                                                    <span className="text-xs text-gray-400 ml-1">({t.role === 'admin' ? 'Admin' : 'Op.'})</span>
                                                </label>
                                            ))}
                                        </div>
                                        {technicians.filter(t => t.id !== user.id).length === 0 && (
                                            <p className="text-gray-400 text-sm mt-2">Nenhum outro t√©cnico dispon√≠vel</p>
                                        )}
                                    </div>
                                    
                                    {/* T√©cnicos Externos */}
                                    <div>
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="block text-sm font-medium text-gray-700">T√©cnicos Externos</label>
                                            <button 
                                                type="button"
                                                onClick={() => setShowNewTechModal(true)}
                                                className="text-blue-600 text-sm hover:underline"
                                            >
                                                + Novo T√©cnico Externo
                                            </button>
                                        </div>
                                        
                                        {/* Filtro por empresa */}
                                        {uniqueCompanies.length > 1 && (
                                            <select
                                                value={extTechCompanyFilter}
                                                onChange={(e) => setExtTechCompanyFilter(e.target.value)}
                                                className="w-full px-3 py-2 border rounded-lg text-sm mb-2"
                                            >
                                                <option value="">Todas as empresas</option>
                                                {uniqueCompanies.map(c => (
                                                    <option key={c} value={c}>{c}</option>
                                                ))}
                                            </select>
                                        )}
                                        
                                        {externalTechs.length > 0 ? (
                                            <div className="max-h-40 overflow-y-auto bg-gray-50 p-3 rounded-lg space-y-2">
                                                {externalTechs
                                                    .filter(t => !extTechCompanyFilter || t.company === extTechCompanyFilter)
                                                    .map(t => (
                                                    <div key={t.id} className="flex items-center justify-between p-2 bg-white rounded border hover:bg-gray-50">
                                                        <label className="flex items-center text-sm flex-1 cursor-pointer">
                                                            <input 
                                                                type="checkbox"
                                                                checked={newIntervention.external_technicians.includes(t.id)}
                                                                onChange={(e) => {
                                                                    if (e.target.checked) {
                                                                        setNewIntervention({...newIntervention, external_technicians: [...newIntervention.external_technicians, t.id]});
                                                                    } else {
                                                                        setNewIntervention({...newIntervention, external_technicians: newIntervention.external_technicians.filter(id => id !== t.id)});
                                                                    }
                                                                }}
                                                                className="mr-2"
                                                            />
                                                            <div>
                                                                <span className="font-medium">{t.name}</span>
                                                                <span className="text-gray-500 text-xs ml-2">({t.company})</span>
                                                                {t.phone && <span className="text-gray-400 text-xs ml-2">üìæ {t.phone}</span>}
                                                            </div>
                                                        </label>
                                                        {(user?.role === 'admin' || user?.role === 'superadmin') && (
                                                            <button
                                                                type="button"
                                                                onClick={async () => {
                                                                    if (confirm(`Desactivar t√©cnico "${t.name}"? O hist√≥rico ser√° mantido.`)) {
                                                                        await api.delete(`/external-technicians/${t.id}`, token);
                                                                        loadTechnicians();
                                                                    }
                                                                }}
                                                                className="p-1 text-red-500 hover:bg-red-50 rounded ml-2"
                                                                title="Desactivar t√©cnico"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <p className="text-gray-400 text-sm bg-gray-50 p-3 rounded-lg">Nenhum t√©cnico externo registado</p>
                                        )}
                                    </div>
                                    
                                    {/* Notas */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Notas Adicionais</label>
                                        <textarea 
                                            value={newIntervention.notes}
                                            onChange={(e) => setNewIntervention({...newIntervention, notes: e.target.value})}
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg"
                                            rows={2}
                                            placeholder="Observa√ß√µes adicionais..."
                                        />
                                    </div>
                                </div>
                                
                                <div className="p-6 border-t bg-gray-50 flex justify-end gap-3">
                                    <button 
                                        onClick={() => setShowNewModal(false)}
                                        className="px-6 py-2 text-gray-600 hover:bg-gray-200 rounded-lg"
                                    >
                                        Cancelar
                                    </button>
                                    <button 
                                        onClick={handleSubmit}
                                        disabled={saving}
                                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                                    >
                                        {saving ? 'A guardar...' : 'Criar Interven√ß√£o'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Detalhes da Interven√ß√£o */}
                    {showDetailModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                                <div className="p-6 border-b flex justify-between items-center">
                                    <div>
                                        <h3 className="text-xl font-bold">Interven√ß√£o #{showDetailModal.id}</h3>
                                        <p className="text-sm text-gray-500">Ativo: {showDetailModal.serial_number}</p>
                                    </div>
                                    <button onClick={() => setShowDetailModal(null)} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                                </div>
                                
                                <div className="p-6">
                                    {/* Info Principal */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                        <div className="bg-gray-50 p-3 rounded-lg">
                                            <p className="text-xs text-gray-500">Tipo</p>
                                            <p className="font-medium text-sm">{showDetailModal.intervention_type}</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded-lg">
                                            <p className="text-xs text-gray-500">Estado</p>
                                            <span className={`px-2 py-1 rounded-full text-xs ${getStatusBadge(showDetailModal.status)}`}>
                                                {showDetailModal.status === 'concluida' ? 'Conclu√≠da' : 'Em Curso'}
                                            </span>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded-lg">
                                            <p className="text-xs text-gray-500">Dura√ß√£o</p>
                                            <p className="font-medium text-sm">{showDetailModal.duration_hours}h</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded-lg">
                                            <p className="text-xs text-gray-500">Custo Total</p>
                                            <p className="font-medium text-sm">{showDetailModal.total_cost ? `${showDetailModal.total_cost.toFixed(2)}‚Äî` : '0.00‚Äî'}</p>
                                        </div>
                                    </div>
                                    
                                    {/* Descri√ß√µes */}
                                    <div className="space-y-4 mb-6">
                                        {showDetailModal.problem_description && (
                                            <div>
                                                <h4 className="text-sm font-semibold text-gray-700 mb-1">Descri√ß√£o do Problema</h4>
                                                <p className="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">{showDetailModal.problem_description}</p>
                                            </div>
                                        )}
                                        {showDetailModal.solution_description && (
                                            <div>
                                                <h4 className="text-sm font-semibold text-gray-700 mb-1">Descri√ß√£o da Solu√ß√£o</h4>
                                                <p className="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">{showDetailModal.solution_description}</p>
                                            </div>
                                        )}
                                        {showDetailModal.parts_used && (
                                            <div>
                                                <h4 className="text-sm font-semibold text-gray-700 mb-1">Pe√ßas/Materiais</h4>
                                                <p className="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">{showDetailModal.parts_used}</p>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* T√©cnicos */}
                                    {showDetailModal.technicians?.length > 0 && (
                                        <div className="mb-6">
                                            <h4 className="text-sm font-semibold text-gray-700 mb-2">T√©cnicos</h4>
                                            <div className="flex flex-wrap gap-2">
                                                {showDetailModal.technicians.map((t, i) => (
                                                    <span key={i} className={`px-3 py-1 rounded-full text-sm ${t.role === 'responsavel' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}>
                                                        {t.username || `${t.external_name} (${t.external_company})`}
                                                        {t.role === 'responsavel' && ' ‚≠ê'}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Ficheiros */}
                                    <div className="mb-6">
                                        <h4 className="text-sm font-semibold text-gray-700 mb-2">Ficheiros</h4>
                                        
                                        {/* Upload */}
                                        {showDetailModal.status !== 'concluida' && (
                                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                                <div className="grid grid-cols-4 gap-3 mb-3">
                                                    <select 
                                                        value={fileCategory}
                                                        onChange={(e) => setFileCategory(e.target.value)}
                                                        className="px-3 py-2 border rounded-lg text-sm"
                                                        aria-label="Categoria do ficheiro"
                                                    >
                                                        {fileCategories.map(c => <option key={c.value} value={c.value}>{c.label}</option>)}
                                                    </select>
                                                    <input 
                                                        type="text"
                                                        value={fileDescription}
                                                        onChange={(e) => setFileDescription(e.target.value)}
                                                        placeholder="Descri√ß√£o..."
                                                        className="px-3 py-2 border rounded-lg text-sm"
                                                    />
                                                    {fileCategory === 'fatura' && (
                                                        <input 
                                                            type="number"
                                                            step="0.01"
                                                            value={fileCost}
                                                            onChange={(e) => setFileCost(e.target.value)}
                                                            placeholder="Valor ‚Äî"
                                                            className="px-3 py-2 border rounded-lg text-sm"
                                                        />
                                                    )}
                                                    <label className="flex items-center justify-center px-3 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 text-sm">
                                                        {uploadingFile ? 'A enviar...' : 'Escolher Ficheiro'}
                                                        <input 
                                                            type="file"
                                                            accept=".pdf,.jpg,.jpeg,.png"
                                                            onChange={(e) => handleFileUpload(e, showDetailModal.id)}
                                                            className="hidden"
                                                            disabled={uploadingFile}
                                                        />
                                                    </label>
                                                </div>
                                                <p className="text-xs text-blue-600">Formatos: PDF, JPG, PNG. M√°x: 3MB</p>
                                            </div>
                                        )}
                                        
                                        {/* Lista de ficheiros por categoria */}
                                        {showDetailModal.files?.length > 0 ? (
                                            <div className="space-y-4">
                                                {['antes', 'durante', 'depois', 'fatura', 'outros'].map(cat => {
                                                    const catFiles = showDetailModal.files.filter(f => f.file_category === cat);
                                                    if (catFiles.length === 0) return null;
                                                    return (
                                                        <div key={cat}>
                                                            <h5 className="text-xs font-semibold text-gray-500 uppercase mb-2">
                                                                {fileCategories.find(c => c.value === cat)?.label}
                                                            </h5>
                                                            <div className="grid grid-cols-4 gap-2">
                                                                {catFiles.map(f => (
                                                                    <div key={f.id} className="bg-gray-50 rounded-lg p-2 text-center">
                                                                        {f.file_type === 'pdf' ? (
                                                                            <div className="w-full h-16 bg-red-100 rounded flex items-center justify-center mb-1">
                                                                                <span className="text-red-600 text-xs font-bold">PDF</span>
                                                                            </div>
                                                                        ) : (
                                                                            <div className="w-full h-16 bg-gray-200 rounded flex items-center justify-center mb-1">
                                                                                <span className="text-gray-500 text-xs">IMG</span>
                                                                            </div>
                                                                        )}
                                                                        <a 
                                                                            href={`${API_BASE}/interventions/${showDetailModal.id}/files/${f.id}`}
                                                                            target="_blank"
                                                                            className="text-xs text-blue-600 hover:underline block truncate"
                                                                        >
                                                                            {f.original_name}
                                                                        </a>
                                                                        {f.cost_value && (
                                                                            <span className="text-xs text-green-600 font-medium">{f.cost_value.toFixed(2)}‚Äî</span>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        ) : (
                                            <p className="text-gray-400 text-sm">Nenhum ficheiro anexado</p>
                                        )}
                                    </div>
                                    
                                    {/* Log de Edi√ß√µes / Actualiza√ß√µes */}
                                    {showDetailModal.edit_history?.length > 0 && (
                                        <div className="mb-6">
                                            <h4 className="text-sm font-semibold text-gray-700 mb-2">Hist√≥rico de Actualiza√ß√µes</h4>
                                            <div className="bg-gray-50 border border-gray-200 rounded-lg divide-y divide-gray-200 max-h-48 overflow-y-auto">
                                                {showDetailModal.edit_history.map((e, i) => {
                                                    const fieldLabels = {
                                                        'solution_description': 'Descri√ß√£o da Solu√ß√£o',
                                                        'problem_description': 'Descri√ß√£o do Problema',
                                                        'notes': 'Notas',
                                                        'parts_used': 'Pe√ßas/Materiais',
                                                        'total_cost': 'Custo Total',
                                                        'duration_hours': 'Dura√ß√£o (horas)',
                                                        'time_spent': 'Tempo no Local'
                                                    };
                                                    return (
                                                        <div key={i} className="p-3">
                                                            <div className="flex justify-between items-start mb-1">
                                                                <span className="text-sm font-medium text-gray-700">{fieldLabels[e.field_name] || e.field_name}</span>
                                                                <span className="text-xs text-gray-500">{new Date(e.edited_at).toLocaleString('pt-PT')}</span>
                                                            </div>
                                                            <div className="text-xs text-gray-500 mb-1">Por: {e.edited_by_name}</div>
                                                            {e.old_value && (
                                                                <div className="text-xs bg-red-50 text-red-700 p-2 rounded mb-1">
                                                                    <span className="font-medium">Anterior:</span> {e.old_value || '(vazio)'}
                                                                </div>
                                                            )}
                                                            <div className="text-xs bg-green-50 text-green-700 p-2 rounded">
                                                                <span className="font-medium">Novo:</span> {e.new_value || '(vazio)'}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="p-6 border-t bg-gray-50 flex justify-between">
                                    <button onClick={() => setShowDetailModal(null)} className="px-6 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">Fechar</button>
                                    {showDetailModal.status !== 'concluida' && user?.role !== 'visitor' && (
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={() => { setShowUpdateModal(showDetailModal); setUpdateData({ solution_description: showDetailModal.solution_description || '', notes: showDetailModal.notes || '', time_hours: '', time_minutes: '' }); }}
                                                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                            >
                                                Registar Progresso
                                            </button>
                                            <button 
                                                onClick={() => { setShowCompleteModal(showDetailModal); setCompleteData({ final_status: '', status_description: '', solution_description: '' }); }}
                                                className="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700"
                                            >
                                                Alterar Estado / Concluir
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Concluir / Alterar Estado da Interven√ß√£o */}
                    {showCompleteModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                                <div className={`p-6 border-b bg-gradient-to-r ${completeData.final_status === 'Operacional' ? 'from-green-500 to-green-600' : 'from-orange-500 to-orange-600'}`}>
                                    <h3 className="text-xl font-bold text-white">
                                        {completeData.final_status === 'Operacional' ? 'Concluir Interven√ß√£o' : 'Alterar Estado'}
                                    </h3>
                                    <p className="text-white/80 text-sm">#{showCompleteModal.id} - {showCompleteModal.serial_number}</p>
                                    {showCompleteModal.update_count > 0 && (
                                        <p className="text-white/60 text-xs mt-1">Actualiza√ß√£o #{(showCompleteModal.update_count || 0) + 1}</p>
                                    )}
                                </div>
                                
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Novo Estado do Ativo</label>
                                        <select 
                                            value={completeData.final_status}
                                            onChange={(e) => setCompleteData({...completeData, final_status: e.target.value})}
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg"
                                        >
                                            <option value="">Manter estado actual (Em Repara√ß√£o)</option>
                                            <option value="Operacional">√¢≈ì‚Ä¶ Operacional - Concluir interven√ß√£o</option>
                                            <option value="Manuten√ß√£o Necess√°ria">‚ö†Ô∏è¬è Manuten√ß√£o Necess√°ria</option>
                                            <option value="Desativado">√¢¬ù≈í Desativado</option>
                                        </select>
                                        
                                        {/* Mensagem informativa baseada no estado */}
                                        {completeData.final_status === 'Operacional' && (
                                            <div className="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                                                <p className="text-sm text-green-700">
                                                    <strong>√¢≈ì‚Ä¶ Conclus√£o:</strong> A interven√ß√£o ser√° marcada como conclu√≠da e o ativo ficar√° operacional.
                                                </p>
                                            </div>
                                        )}
                                        {completeData.final_status && completeData.final_status !== 'Operacional' && (
                                            <div className="mt-2 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                                <p className="text-sm text-orange-700">
                                                    <strong>‚è≥ Em progresso:</strong> O estado ser√° alterado mas a interven√ß√£o permanece aberta para mais actualiza√ß√µes.
                                                </p>
                                            </div>
                                        )}
                                        {!completeData.final_status && (
                                            <div className="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                                <p className="text-sm text-gray-600">
                                                    Seleccione um estado ou mantenha "Em Repara√ß√£o" para continuar a trabalhar.
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {completeData.final_status && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o da Altera√ß√£o</label>
                                            <textarea 
                                                value={completeData.status_description}
                                                onChange={(e) => setCompleteData({...completeData, status_description: e.target.value})}
                                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg"
                                                rows={2}
                                                placeholder="Motivo da altera√ß√£o..."
                                            />
                                        </div>
                                    )}
                                    
                                    {completeData.final_status === 'Operacional' && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Resumo Final da Interven√ß√£o</label>
                                            <textarea 
                                                value={completeData.solution_description}
                                                onChange={(e) => setCompleteData({...completeData, solution_description: e.target.value})}
                                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg"
                                                rows={3}
                                                placeholder="Trabalho realizado, pe√ßas substitu√≠das, etc..."
                                            />
                                        </div>
                                    )}
                                </div>
                                
                                <div className="p-6 border-t bg-gray-50 flex justify-end gap-3">
                                    <button onClick={() => setShowCompleteModal(null)} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">Cancelar</button>
                                    <button 
                                        onClick={handleComplete} 
                                        className={`px-6 py-2 text-white rounded-lg ${completeData.final_status === 'Operacional' ? 'bg-green-600 hover:bg-green-700' : 'bg-orange-600 hover:bg-orange-700'}`}
                                    >
                                        {completeData.final_status === 'Operacional' ? 'Concluir Interven√ß√£o' : 'Guardar Altera√ß√£o'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Actualizar Interven√ß√£o */}
                    {showUpdateModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
                                <div className="p-6 border-b bg-gradient-to-r from-blue-500 to-blue-600">
                                    <h3 className="text-xl font-bold text-white">Registar Progresso</h3>
                                    <p className="text-blue-100 text-sm">#{showUpdateModal.id} - {showUpdateModal.serial_number}</p>
                                    {showUpdateModal.update_count > 0 && (
                                        <p className="text-blue-200 text-xs mt-1">Actualiza√ß√£o #{(showUpdateModal.update_count || 0) + 1}</p>
                                    )}
                                </div>
                                
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o da Solu√ß√£o / Progresso</label>
                                        <textarea 
                                            value={updateData.solution_description}
                                            onChange={(e) => setUpdateData({...updateData, solution_description: e.target.value})}
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg"
                                            rows={4}
                                            placeholder="Descreva o trabalho realizado at√© ao momento..."
                                        />
                                    </div>
                                    
                                    {/* Campo de tempo despendido em formato HH:MM */}
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <label className="block text-sm font-medium text-blue-800 mb-2">
                                            ‚è±√Ø¬∏¬è Tempo Despendido no Local
                                        </label>
                                        <div className="flex gap-2 items-center">
                                            <input 
                                                type="number"
                                                min="0"
                                                max="99"
                                                value={updateData.time_hours || ''}
                                                onChange={(e) => setUpdateData({...updateData, time_hours: e.target.value})}
                                                className="w-20 px-3 py-2 border-2 border-blue-200 rounded-lg text-center"
                                                placeholder="0"
                                            />
                                            <span className="text-lg font-bold text-blue-600">:</span>
                                            <input 
                                                type="number"
                                                min="0"
                                                max="59"
                                                value={updateData.time_minutes || ''}
                                                onChange={(e) => {
                                                    const val = Math.min(59, Math.max(0, parseInt(e.target.value) || 0));
                                                    setUpdateData({...updateData, time_minutes: val.toString().padStart(2, '0')});
                                                }}
                                                className="w-20 px-3 py-2 border-2 border-blue-200 rounded-lg text-center"
                                                placeholder="00"
                                            />
                                            <span className="text-sm text-blue-600 ml-2">horas : minutos</span>
                                        </div>
                                        <p className="text-xs text-blue-600 mt-2">
                                            Este valor ser√° adicionado ao tempo total da interven√ß√£o e registado no hist√≥rico.
                                        </p>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Notas Adicionais</label>
                                        <textarea 
                                            value={updateData.notes}
                                            onChange={(e) => setUpdateData({...updateData, notes: e.target.value})}
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg"
                                            rows={3}
                                            placeholder="Observa√ß√µes, pend√™ncias, pr√≥ximos passos..."
                                        />
                                    </div>
                                    
                                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                        <p className="text-sm text-yellow-700">
                                            <strong>üí° Dica:</strong> Use este formul√°rio para registar o progresso da interven√ß√£o. 
                                            Todas as altera√ß√µes ficam registadas no hist√≥rico.
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="p-6 border-t bg-gray-50 flex justify-end gap-3">
                                    <button onClick={() => setShowUpdateModal(null)} className="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">Cancelar</button>
                                    <button 
                                        onClick={handleUpdate} 
                                        disabled={updateSaving}
                                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                                    >
                                        {updateSaving ? 'A guardar...' : 'Guardar Actualiza√ß√£o'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Novo T√©cnico Externo */}
                    {showNewTechModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                                <div className="p-6 border-b">
                                    <h3 className="text-xl font-bold">Novo T√©cnico Externo</h3>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                                        <input 
                                            type="text"
                                            value={newTech.name}
                                            onChange={(e) => setNewTech({...newTech, name: e.target.value})}
                                            className="w-full px-4 py-2 border rounded-lg"
                                            placeholder="Nome completo"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Empresa *</label>
                                        <input 
                                            type="text"
                                            value={newTech.company}
                                            onChange={(e) => setNewTech({...newTech, company: e.target.value})}
                                            className="w-full px-4 py-2 border rounded-lg"
                                            placeholder="Nome da empresa"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                        <input 
                                            type="tel"
                                            value={newTech.phone}
                                            onChange={(e) => setNewTech({...newTech, phone: e.target.value})}
                                            className="w-full px-4 py-2 border rounded-lg"
                                            placeholder="+351 ..."
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input 
                                            type="email"
                                            value={newTech.email}
                                            onChange={(e) => setNewTech({...newTech, email: e.target.value})}
                                            className="w-full px-4 py-2 border rounded-lg"
                                            placeholder="email@empresa.pt"
                                        />
                                    </div>
                                </div>
                                <div className="p-6 border-t bg-gray-50 flex justify-end gap-3">
                                    <button onClick={() => setShowNewTechModal(false)} className="px-4 py-2 text-gray-600">Cancelar</button>
                                    <button onClick={handleNewTech} className="px-6 py-2 bg-blue-600 text-white rounded-lg">Criar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // MAP VIEW - Visualiza√ß√£o de ativos no mapa com Leaflet
        const MapView = () => {
            const { token } = useAuth();
            const [assets, setAssets] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filters, setFilters] = useState({ municipalities: [], statuses: [] });
            const [selectedMunicipality, setSelectedMunicipality] = useState('');
            const [selectedStatus, setSelectedStatus] = useState('');
            const [selectedAsset, setSelectedAsset] = useState(null);
            const [routeMode, setRouteMode] = useState(false);
            const [routePoints, setRoutePoints] = useState([]);
            const [startPoint, setStartPoint] = useState(null); // Ponto de partida personalizado
            const [mapReady, setMapReady] = useState(false);
            
            // Refs para Leaflet (n√£o causam re-renders)
            const mapContainerRef = React.useRef(null);
            const mapRef = React.useRef(null);
            const markersRef = React.useRef(null);
            const routingRef = React.useRef(null);
            
            // Centro de Portugal
            const PORTUGAL_CENTER = [39.5, -8.0];
            const PORTUGAL_ZOOM = 7;
            
            const getStatusColor = (status) => {
                switch(status) {
                    case 'Operacional': return '#10B981';
                    case 'Manuten√ß√£o': return '#F59E0B';
                    case 'Avariado': return '#F97316';
                    case 'Desativado': return '#EF4444';
                    default: return '#6B7280';
                }
            };
            
            const getStatusMarkerClass = (status) => {
                switch(status) {
                    case 'Operacional': return 'marker-operacional';
                    case 'Manuten√ß√£o': return 'marker-manutencao';
                    case 'Avariado': return 'marker-reparacao';
                    case 'Desativado': return 'marker-desativado';
                    default: return 'marker-default';
                }
            };
            
            const getStatusBgClass = (status) => {
                switch(status) {
                    case 'Operacional': return 'bg-green-100 text-green-800';
                    case 'Manuten√ß√£o': return 'bg-yellow-100 text-yellow-800';
                    case 'Avariado': return 'bg-orange-100 text-orange-800';
                    case 'Desativado': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            // Carregar assets
            const loadAssets = async () => {
                try {
                    let url = '/assets/map';
                    const params = [];
                    if (selectedMunicipality) params.push(`municipality=${encodeURIComponent(selectedMunicipality)}`);
                    if (selectedStatus) params.push(`status=${encodeURIComponent(selectedStatus)}`);
                    if (params.length) url += '?' + params.join('&');
                    
                    const data = await api.get(url, token);
                    setAssets(data.assets || []);
                    setFilters(data.filters || { municipalities: [], statuses: [] });
                } catch (err) {
                    console.error('Error loading map assets:', err);
                }
                setLoading(false);
            };
            
            // Carregar assets quando filtros mudam
            useEffect(() => {
                loadAssets();
            }, [selectedMunicipality, selectedStatus, token]);
            
            // Inicializar mapa DEPOIS do loading terminar e container existir
            useEffect(() => {
                // S√≥ inicializa quando loading terminou e container existe
                if (loading) return;
                if (mapRef.current) return; // J√° inicializado
                
                // Pequeno delay para garantir que o DOM est√° pronto
                const timer = setTimeout(() => {
                    if (!mapContainerRef.current) {
                        console.error('Container do mapa n√£o encontrado');
                        return;
                    }
                    
                    try {
                        console.log('A inicializar mapa Leaflet...');
                        
                        // Criar mapa
                        const map = L.map(mapContainerRef.current, {
                            center: PORTUGAL_CENTER,
                            zoom: PORTUGAL_ZOOM,
                            zoomControl: true
                        });
                        
                        // Adicionar tiles do OpenStreetMap - com fallback
                        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '√Ç¬© OpenStreetMap',
                            maxZoom: 19,
                            crossOrigin: true
                        });
                        
                        tileLayer.on('tileerror', function(error) {
                            console.error('Erro ao carregar tile:', error);
                        });
                        
                        tileLayer.on('load', function() {
                            console.log('Tiles carregados com sucesso!');
                        });
                        
                        tileLayer.addTo(map);
                        
                        // Adicionar escala
                        L.control.scale({ metric: true, imperial: false }).addTo(map);
                        
                        // Criar layer de marcadores simples (sem cluster para simplificar)
                        const markers = L.layerGroup();
                        map.addLayer(markers);
                        
                        // Guardar refs
                        mapRef.current = map;
                        markersRef.current = markers;
                        
                        console.log('Mapa inicializado com sucesso!');
                        console.log('Container size:', mapContainerRef.current.offsetWidth, 'x', mapContainerRef.current.offsetHeight);
                        
                        // For√ßar redimensionamento m√∫ltiplas vezes
                        setTimeout(() => {
                            if (mapRef.current) {
                                mapRef.current.invalidateSize();
                                mapRef.current.setView(PORTUGAL_CENTER, PORTUGAL_ZOOM);
                                console.log('InvalidateSize executado (100ms)');
                            }
                        }, 100);
                        
                        setTimeout(() => {
                            if (mapRef.current) {
                                mapRef.current.invalidateSize();
                                console.log('InvalidateSize executado (500ms)');
                                setMapReady(true);
                            }
                        }, 500);
                        
                    } catch(err) {
                        console.error('Erro ao inicializar mapa:', err);
                    }
                }, 200); // Aumentado para 200ms
                
                // Cleanup
                return () => {
                    clearTimeout(timer);
                    if (mapRef.current) {
                        mapRef.current.remove();
                        mapRef.current = null;
                        markersRef.current = null;
                    }
                };
            }, [loading]); // Depende do loading
            
            // Actualizar marcadores quando assets ou mapa mudam
            useEffect(() => {
                if (!mapReady || !markersRef.current || !mapRef.current) return;
                
                console.log('A actualizar marcadores. Total assets:', assets.length);
                
                // Limpar marcadores existentes
                markersRef.current.clearLayers();
                
                if (assets.length === 0) {
                    console.log('Sem assets para mostrar');
                    return;
                }
                
                const bounds = [];
                let validMarkers = 0;
                
                assets.forEach(asset => {
                    // VALIDA√ç‚Ä°√ç∆íO DE COORDENADAS
                    const lat = parseFloat(asset.latitude);
                    const lng = parseFloat(asset.longitude);
                    
                    // Verificar se s√£o n√∫meros v√°lidos e dentro de limites razo√°veis
                    if (isNaN(lat) || isNaN(lng)) {
                        console.warn('Coordenadas inv√°lidas para asset:', asset.serial_number, asset.latitude, asset.longitude);
                        return;
                    }
                    
                    // Limites de Portugal: lat 36-43, lng -10 a -6
                    // Limites do mundo: lat -90 a 90, lng -180 a 180
                    if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                        console.warn('Coordenadas fora de limites:', asset.serial_number, lat, lng);
                        return;
                    }
                    
                    const color = getStatusColor(asset.status);
                    
                    // Criar √≠cone simples
                    const icon = L.divIcon({
                        html: `<div style="background:${color};width:20px;height:20px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3)" title="${asset.serial_number}"></div>`,
                        className: '',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    const marker = L.marker([lat, lng], { icon, title: asset.serial_number });
                    
                    // Popup com refer√™ncia do produto
                    marker.bindPopup(`
                        <div style="min-width:180px">
                            <strong>${asset.serial_number}</strong><br/>
                            ${asset.product_reference ? `<span style="color:#6B7280">Ref: ${asset.product_reference}</span><br/>` : ''}
                            ${asset.location || asset.municipality || ''}<br/>
                            <span style="color:${color}">${asset.status || 'N/D'}</span>
                        </div>
                    `);
                    
                    marker.on('click', () => setSelectedAsset(asset));
                    
                    markersRef.current.addLayer(marker);
                    bounds.push([lat, lng]);
                    validMarkers++;
                });
                
                console.log('Marcadores v√°lidos criados:', validMarkers);
                
                // Ajustar vista apenas se houver marcadores v√°lidos
                if (bounds.length > 0) {
                    try {
                        mapRef.current.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
                        console.log('Vista ajustada para os marcadores');
                    } catch(e) {
                        console.error('Erro ao ajustar vista:', e);
                        // Fallback para Portugal
                        mapRef.current.setView(PORTUGAL_CENTER, PORTUGAL_ZOOM);
                    }
                } else {
                    // Se n√£o h√° marcadores v√°lidos, mostrar Portugal
                    console.log('Sem marcadores v√°lidos, a mostrar Portugal');
                    mapRef.current.setView(PORTUGAL_CENTER, PORTUGAL_ZOOM);
                }
                
            }, [assets, mapReady]);
            
            // Fun√ß√µes de controlo
            const centerOnPortugal = () => {
                if (mapRef.current) {
                    mapRef.current.setView(PORTUGAL_CENTER, PORTUGAL_ZOOM);
                }
            };
            
            const centerOnAssets = () => {
                if (mapRef.current && assets.length > 0) {
                    // Filtrar apenas coordenadas v√°lidas
                    const validBounds = assets
                        .filter(a => {
                            const lat = parseFloat(a.latitude);
                            const lng = parseFloat(a.longitude);
                            return !isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
                        })
                        .map(a => [parseFloat(a.latitude), parseFloat(a.longitude)]);
                    
                    if (validBounds.length > 0) {
                        mapRef.current.fitBounds(validBounds, { padding: [50, 50], maxZoom: 14 });
                    } else {
                        // Se n√£o h√° coordenadas v√°lidas, mostrar Portugal
                        mapRef.current.setView(PORTUGAL_CENTER, PORTUGAL_ZOOM);
                    }
                } else {
                    // Se n√£o h√° assets, mostrar Portugal
                    if (mapRef.current) {
                        mapRef.current.setView(PORTUGAL_CENTER, PORTUGAL_ZOOM);
                    }
                }
            };
            
            // Fun√ß√µes de rota
            const addRoutePoint = (asset) => {
                if (routePoints.length < 10 && !routePoints.find(p => p.id === asset.id)) {
                    setRoutePoints([...routePoints, asset]);
                }
            };
            
            const removeRoutePoint = (index) => {
                setRoutePoints(routePoints.filter((_, i) => i !== index));
            };
            
            const clearRoute = () => {
                setRoutePoints([]);
                setStartPoint(null);
                // Limpar camadas de rota do mapa
                if (mapRef.current) {
                    mapRef.current.eachLayer(layer => {
                        if (layer.options && layer.options.isRouteLine) {
                            mapRef.current.removeLayer(layer);
                        }
                        if (layer.options && layer.options.isRouteMarker) {
                            mapRef.current.removeLayer(layer);
                        }
                        if (layer.options && layer.options.isStartMarker) {
                            mapRef.current.removeLayer(layer);
                        }
                    });
                }
                routingRef.current = null;
            };
            
            // Adicionar/remover event listener quando routeMode muda
            useEffect(() => {
                if (!mapRef.current || !mapReady) return;
                
                // Handler para clique no mapa (definir ponto de partida)
                const handleMapClick = (e) => {
                    // Verificar se clique foi num marcador - se sim, ignorar
                    if (e.originalEvent && e.originalEvent.target) {
                        const target = e.originalEvent.target;
                        if (target.closest('.leaflet-marker-icon') || 
                            target.closest('.leaflet-marker-pane') ||
                            target.closest('.leaflet-popup')) {
                            console.log('Clique em marcador/popup ignorado');
                            return;
                        }
                    }
                    
                    const { lat, lng } = e.latlng;
                    
                    console.log('Clique no mapa em routeMode:', lat, lng);
                    
                    // Remover marcador anterior de partida
                    mapRef.current.eachLayer(layer => {
                        if (layer.options && layer.options.isStartMarker) {
                            mapRef.current.removeLayer(layer);
                        }
                    });
                    
                    // Criar novo ponto de partida
                    const newStart = {
                        id: 'start-custom',
                        latitude: lat,
                        longitude: lng,
                        serial_number: 'Ponto de Partida',
                        isCustomStart: true
                    };
                    setStartPoint(newStart);
                    
                    // Adicionar marcador visual
                    L.marker([lat, lng], {
                        icon: L.divIcon({
                            html: `<div style="background:#22c55e;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4)">üöó</div>`,
                            className: '',
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        }),
                        isStartMarker: true
                    }).addTo(mapRef.current).bindPopup(`<strong>üöó Ponto de Partida</strong><br/>Lat: ${lat.toFixed(5)}<br/>Lng: ${lng.toFixed(5)}`).openPopup();
                };
                
                if (routeMode) {
                    console.log('Activando modo rota - adicionando listener de clique');
                    mapRef.current.on('click', handleMapClick);
                    // Mudar cursor
                    if (mapContainerRef.current) {
                        mapContainerRef.current.style.cursor = 'crosshair';
                    }
                } else {
                    console.log('Desactivando modo rota');
                    mapRef.current.off('click', handleMapClick);
                    if (mapContainerRef.current) {
                        mapContainerRef.current.style.cursor = '';
                    }
                }
                
                return () => {
                    if (mapRef.current) {
                        mapRef.current.off('click', handleMapClick);
                    }
                };
            }, [routeMode, mapReady]);
            
            const [routeInfo, setRouteInfo] = useState(null);
            const [calculatingRoute, setCalculatingRoute] = useState(false);
            
            // Verificar se pode calcular rota
            const canCalculateRoute = () => {
                // Precisa de ponto de partida + pelo menos 1 ativo, OU pelo menos 2 ativos
                if (startPoint && routePoints.length >= 1) return true;
                if (routePoints.length >= 2) return true;
                return false;
            };
            
            const calculateRoute = async () => {
                if (!canCalculateRoute() || !mapRef.current) return;
                
                setCalculatingRoute(true);
                setRouteInfo(null);
                
                // Limpar rota anterior (mas manter marcador de partida)
                if (mapRef.current) {
                    mapRef.current.eachLayer(layer => {
                        if (layer.options && (layer.options.isRouteLine || layer.options.isRouteMarker)) {
                            mapRef.current.removeLayer(layer);
                        }
                    });
                }
                
                // Construir lista de pontos (startPoint primeiro se existir)
                const allPoints = startPoint ? [startPoint, ...routePoints] : routePoints;
                
                // Criar coordenadas para OSRM (longitude,latitude)
                const coords = allPoints.map(p => `${p.longitude},${p.latitude}`).join(';');
                
                try {
                    // Usar API OSRM p√∫blica para calcular rota real
                    const response = await fetch(
                        `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson&steps=true`
                    );
                    
                    if (!response.ok) throw new Error('Erro na API de rotas');
                    
                    const data = await response.json();
                    
                    if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
                        throw new Error('N√£o foi poss√≠vel calcular a rota');
                    }
                    
                    const route = data.routes[0];
                    const geometry = route.geometry;
                    
                    // Converter GeoJSON para coordenadas Leaflet
                    const latlngs = geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    // Desenhar linha da rota
                    const polyline = L.polyline(latlngs, {
                        color: '#3B82F6',
                        weight: 5,
                        opacity: 0.8,
                        isRouteLine: true
                    }).addTo(mapRef.current);
                    
                    // Adicionar marcadores numerados para cada ponto
                    allPoints.forEach((point, i) => {
                        const isFirst = i === 0;
                        const isLast = i === allPoints.length - 1;
                        const isCustomStart = point.isCustomStart;
                        const bgColor = isFirst ? '#22c55e' : isLast ? '#ef4444' : '#3B82F6';
                        const label = isCustomStart ? 'üöó' : (i + 1);
                        
                        L.marker([point.latitude, point.longitude], {
                            icon: L.divIcon({
                                html: `<div style="background:${bgColor};color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:${isCustomStart ? '16px' : '14px'};border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.4)">${label}</div>`,
                                className: '',
                                iconSize: [28, 28],
                                iconAnchor: [14, 14]
                            }),
                            isRouteMarker: true
                        }).addTo(mapRef.current).bindPopup(`
                            <strong>${isFirst ? 'üöó Partida' : isLast ? 'üèÅ Destino' : `Ponto ${i+1}`}</strong><br/>
                            ${point.serial_number}<br/>
                            ${point.municipality || ''}
                        `);
                    });
                    
                    routingRef.current = polyline;
                    
                    // Calcular informa√ß√µes da rota
                    const distanceKm = (route.distance / 1000).toFixed(1);
                    const durationMin = Math.round(route.duration / 60);
                    const durationHours = Math.floor(durationMin / 60);
                    const durationRemainingMin = durationMin % 60;
                    
                    setRouteInfo({
                        distance: distanceKm,
                        duration: durationHours > 0 
                            ? `${durationHours}h ${durationRemainingMin}min`
                            : `${durationMin} min`,
                        points: allPoints.length
                    });
                    
                    // Ajustar vista para mostrar toda a rota
                    mapRef.current.fitBounds(polyline.getBounds(), { padding: [50, 50] });
                    
                } catch (error) {
                    console.error('Erro ao calcular rota:', error);
                    
                    // Fallback: linha directa
                    const latlngs = allPoints.map(p => [p.latitude, p.longitude]);
                    const polyline = L.polyline(latlngs, {
                        color: '#3B82F6',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '10, 10',
                        isRouteLine: true
                    }).addTo(mapRef.current);
                    
                    allPoints.forEach((point, i) => {
                        const isCustomStart = point.isCustomStart;
                        L.marker([point.latitude, point.longitude], {
                            icon: L.divIcon({
                                html: `<div style="background:#3B82F6;color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3)">${isCustomStart ? 'üöó' : (i+1)}</div>`,
                                className: '',
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            }),
                            isRouteMarker: true
                        }).addTo(mapRef.current);
                    });
                    
                    routingRef.current = polyline;
                    
                    // Calcular dist√¢ncia em linha recta
                    let totalDist = 0;
                    for (let i = 1; i < allPoints.length; i++) {
                        const from = L.latLng(allPoints[i-1].latitude, allPoints[i-1].longitude);
                        const to = L.latLng(allPoints[i].latitude, allPoints[i].longitude);
                        totalDist += from.distanceTo(to);
                    }
                    
                    setRouteInfo({
                        distance: (totalDist / 1000).toFixed(1),
                        duration: 'N/D (linha recta)',
                        points: allPoints.length,
                        isApproximate: true
                    });
                    
                    mapRef.current.fitBounds(polyline.getBounds(), { padding: [50, 50] });
                }
                
                setCalculatingRoute(false);
            };
            
            return (
                <div className="p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Mapa de Ativos</h2>
                        <div className="flex gap-3">
                            <select 
                                value={selectedMunicipality}
                                onChange={(e) => setSelectedMunicipality(e.target.value)}
                                className="px-4 py-2 border rounded-lg"
                            >
                                <option value="">Todos os Munic√≠pios</option>
                                {filters.municipalities.map((m, i) => (
                                    <option key={i} value={m}>{m}</option>
                                ))}
                            </select>
                            <select 
                                value={selectedStatus}
                                onChange={(e) => setSelectedStatus(e.target.value)}
                                className="px-4 py-2 border rounded-lg"
                            >
                                <option value="">Todos os Estados</option>
                                {filters.statuses.map((s, i) => (
                                    <option key={i} value={s}>{s}</option>
                                ))}
                            </select>
                            <button 
                                onClick={centerOnPortugal}
                                className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                                title="Centrar em Portugal"
                            >
                                ü°µü°π
                            </button>
                            <button 
                                onClick={centerOnAssets}
                                className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200"
                                title="Ver todos os ativos"
                            >
                                Ver Todos
                            </button>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        {/* Mapa */}
                        <div className="lg:col-span-3 bg-white rounded-xl shadow-md overflow-hidden">
                            {loading ? (
                                <div style={{ height: '600px' }} className="flex items-center justify-center bg-gray-50">
                                    <div className="text-center">
                                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                        <div className="text-gray-500">A carregar mapa...</div>
                                    </div>
                                </div>
                            ) : (
                                <div 
                                    ref={mapContainerRef} 
                                    style={{ height: '600px', width: '100%', minHeight: '600px' }}
                                ></div>
                            )}
                        </div>
                        
                        {/* Painel lateral */}
                        <div className="space-y-4">
                            {/* Detalhes do ativo */}
                            <div className="bg-white rounded-xl shadow-md p-4">
                                <h3 className="font-bold text-gray-800 mb-4">
                                    {selectedAsset ? 'Detalhes do Ativo' : 'Selecione um ativo'}
                                </h3>
                                
                                {selectedAsset ? (
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-500">N¬∫ S√©rie</label>
                                            <p className="font-mono font-medium text-sm">{selectedAsset.serial_number}</p>
                                        </div>
                                        {selectedAsset.product_reference && (
                                            <div>
                                                <label className="text-xs text-gray-500">Refer√™ncia</label>
                                                <p className="text-sm font-medium">{selectedAsset.product_reference}</p>
                                            </div>
                                        )}
                                        {selectedAsset.rfid_tag && (
                                            <div>
                                                <label className="text-xs text-gray-500">RFID</label>
                                                <p className="font-mono text-xs">{selectedAsset.rfid_tag}</p>
                                            </div>
                                        )}
                                        <div>
                                            <label className="text-xs text-gray-500">Estado</label>
                                            <p><span className={`px-2 py-1 rounded-full text-xs ${getStatusBgClass(selectedAsset.status)}`}>{selectedAsset.status || 'N/D'}</span></p>
                                        </div>
                                        {selectedAsset.municipality && (
                                            <div>
                                                <label className="text-xs text-gray-500">Munic√≠pio</label>
                                                <p className="text-sm">{selectedAsset.municipality}</p>
                                            </div>
                                        )}
                                        {selectedAsset.location && (
                                            <div>
                                                <label className="text-xs text-gray-500">Local</label>
                                                <p className="text-sm">{selectedAsset.location}</p>
                                            </div>
                                        )}
                                        <div>
                                            <label className="text-xs text-gray-500">GPS</label>
                                            <p className="text-xs font-mono">{selectedAsset.latitude?.toFixed(5)}, {selectedAsset.longitude?.toFixed(5)}</p>
                                        </div>
                                        <div className="flex gap-2 pt-2">
                                            <button 
                                                onClick={() => setSelectedAsset(null)}
                                                className="flex-1 px-3 py-2 text-sm text-gray-600 border rounded-lg hover:bg-gray-50"
                                            >
                                                Limpar
                                            </button>
                                            {routeMode && (
                                                <button 
                                                    onClick={() => addRoutePoint(selectedAsset)}
                                                    disabled={routePoints.some(p => p.id === selectedAsset.id)}
                                                    className="flex-1 px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                                                >
                                                    + Rota
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center text-gray-400 py-6">
                                        <p className="text-sm">Clique num marcador no mapa</p>
                                    </div>
                                )}
                            </div>
                            
                            {/* Planeador de Rotas */}
                            <div className="bg-white rounded-xl shadow-md p-4">
                                <div className="flex justify-between items-center mb-3">
                                    <h4 className="font-bold text-gray-800">üî∫√Ø¬∏¬è Planeador de Rotas</h4>
                                    <button
                                        onClick={() => { setRouteMode(!routeMode); if (routeMode) { clearRoute(); setRouteInfo(null); } }}
                                        className={`px-3 py-1 rounded-lg text-sm ${routeMode ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
                                    >
                                        {routeMode ? '‚úî Ativo' : 'Iniciar'}
                                    </button>
                                </div>
                                
                                {routeMode && (
                                    <div className="space-y-3">
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-2 text-xs text-blue-700">
                                            <p className="font-semibold">Como usar:</p>
                                            <ol className="list-decimal list-inside mt-1 space-y-0.5">
                                                <li>Clique no mapa para definir partida</li>
                                                <li>Clique num ativo e "+ Rota"</li>
                                                <li>Calcule a rota</li>
                                            </ol>
                                        </div>
                                        
                                        {startPoint && (
                                            <div className="flex items-center justify-between bg-green-50 border border-green-200 px-2 py-1.5 rounded text-sm">
                                                <span className="flex items-center">
                                                    <span className="w-6 h-6 bg-green-600 text-white rounded-full text-sm flex items-center justify-center mr-2">1</span>
                                                    <div>
                                                        <span className="font-semibold text-green-800 text-xs">Partida</span>
                                                        <span className="text-green-600 text-xs block">{startPoint.latitude.toFixed(4)}, {startPoint.longitude.toFixed(4)}</span>
                                                    </div>
                                                </span>
                                                <button onClick={() => { setStartPoint(null); if(mapRef.current){mapRef.current.eachLayer(l=>{if(l.options&&l.options.isStartMarker)mapRef.current.removeLayer(l);})} }} className="text-red-500 hover:bg-red-50 rounded p-1 text-xs">X</button>
                                            </div>
                                        )}
                                        
                                        {routePoints.length > 0 ? (
                                            <div className="space-y-1 max-h-40 overflow-y-auto">
                                                {routePoints.map((point, i) => (
                                                    <div key={i} className="flex items-center justify-between bg-gray-50 px-2 py-1.5 rounded text-sm">
                                                        <span className="flex items-center">
                                                            <span className={`w-5 h-5 ${i === routePoints.length - 1 ? 'bg-red-600' : 'bg-blue-600'} text-white rounded-full text-xs flex items-center justify-center mr-2`}>
                                                                {startPoint ? i + 2 : i + 1}
                                                            </span>
                                                            <div>
                                                                <span className="font-mono text-xs">{point.serial_number}</span>
                                                                {point.municipality && <span className="text-gray-400 text-xs ml-1">({point.municipality})</span>}
                                                            </div>
                                                        </span>
                                                        <button onClick={() => removeRoutePoint(i)} className="text-red-500 hover:bg-red-50 rounded p-1">‚úï</button>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <p className="text-center text-gray-400 text-xs py-4 bg-gray-50 rounded">
                                                {startPoint ? 'Adicione 1 destino (ativo)' : 'Clique no mapa ou adicione ativos'}
                                            </p>
                                        )}
                                        
                                        {/* Informa√ß√µes da Rota */}
                                        {routeInfo && (
                                            <div className={`p-3 rounded-lg ${routeInfo.isApproximate ? 'bg-yellow-50 border border-yellow-200' : 'bg-green-50 border border-green-200'}`}>
                                                <div className="grid grid-cols-2 gap-2 text-sm">
                                                    <div>
                                                        <span className="text-gray-500 text-xs">Dist√¢ncia</span>
                                                        <p className="font-bold text-gray-800">{routeInfo.distance} km</p>
                                                    </div>
                                                    <div>
                                                        <span className="text-gray-500 text-xs">Tempo Est.</span>
                                                        <p className="font-bold text-gray-800">{routeInfo.duration}</p>
                                                    </div>
                                                </div>
                                                {routeInfo.isApproximate && (
                                                    <p className="text-xs text-yellow-600 mt-2">‚ö†Ô∏è¬è Rota aproximada (linha recta)</p>
                                                )}
                                            </div>
                                        )}
                                        
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={calculateRoute}
                                                disabled={!canCalculateRoute() || calculatingRoute}
                                                className="flex-1 px-3 py-2 bg-green-600 text-white rounded-lg text-sm disabled:opacity-50 hover:bg-green-700"
                                            >
                                                {calculatingRoute ? 'A calcular...' : 'üìç Calcular Rota'}
                                            </button>
                                            <button 
                                                onClick={() => { clearRoute(); setRouteInfo(null); }}
                                                className="px-3 py-2 bg-red-100 text-red-600 rounded-lg text-sm hover:bg-red-200"
                                            >
                                                üóëÔ∏è¬è
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* Resumo */}
                            <div className="bg-white rounded-xl shadow-md p-4">
                                <h4 className="font-bold text-gray-800 mb-3">Resumo</h4>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span>Total:</span>
                                        <span className="font-bold">{assets.length}</span>
                                    </div>
                                    <hr />
                                    {[
                                        { status: 'Operacional', color: '#10B981' },
                                        { status: 'Manuten√ß√£o Necess√°ria', color: '#F59E0B' },
                                        { status: 'Em Repara√ß√£o', color: '#F97316' },
                                        { status: 'Desativado', color: '#EF4444' }
                                    ].map(({ status, color }) => {
                                        const count = assets.filter(a => a.status === status).length;
                                        if (count === 0) return null;
                                        return (
                                            <div key={status} className="flex justify-between items-center">
                                                <span className="flex items-center">
                                                    <span className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: color }}></span>
                                                    {status}
                                                </span>
                                                <span>{count}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // TENANTS MANAGER - Gest√£o de Tenants (apenas superadmin)
        const TenantsManager = () => {
            const { token, user } = useAuth();
            const [tenants, setTenants] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showForm, setShowForm] = useState(false);
            const [newTenant, setNewTenant] = useState({ id: '', name: '', admin_email: '', admin_password: '' });
            const [message, setMessage] = useState(null);
            const [uploading, setUploading] = useState(null);
            
            // Estados para gest√£o de utilizadores
            const [selectedTenant, setSelectedTenant] = useState(null);
            const [tenantUsers, setTenantUsers] = useState([]);
            const [loadingUsers, setLoadingUsers] = useState(false);
            const [showUserForm, setShowUserForm] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [newUser, setNewUser] = useState({ email: '', password: '', role: 'user', first_name: '', last_name: '', phone: '' });
            
            useEffect(() => {
                if (user?.role === 'superadmin') {
                    loadTenants();
                }
            }, []);
            
            const loadTenants = async () => {
                setLoading(true);
                const data = await api.get('/tenants', token);
                if (Array.isArray(data)) setTenants(data);
                setLoading(false);
            };
            
            const handleCreate = async (e) => {
                e.preventDefault();
                if (!newTenant.id || !newTenant.name || !newTenant.admin_email || !newTenant.admin_password) {
                    setMessage({ type: 'error', text: 'Todos os campos s√£o obrigat√≥rios' });
                    return;
                }
                if (newTenant.admin_password.length < 8) {
                    setMessage({ type: 'error', text: 'Password deve ter pelo menos 8 caracteres' });
                    return;
                }
                const r = await api.post('/tenants', newTenant, token);
                if (r.ok) {
                    setMessage({ type: 'success', text: 'Tenant criado com sucesso!' });
                    setShowForm(false);
                    setNewTenant({ id: '', name: '', admin_email: '', admin_password: '' });
                    loadTenants();
                } else {
                    setMessage({ type: 'error', text: r.data?.error || 'Erro ao criar tenant' });
                }
            };
            
            const handleLogoUpload = async (tenantId, file) => {
                if (!file) return;
                setUploading(tenantId);
                const formData = new FormData();
                formData.append('logo', file);
                try {
                    const res = await fetch(`${API_BASE}/tenants/${tenantId}/logo`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    if (res.ok) {
                        setMessage({ type: 'success', text: 'Logo atualizado!' });
                        loadTenants();
                    } else {
                        const data = await res.json();
                        setMessage({ type: 'error', text: data.error || 'Erro ao carregar logo' });
                    }
                } catch (e) {
                    setMessage({ type: 'error', text: 'Erro de conex√£o' });
                }
                setUploading(null);
            };
            
            // Fun√ß√µes de gest√£o de utilizadores
            const openUsersModal = async (tenant) => {
                setSelectedTenant(tenant);
                setLoadingUsers(true);
                try {
                    const data = await api.get(`/tenants/${tenant.id}/users`, token);
                    setTenantUsers(data.users || []);
                } catch (e) {
                    setMessage({ type: 'error', text: 'Erro ao carregar utilizadores' });
                }
                setLoadingUsers(false);
            };
            
            const closeUsersModal = () => {
                setSelectedTenant(null);
                setTenantUsers([]);
                setShowUserForm(false);
                setEditingUser(null);
                setNewUser({ email: '', password: '', role: 'user', first_name: '', last_name: '', phone: '' });
            };
            
            const handleCreateUser = async (e) => {
                e.preventDefault();
                if (!newUser.email || !newUser.password || !newUser.first_name) {
                    setMessage({ type: 'error', text: 'Email, password e nome s√£o obrigat√≥rios' });
                    return;
                }
                const r = await api.post(`/tenants/${selectedTenant.id}/users`, newUser, token);
                if (r.ok) {
                    setMessage({ type: 'success', text: 'Utilizador criado!' });
                    setShowUserForm(false);
                    setNewUser({ email: '', password: '', role: 'user', first_name: '', last_name: '', phone: '' });
                    openUsersModal(selectedTenant);
                    loadTenants();
                } else {
                    setMessage({ type: 'error', text: r.data?.error || 'Erro ao criar utilizador' });
                }
            };
            
            const handleUpdateUser = async (e) => {
                e.preventDefault();
                const r = await api.put(`/tenants/${selectedTenant.id}/users/${editingUser.id}`, editingUser, token);
                if (r.ok) {
                    setMessage({ type: 'success', text: 'Utilizador atualizado!' });
                    setEditingUser(null);
                    openUsersModal(selectedTenant);
                } else {
                    setMessage({ type: 'error', text: r.data?.error || 'Erro ao atualizar' });
                }
            };
            
            const handleDeleteUser = async (userId) => {
                if (!confirm('Eliminar este utilizador?')) return;
                const r = await api.delete(`/tenants/${selectedTenant.id}/users/${userId}`, token);
                if (r.ok) {
                    setMessage({ type: 'success', text: 'Utilizador eliminado!' });
                    openUsersModal(selectedTenant);
                    loadTenants();
                } else {
                    setMessage({ type: 'error', text: r.data?.error || 'Erro ao eliminar' });
                }
            };
            
            const getRoleBadge = (role) => {
                switch(role) {
                    case 'superadmin': return 'bg-red-100 text-red-800';
                    case 'admin': return 'bg-purple-100 text-purple-800';
                    case 'user': return 'bg-blue-100 text-blue-800';
                    case 'operator': return 'bg-green-100 text-green-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            const getRoleLabel = (role) => {
                const labels = { superadmin: 'Super Admin', admin: 'Administrador', user: 'Utilizador', operator: 'Operador', visitor: 'Visita' };
                return labels[role] || role;
            };
            
            if (user?.role !== 'superadmin') {
                return (
                    <div className="p-6 text-center">
                        <p className="text-red-600">Acesso restrito a Super Administradores</p>
                    </div>
                );
            }
            
            return (
                <div className="p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">üè¢ Gest√£o de Tenants</h2>
                        <button onClick={() => setShowForm(!showForm)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            {showForm ? 'Cancelar' : '+ Novo Tenant'}
                        </button>
                    </div>
                    
                    {message && (
                        <div className={`mb-4 p-3 rounded-lg ${message.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                            {message.text}
                            <button onClick={() => setMessage(null)} className="float-right">√ó</button>
                        </div>
                    )}
                    
                    {showForm && (
                        <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                            <h3 className="text-lg font-semibold mb-4">Criar Novo Tenant</h3>
                            <form onSubmit={handleCreate} className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">ID do Tenant *</label>
                                    <input type="text" value={newTenant.id} onChange={(e) => setNewTenant({...newTenant, id: e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, '')})} 
                                        className="w-full px-3 py-2 border rounded-lg" placeholder="empresa-xyz" />
                                    <p className="text-xs text-gray-500 mt-1">Apenas letras min√∫sculas, n√∫meros e h√≠fen</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Nome da Empresa *</label>
                                    <input type="text" value={newTenant.name} onChange={(e) => setNewTenant({...newTenant, name: e.target.value})} 
                                        className="w-full px-3 py-2 border rounded-lg" placeholder="Empresa XYZ, Lda" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Email do Administrador *</label>
                                    <input type="email" value={newTenant.admin_email} onChange={(e) => setNewTenant({...newTenant, admin_email: e.target.value})} 
                                        className="w-full px-3 py-2 border rounded-lg" placeholder="admin@empresa.com" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Password Inicial *</label>
                                    <input type="password" value={newTenant.admin_password} onChange={(e) => setNewTenant({...newTenant, admin_password: e.target.value})} 
                                        className="w-full px-3 py-2 border rounded-lg" placeholder="M√≠nimo 8 caracteres" />
                                </div>
                                <div className="col-span-2">
                                    <button type="submit" className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                        Criar Tenant
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}
                    
                    {loading ? (
                        <div className="text-center py-8">A carregar...</div>
                    ) : (
                        <div className="grid gap-4">
                            {tenants.map(tenant => (
                                <div key={tenant.id} className="bg-white p-4 rounded-lg shadow-md flex items-center justify-between">
                                    <div className="flex items-center space-x-4">
                                        <div className="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center">
                                            <img src={`${API_BASE}/tenants/${tenant.id}/logo?t=${Date.now()}`} alt="Logo" 
                                                className="max-w-full max-h-full object-contain"
                                                onError={(e) => { e.target.style.display = 'none'; e.target.parentElement.innerHTML = 'üè¢'; }} />
                                        </div>
                                        <div>
                                            <h3 className="font-semibold text-lg">{tenant.name}</h3>
                                            <p className="text-sm text-gray-500">ID: {tenant.id}</p>
                                            <p className="text-xs text-gray-400">
                                                {tenant.user_count || 0} utilizadores ‚Ä¢ {tenant.asset_count || 0} ativos
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <button onClick={() => openUsersModal(tenant)} 
                                            className="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm font-medium">
                                            üë• Utilizadores
                                        </button>
                                        <label className="cursor-pointer px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                                            {uploading === tenant.id ? 'A carregar...' : 'üì∑ Logo'}
                                            <input type="file" accept="image/*" className="hidden" 
                                                onChange={(e) => handleLogoUpload(tenant.id, e.target.files[0])} 
                                                disabled={uploading === tenant.id} />
                                        </label>
                                        {tenant.id === 'smartlamppost' && (
                                            <React.Fragment>
                                                <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">Master</span>
                                                <span className="px-2 py-1 bg-gray-50 text-gray-500 rounded text-xs" title="Este logo aparece no badge 'powered by' dos outros tenants">Logo Marca</span>
                                            </React.Fragment>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {/* Modal de Gest√£o de Utilizadores */}
                    {selectedTenant && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                                <div className="p-6 border-b flex justify-between items-center bg-gray-50">
                                    <div>
                                        <h3 className="text-xl font-bold">üë• Utilizadores - {selectedTenant.name}</h3>
                                        <p className="text-sm text-gray-500">Tenant: {selectedTenant.id}</p>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => { setShowUserForm(true); setEditingUser(null); }} 
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                            + Novo Utilizador
                                        </button>
                                        <button onClick={closeUsersModal} className="text-gray-400 hover:text-gray-600 text-2xl px-2">√ó</button>
                                    </div>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-6">
                                    {loadingUsers ? (
                                        <div className="text-center py-8">A carregar utilizadores...</div>
                                    ) : tenantUsers.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">Nenhum utilizador encontrado</div>
                                    ) : (
                                        <table className="w-full">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                                    <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {tenantUsers.map(u => (
                                                    <tr key={u.id} className="hover:bg-gray-50">
                                                        <td className="px-4 py-3 font-medium">{u.email}</td>
                                                        <td className="px-4 py-3">{u.first_name} {u.last_name}</td>
                                                        <td className="px-4 py-3">
                                                            <span className={`px-2 py-1 rounded text-xs ${getRoleBadge(u.role)}`}>
                                                                {getRoleLabel(u.role)}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <span className={`px-2 py-1 rounded text-xs ${u.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                                {u.active ? 'Ativo' : 'Inativo'}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-right">
                                                            <button onClick={() => { setEditingUser({...u, password: ''}); setShowUserForm(false); }} 
                                                                className="text-blue-600 hover:text-blue-800 mr-3">Editar</button>
                                                            <button onClick={() => handleDeleteUser(u.id)} 
                                                                className="text-red-600 hover:text-red-800">Eliminar</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Criar/Editar Utilizador */}
                    {(showUserForm || editingUser) && selectedTenant && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
                                <div className="p-4 border-b flex justify-between items-center">
                                    <h4 className="text-lg font-semibold">{editingUser ? 'Editar' : 'Novo'} Utilizador</h4>
                                    <button onClick={() => { setShowUserForm(false); setEditingUser(null); }} className="text-gray-400 hover:text-gray-600">√ó</button>
                                </div>
                                <form onSubmit={editingUser ? handleUpdateUser : handleCreateUser} className="p-4 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Nome *</label>
                                            <input type="text" 
                                                value={editingUser ? editingUser.first_name : newUser.first_name} 
                                                onChange={(e) => editingUser ? setEditingUser({...editingUser, first_name: e.target.value}) : setNewUser({...newUser, first_name: e.target.value})} 
                                                className="w-full px-3 py-2 border rounded-lg" required />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Apelido</label>
                                            <input type="text" 
                                                value={editingUser ? editingUser.last_name : newUser.last_name} 
                                                onChange={(e) => editingUser ? setEditingUser({...editingUser, last_name: e.target.value}) : setNewUser({...newUser, last_name: e.target.value})} 
                                                className="w-full px-3 py-2 border rounded-lg" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Email *</label>
                                        <input type="email" 
                                            value={editingUser ? editingUser.email : newUser.email} 
                                            onChange={(e) => editingUser ? setEditingUser({...editingUser, email: e.target.value}) : setNewUser({...newUser, email: e.target.value})} 
                                            className="w-full px-3 py-2 border rounded-lg" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Password {editingUser ? '(deixar vazio para manter)' : '*'}</label>
                                        <input type="password" 
                                            value={editingUser ? editingUser.password : newUser.password} 
                                            onChange={(e) => editingUser ? setEditingUser({...editingUser, password: e.target.value}) : setNewUser({...newUser, password: e.target.value})} 
                                            className="w-full px-3 py-2 border rounded-lg" required={!editingUser} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Telefone</label>
                                        <input type="tel" 
                                            value={editingUser ? editingUser.phone || '' : newUser.phone} 
                                            onChange={(e) => editingUser ? setEditingUser({...editingUser, phone: e.target.value}) : setNewUser({...newUser, phone: e.target.value})} 
                                            className="w-full px-3 py-2 border rounded-lg" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Tipo</label>
                                            <select 
                                                value={editingUser ? editingUser.role : newUser.role} 
                                                onChange={(e) => editingUser ? setEditingUser({...editingUser, role: e.target.value}) : setNewUser({...newUser, role: e.target.value})} 
                                                className="w-full px-3 py-2 border rounded-lg">
                                                <option value="user">Utilizador</option>
                                                <option value="operator">Operador</option>
                                                <option value="admin">Administrador</option>
                                                {selectedTenant?.id === 'smartlamppost' && <option value="superadmin">Super Admin</option>}
                                                <option value="visitor">Visita</option>
                                            </select>
                                        </div>
                                        {editingUser && (
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Estado</label>
                                                <select 
                                                    value={editingUser.active ? '1' : '0'} 
                                                    onChange={(e) => setEditingUser({...editingUser, active: e.target.value === '1' ? 1 : 0})} 
                                                    className="w-full px-3 py-2 border rounded-lg">
                                                    <option value="1">Ativo</option>
                                                    <option value="0">Inativo</option>
                                                </select>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex justify-end gap-2 pt-4">
                                        <button type="button" onClick={() => { setShowUserForm(false); setEditingUser(null); }} 
                                            className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancelar</button>
                                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                            {editingUser ? 'Guardar' : 'Criar'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // SETTINGS MANAGER - Configura√ß√µes de Prefixos, Cores e Contadores
        const SettingsManager = () => {
            const { token, user } = useAuth();
            const [activeTab, setActiveTab] = useState('prefixes');
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [message, setMessage] = useState(null);
            const [prefixes, setPrefixes] = useState({
                prefix_assets: 'SLP', prefix_assets_digits: '9',
                prefix_int_preventiva: 'INTP', prefix_int_corretiva: 'INTC',
                prefix_int_substituicao: 'INTS', prefix_int_inspecao: 'INSP', prefix_int_digits: '9'
            });
            const [colors, setColors] = useState([]);
            const [newColor, setNewColor] = useState('');
            const [counters, setCounters] = useState([]);
            
            useEffect(() => { loadData(); }, [token]);
            
            const loadData = async () => {
                try {
                    setLoading(true);
                    const prefixData = await api.get('/config/prefixes', token);
                    if (prefixData.prefixes) setPrefixes(prev => ({ ...prev, ...prefixData.prefixes }));
                    const colorData = await api.get('/config/colors', token);
                    setColors(colorData.colors || []);
                    const counterData = await api.get('/config/counters', token);
                    setCounters(counterData.counters || []);
                } catch (err) {
                    setMessage({ type: 'error', text: 'Erro ao carregar configura√ß√µes' });
                } finally { setLoading(false); }
            };
            
            const savePrefixes = async () => {
                try {
                    setSaving(true);
                    const result = await api.put('/config/prefixes', prefixes, token);
                    setMessage(result.ok ? { type: 'success', text: 'Prefixos guardados!' } : { type: 'error', text: result.data.error });
                } catch (err) { setMessage({ type: 'error', text: 'Erro ao guardar prefixos' }); }
                finally { setSaving(false); }
            };
            
            const saveColors = async () => {
                try {
                    setSaving(true);
                    const result = await api.put('/config/colors', { colors }, token);
                    setMessage(result.ok ? { type: 'success', text: 'Cores guardadas!' } : { type: 'error', text: result.data.error });
                } catch (err) { setMessage({ type: 'error', text: 'Erro ao guardar cores' }); }
                finally { setSaving(false); }
            };
            
            const addColor = () => { if (newColor.trim() && !colors.includes(newColor.trim())) { setColors([...colors, newColor.trim()]); setNewColor(''); }};
            const removeColor = (c) => setColors(colors.filter(x => x !== c));
            const getPreviewNumber = (tipo) => {
                const prefix = prefixes[`prefix_${tipo}`] || prefixes[`prefix_int_${tipo}`] || 'XXX';
                const digits = parseInt(prefixes[tipo === 'assets' ? 'prefix_assets_digits' : 'prefix_int_digits']) || 9;
                return `${prefix}${'0'.repeat(digits - 1)}1`;
            };
            
            if (loading) return <div className="p-8 text-center">A carregar configura√ß√µes...</div>;
            
            return (
                <div className="p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <div><h2 className="text-2xl font-bold text-gray-800">‚ö°√Ø¬∏¬è Configura√ß√µes</h2><p className="text-gray-500">Gest√£o de prefixos, cores e numera√ß√£o autom√°tica</p></div>
                    </div>
                    {message && (<div className={`mb-4 p-4 rounded-lg ${message.type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>{message.text}<button onClick={() => setMessage(null)} className="float-right">&times;</button></div>)}
                    <div className="flex space-x-1 mb-6 border-b">
                        {[{id:'prefixes',label:'üî¢ Prefixos'},{id:'colors',label:'üé® Cores'},{id:'counters',label:'üìä Contadores'}].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-4 py-2 text-sm font-medium rounded-t-lg ${activeTab === tab.id ? 'bg-blue-100 text-blue-700 border-b-2 border-blue-500' : 'text-gray-600 hover:bg-gray-100'}`}>{tab.label}</button>
                        ))}
                    </div>
                    
                    {activeTab === 'prefixes' && (
                        <div className="bg-white rounded-xl shadow-md p-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Configura√ß√£o de Prefixos</h3>
                            <p className="text-gray-500 text-sm mb-6">Configure os prefixos utilizados na gera√ß√£o autom√°tica de n√∫meros de s√©rie e c√≥digos de interven√ß√£o.</p>
                            <div className="mb-8 p-4 bg-gray-50 rounded-lg">
                                <h4 className="font-medium text-gray-700 mb-3">üì¶ Ativos</h4>
                                <div className="grid grid-cols-3 gap-4">
                                    <div><label className="block text-sm font-medium text-gray-600 mb-1">Prefixo</label><input type="text" value={prefixes.prefix_assets} onChange={e => setPrefixes({...prefixes, prefix_assets: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg font-mono" maxLength={10}/></div>
                                    <div><label className="block text-sm font-medium text-gray-600 mb-1">N¬∫ de D√≠gitos</label><input type="number" value={prefixes.prefix_assets_digits} onChange={e => setPrefixes({...prefixes, prefix_assets_digits: e.target.value})} className="w-full px-3 py-2 border rounded-lg" min={1} max={15}/></div>
                                    <div><label className="block text-sm font-medium text-gray-600 mb-1">Preview</label><div className="px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg font-mono text-blue-700">{getPreviewNumber('assets')}</div></div>
                                </div>
                            </div>
                            <div className="mb-8 p-4 bg-gray-50 rounded-lg">
                                <h4 className="font-medium text-gray-700 mb-3">üîß Interven√ß√µes</h4>
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div><label className="block text-sm font-medium text-gray-600 mb-1">Preventiva</label><input type="text" value={prefixes.prefix_int_preventiva} onChange={e => setPrefixes({...prefixes, prefix_int_preventiva: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg font-mono" maxLength={10}/></div>
                                    <div><label className="block text-sm font-medium text-gray-600 mb-1">Corretiva</label><input type="text" value={prefixes.prefix_int_corretiva} onChange={e => setPrefixes({...prefixes, prefix_int_corretiva: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg font-mono" maxLength={10}/></div>
                                    <div><label className="block text-sm font-medium text-gray-600 mb-1">Substitui√ß√£o</label><input type="text" value={prefixes.prefix_int_substituicao} onChange={e => setPrefixes({...prefixes, prefix_int_substituicao: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg font-mono" maxLength={10}/></div>
                                    <div><label className="block text-sm font-medium text-gray-600 mb-1">Inspe√ß√£o</label><input type="text" value={prefixes.prefix_int_inspecao} onChange={e => setPrefixes({...prefixes, prefix_int_inspecao: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg font-mono" maxLength={10}/></div>
                                </div>
                                <div className="grid grid-cols-3 gap-4">
                                    <div><label className="block text-sm font-medium text-gray-600 mb-1">N¬∫ de D√≠gitos</label><input type="number" value={prefixes.prefix_int_digits} onChange={e => setPrefixes({...prefixes, prefix_int_digits: e.target.value})} className="w-full px-3 py-2 border rounded-lg" min={1} max={15}/></div>
                                    <div className="col-span-2"><label className="block text-sm font-medium text-gray-600 mb-1">Preview (Atualiza√ß√£o)</label><div className="px-3 py-2 bg-orange-50 border border-orange-200 rounded-lg font-mono text-orange-700 text-sm">{prefixes.prefix_int_preventiva}{'0'.repeat(parseInt(prefixes.prefix_int_digits)-1)}1-A01</div></div>
                                </div>
                            </div>
                            <div className="flex justify-end"><button onClick={savePrefixes} disabled={saving} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">{saving ? 'A guardar...' : 'Guardar Prefixos'}</button></div>
                        </div>
                    )}
                    
                    {activeTab === 'colors' && (
                        <div className="bg-white rounded-xl shadow-md p-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Gest√£o de Cores</h3>
                            <p className="text-gray-500 text-sm mb-6">Configure as cores dispon√≠veis para sele√ß√£o nos ativos.</p>
                            <div className="flex gap-2 mb-6">
                                <input type="text" value={newColor} onChange={e => setNewColor(e.target.value)} onKeyPress={e => e.key === 'Enter' && addColor()} placeholder="Nome da cor (ex: RAL 7016)" className="flex-1 px-3 py-2 border rounded-lg"/>
                                <button onClick={addColor} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">+ Adicionar</button>
                            </div>
                            <div className="grid grid-cols-3 gap-2 mb-6">
                                {colors.map((color, i) => (<div key={i} className="flex items-center justify-between px-3 py-2 bg-gray-50 rounded-lg border"><span className="text-sm">{color}</span><button onClick={() => removeColor(color)} className="text-red-500 hover:text-red-700 text-lg">&times;</button></div>))}
                            </div>
                            {colors.length === 0 && <p className="text-gray-400 text-center py-4">Nenhuma cor configurada</p>}
                            <div className="flex justify-end"><button onClick={saveColors} disabled={saving} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">{saving ? 'A guardar...' : 'Guardar Cores'}</button></div>
                        </div>
                    )}
                    
                    {activeTab === 'counters' && (
                        <div className="bg-white rounded-xl shadow-md p-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Estado dos Contadores</h3>
                            <p className="text-gray-500 text-sm mb-6">Visualize o estado atual dos contadores de numera√ß√£o autom√°tica.</p>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left text-sm font-medium text-gray-600">Tipo</th><th className="px-4 py-3 text-left text-sm font-medium text-gray-600">Valor Atual</th><th className="px-4 py-3 text-left text-sm font-medium text-gray-600">√ç≈°ltima Atualiza√ß√£o</th><th className="px-4 py-3 text-left text-sm font-medium text-gray-600">Pr√≥ximo N√∫mero</th></tr></thead>
                                    <tbody className="divide-y">
                                        {counters.map((c, i) => {
                                            const tipoLabel = {assets:'Ativos',int_preventiva:'Int. Preventiva',int_corretiva:'Int. Corretiva',int_substituicao:'Int. Substitui√ß√£o',int_inspecao:'Inspe√ß√£o'}[c.counter_type] || c.counter_type;
                                            const prefix = c.counter_type === 'assets' ? prefixes.prefix_assets : prefixes[`prefix_${c.counter_type}`] || '';
                                            const digits = parseInt(c.counter_type === 'assets' ? prefixes.prefix_assets_digits : prefixes.prefix_int_digits) || 9;
                                            const nextNum = `${prefix}${String(c.current_value + 1).padStart(digits, '0')}`;
                                            return (<tr key={i} className="hover:bg-gray-50"><td className="px-4 py-3 text-sm">{tipoLabel}</td><td className="px-4 py-3 text-sm font-mono">{c.current_value}</td><td className="px-4 py-3 text-sm text-gray-500">{c.updated_at ? new Date(c.updated_at).toLocaleString('pt-PT') : '-'}</td><td className="px-4 py-3 text-sm font-mono text-blue-600">{nextNum}</td></tr>);
                                        })}
                                    </tbody>
                                </table>
                            </div>
                            <p className="text-xs text-gray-400 mt-4">‚ö†Ô∏è¬è Os contadores s√£o incrementados automaticamente. Altera√ß√£o manual apenas em casos excepcionais.</p>
                        </div>
                    )}
                </div>
            );
        };
        
        // APP
        const App = () => {
            const { user, loading, mustChangePassword } = useAuth();
            const [currentView, setCurrentView] = useState('dashboard');
            const [assetFilter, setAssetFilter] = useState('');
            const [interventionAsset, setInterventionAsset] = useState(null);
            
            // Fun√ß√£o para navegar para nova interven√ß√£o com ativo pr√©-selecionado
            const navigateToNewIntervention = (asset) => {
                // Visitantes n√£o podem criar interven√ß√µes
                if (user?.role === 'visitor') return;
                setInterventionAsset(asset);
                setCurrentView('interventions');
            };
            
            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="text-gray-500">A carregar...</div></div>;
            if (!user) return <Login />;
            if (mustChangePassword) return <ChangePasswordRequired />;
            
            return (
                <div className="min-h-screen bg-gray-50">
                    <Navigation currentView={currentView} setCurrentView={setCurrentView} />
                    <main className="max-w-7xl mx-auto">
                        {currentView === 'dashboard' && <Dashboard setCurrentView={setCurrentView} />}
                        {currentView === 'dashboard-resumo' && <DashboardResumo setCurrentView={setCurrentView} setAssetFilter={setAssetFilter} />}
                        {currentView === 'map' && <MapView />}
                        {currentView === 'assets' && <AssetsList initialSearch={assetFilter} onNewIntervention={user?.role !== 'visitor' ? navigateToNewIntervention : null} />}
                        {currentView === 'interventions' && <InterventionsList preSelectedAsset={interventionAsset} clearPreSelected={() => setInterventionAsset(null)} />}
                        {currentView === 'catalog' && <CatalogManager />}
                        {currentView === 'schema' && <SchemaManager />}
                        {currentView === 'users' && <UsersManager />}
                        {currentView === 'tenants' && <TenantsManager />}
                        {currentView === 'settings' && <SettingsManager />}
                    </main>
                </div>
            );
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<AuthProvider><App /></AuthProvider>);
    </script>
</body>
</html>
